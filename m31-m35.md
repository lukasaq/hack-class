### CDAH-M31L1-Identify and Contain Malicious Activity  ###

Containment, Eradication, and Recovery Phase Overview
Below, Figure 31.1-1 displays the four phases of the continuous Incident Response (IR) lifecycle. When CPTs are not actively responding to an incident, they are in the Preparation phase of IR. In this phase, CPTs maintain readiness through deliberate mission planning, preparation, execution, and assessment. A CPT's work in IR is intended to supplement a local organization's network defenders. When CPTs arrive on site, they enter the Detection and Analysis phase by conducting their own Mission Analysis (MA). A CPT begins the Containment, Eradication, and Recovery phases of IR only after the operation has been approved, in accordance with the processes and tasks determined during the earlier phases of IR.
<img width="3330" height="1669" alt="image" src="https://github.com/user-attachments/assets/6de040da-b23a-432e-b331-21ff7ab72020" />

The containment process in IR is driven by the following two primary goals:
Prevent the incident from causing additional damage to organizational assets.
Preserve malware and forensic artifacts.
During this third phase of IR, analysts begin working actively with affected systems and hosts. Analysts start this phase with a focus on threat hunting and containment to minimize damage to organizational assets. Thereafter, the focus shifts to eradication, recovery, or mitigating strategy processes. Primary and critical containment tasks may include disabling network connectivity, enabling firewalls, creating forensic images, and powering down the host. 


Preserving malware and forensic artifacts during the Containment phase can assist analysts in future operations and phases of IR. Forensic evidence that has been properly obtained with a well-documented chain of custody can be used in legal proceedings. Preserved malware and forensic artifacts can also provide critical information to guide decision-making and strategic planning as the IR lifecycle progresses


-------------


Analyze Hosts for Malicious Activity
Read the scenario below, then complete the lab in the Virtual Machines (VMs) it-maint-0, ls-wkstn-3. Use the VMs to answer the upcoming series of questions and analyze different hosts for more information.

﻿

Scenario 
﻿

Security analysts identified a host within the organization that has been infected with malware. The malware is known to quickly spread among hosts on the network, especially hosts that have recently established connections with other hosts. The CPT is investigating two hosts that they suspect may be infected by the malware. The host ls-wkstn-3 may have been exposed to malware through communications with the host ls-wkstn-2. Additionally, ls-wkstn-3 recently communicated with host it-maint-0, which is responsible for remoting into hosts in the environment to provide Information Technology (IT) support. As a result, it-maint-0 connects with a large number of hosts and is easily susceptible to malware infections. The malware varies in name, but is known to maintain persistence by using folders that may be hidden and the registry. 

﻿

Table 31.1-1 and Table 31.1-2, below, present the specific IOCs associated with the malware for both Windows and Linux systems. Use this information to access and analyze both it-maint-0 and ls-wkstn-3. Determine whether the malware has spread to either host. Use static analysis for any malware detected on a host since any additional execution of the malware may spread and worsen the infection.


<img width="2500" height="886" alt="image" src="https://github.com/user-attachments/assets/e0ad715b-3f4d-4673-ab82-fc04c13fbc65" />


<img width="2500" height="1036" alt="image" src="https://github.com/user-attachments/assets/f96274c3-b806-49af-86cd-d71b04524051" />

Workflow


1. Log in to the VMs it-maint-0 and ls-wkstn-3 using the following credentials:
Username: trainee
Password: CyberTraining1! 



2. Using Table 31.1-1, analyze both VMs to identify whether either has been infected by the malware. 


3. Answer the next set of questions to start the initial examination.


---------------



Malicious Activity Overview
The analysis of both it-maint-0 and ls-wkstn-3 determined that ls-wkstn-3 is likely infected with the malware found in the environment. Further analysis must be completed to determine whether other artifacts are present. 

﻿

Identify Additional Artifacts from Malicious Activity
﻿

Continue using static analysis to work in ls-wkstn-3. Discover whether additional artifacts from the previously identified malicious activity exist. 

﻿

Workflow
﻿

1. Within ls-wkstn-3, review the registry for any persistence mechanisms placed by the malware. 

﻿

2. Answer the next set of questions to continue the examination.



------------------

Host Containment
IR containment is the process of keeping harmful items or actions under control to prevent further damage from occurring. These harmful artifacts include processes, applications, and software. Analysts must prioritize containment efforts and employ containment measures quickly. Fast and efficient containment saves network resources and provides critical time for analysts to develop a long-term remediation plan. For containment to be efficient, it should employ the least amount of work possible, while maximizing the prevention of damage. 

﻿

Containment strategies vary based on the specific details of an incident. For example, if a host is infected with Command and Control (C2) malware and is actively connecting to external Internet Protocol (IP) addresses, the strategy may be to take the infected host offline. Containment plans may require teams to complete the following tasks:

Remove network connectivity on the host or router.
Lock user accounts.
Stop specific services or ports.
Shut down the infected host.
If a containment plan requires shutting down a host, analysts must attempt to collect a memory dump prior to shutdown. Collecting a memory dump saves the host's volatile memory, which would otherwise be lost in a shut down.



-----------------


Containment Strategy
In the lab scenario, there are many unknowns surrounding the malware infection on host ls-wkstn-3. The following are just some of the basic details the analysts have yet to learn about the malware:

The method by which it was placed on the host
Its ease of spreading to other hosts in the environment
Its scope of impact 
Its behavior on impact and thereafter
Its goal
Its target
Due to the unknown components, the containment strategy must prioritize preventing any further spread of the malware and aim to preserve any artifacts associated with it. The strategy is to remove all network connections between ls-wkstn-3 and the environment and keep the host powered on to allow the CPT to continue any preservation tasks such as hashing files, collecting a memory dump, or saving artifacts. 

﻿

Implement Containment
﻿

Continue working on infected host ls-wkstn-3. Access the hosts Command Line Interface (CLI) to view and remove network connectivity, as described in the above containment strategy. Upon removal, verify the network connections are disabled. 

﻿

Workflow
﻿

1. Log in to the VM ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1! 
﻿

2. Right-click the Windows Start icon on the toolbar and select Command Prompt (Admin).

﻿

3. Select Yes in the dialog box with the prompt Do you want to allow this app to make changes to your device? 


----------------

Implement Containment
﻿

The command netsh interface show interface returns all network interfaces for the host. Its current output displays that the host contains the interfaces Ethernet1 and Ethernet0. Both interfaces are connected and enabled.

﻿

Remove Network Connectivity for Containment
﻿

Continue working on infected host ls-wkstn-3. Remove network connectivity, as described in the containment strategy.

﻿

Workflow
﻿

1. In the Command Prompt (Admin), disable the interface ﻿Ethernet0.


-----------

Remove Network Connectivity
The command netsh interface set interface Ethernet0 disable disables the interface Ethernet0.

﻿

Verify Changes for Containment
﻿

Continue working on infected host ls-wkstn-3. Verify that network connectivity has been completely disabled.

﻿

Workflow
﻿

1. Verify the network interfaces have been disabled by executing the following command:

netsh interface show interface 


-----------

### CDAH-M31L2-Preserve Evidence During IR ###

Evidence Authenticity and Integrity
Chain of Custody
﻿

The most critical process of evidence documentation is the Chain of Custody document (or Chain of Custody form). The Chain of Custody document contains chronological logging and documentation of all electronic evidence on a device or host. The document is used to assure organizational leadership, law enforcement, and the court system that evidence is authentic (that is, that the same evidence collected is presented). The Chain of Custody document seeks to identify the who, what, where, when, and how of evidence collection, storage, and control access. 	

﻿

A robust Chain of Custody document should include such information as the following:

Information identifying the analyst responsible for the evidence collection.
An overview and description of the evidence, which may include the following:
What evidence was collected. 
Where the collection occurred; this may be a virtual path or a physical location.
When (the date and time in local and Greenwich Mean Time [GMT]) the evidence was collected.
Who has custody of the evidence and when they took custody.
Where any physical evidence is located; for example, “A Compact Disk (CD) containing forensic artifacts is secured in safe number 101A, in room 404 (evidence storage room), of the headquarters building.” 
﻿Figure 31.2-1 provides an excerpt of a Chain of Custody document example from the National Institute of Standards and Technology (NIST)

<img width="867" height="576" alt="image" src="https://github.com/user-attachments/assets/07821d26-745c-4c71-b824-3472c262c1d5" />


-------------


Protecting Digital Evidence Integrity
Similar to creating a Chain of Custody document, organizations may create standardized policies and procedures for documenting the evidence collection. The policies and procedures are specific to the organizational needs and may vary, based on department. Such documentation aims to process and protect the integrity of the evidence and the organization. 

﻿

Organizational policies may include the following information: 


Department and analyst information, identifying the department and analyst conducting collection operations. This may include name, organizational contact information, and phone number. 
When the evidence was collected, with date and time in both local time and GMT.
Where the evidence was collected; this may be a virtual path or a physical location.
The platform, tools, and steps used to collect the evidence. 
A list of identifying features, such as the evidence, hashes, metadata, and timestamps (including such data as date created and date edited), and screenshots of relevant information (timestamps, hashes, metadata, etc.).
Description of how the evidence is stored (for example, a secure Portable Document Format [PDF] file, a password-protected Microsoft Word document, or an encrypted archive file used to save the relevant data). The hashes/checksums and identifying information of the secure documents can also be added to the Chain of Custody document as an additional method of ensuring evidence integrity to ensure authorities’ authenticity.


-------------

Forensic Tools for Digital Evidence Integrity Validation
Forensic tools are used by analysts to authenticate and prove the integrity of the evidence collected during the investigation. Through the use of imaging, forensic tools allow analysts to create a copy of the environment at a specific point in time. The created image is placed into a sandbox environment that provides validation for, and allows analysts to research further, the information contained in the Chain of Custody document. Examples of tools that analysts leverage to aid in an investigation are FTK® Imager, OpenText™ EnCase™ Forensic, Volatility, and ExifTool

---------


Evaluate Data Integrity
Read the scenario below, and complete the steps in the workflow to verify data collected in a Chain of Custody document.

﻿

Scenario 
﻿

A host has been infected with malware, and a Cyber Protection Team (CPT) has been tasked with, and has completed, Incident Response (IR) operations. The host was removed from the network, imaged, and shut down to mitigate damage. The Chain of Custody document (attached) was completed. The CPT requires analysis to verify the data collected in the Chain of Custody document. Access the host’s image, and verify the data contained in the Chain of Custody document.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) ls-wkstn-3. The login credentials are as follows:

Username: trainee
Password: CyberTraining1! 
﻿

2. Using the Windows PowerShell cmdlet Get-FileHash, generate MD5 hashes for evidence files. Use the following format, replacing {FILENAME} with each file listed in Table 31.2-1:

Get-FileHash {FILENAME} -Algorithm MD5


<img width="2500" height="889" alt="image" src="https://github.com/user-attachments/assets/142ba4f7-6619-4fa3-941e-04b405e93384" />

3. Verify the timestamps included in the Chain of Custody document.


Use this workflow to answer the following questions.


Keep the VM ls-wkstn-3 open, as it is used in an upcoming workflow

-------------

Unvalidated Data
The hash of the hosts file and timestamp values in the documentation do not match the information found on the host. The file’s data could not be verified, and further investigation regarding the difference is needed.


----------

Data Acquisition Overview
In a digital forensic investigation, data acquisition is the process of discovering, gathering, and recovering sensitive data. Therefore, cyber analysts need to understand the process of accessing, retrieving, restoring, and protecting the data. Data acquisition is achieved through forensic imaging using such software as FTK Imager, SIFT™ Workstation from SANS™ Institute, and EnCase Forensic.

﻿

Acquiring data for forensic evidence is possible via four methods:

Disk-to-disk: Uses hardware to create an exact copy of a source hard drive.
Disk-to-image: Makes a copy of a hard disk and saves the data as a file, such as an Optical Disk Image, or ISO, file. 
Logical: Creates a bit-for-bit copy of forensic data from only specific files or artifacts of interest. 
Sparse: Targets specific files and collects fragments of unallocated or deleted data.


--------------

Forensic File Formats
Data acquisition through forensic tools may use one of three primary file formats: RAW, proprietary, or Advanced Forensic.

﻿

RAW Format
﻿

The RAW file format is used by the Linux command dd (copy and convert command) to create exact copies of data. Analysts use this utility to create an exact bit-for-bit copy of a RAW disk or volume as a file. The RAW format allows for fast data transfers and supports a wide range of forensic tools. The RAW format requires disk space identical in size to the source data for the copy. 

﻿

Proprietary Formats 
﻿

Software vendors may create proprietary forensic file formats based on their own tools or applications. Proprietary format examples are AD1 files used by FTK Imager and E01 files used by EnCase Forensic.  Proprietary formats may contain functionality to compress or add segmentation or metadata to the image file, all of which increase efficiency and use of the image. A proprietary format is commonly exclusive to the tool or application it was created to support. 

﻿

Advanced Forensic Format
﻿

Designed as an alternative to proprietary formats, Advanced Forensic Format (AFF) is an open-source, flexible format easily shared between organizations with different forensic tools. AFF allows extensive metadata information to be stored with the image, consumes less disk space than EnCase Forensic or FTK Imager image formats (through compression and segmentation), and contains robust gathering and storing functionality.

﻿

Table 31.2-2 provides a list of common forensic applications and their supported image file formats:


<img width="2500" height="1184" alt="image" src="https://github.com/user-attachments/assets/285bb676-bc13-4115-be09-672c8a1750f3" />



------------


Acquire a Forensic Image
Read the scenario below, and complete the steps in the following workflow to acquire a logical forensic image in E01 format for analysis.

﻿

Scenario 
﻿

More information has been uncovered regarding the infected host incident described in the prior exercise. The CPT requires help acquiring a logical forensic image for host ls-wkstn-3 before the host is shut down. The team has requested that the image be collected in E01 format. 

﻿

The VM ls-wkstn-3 should still be open from the prior workflow. If it is not open, log in to ls-wkstn-3 using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

Workflow 
﻿

1. Open FTK Imager. Select Yes when prompted Do you want to allow this app to make changes to your device?﻿

﻿

2. In FTK Imager, select File > Create Disk Image…﻿

﻿

3. In the Select Source window, select Logical Drive, and select Next. 

﻿

4. In the Select Drive window, select C:\ - [NTFS], and select Finish.

﻿

5. In the Create Image window, under Image Destination(s), select Add…﻿

﻿

6. In the Select Image Type window, select E01, and select Next.

﻿

7. In the Evidence Item Information window, enter the following information:


Case Number: FN2187
Evidence Number: 1
Unique Description: Image of ls-wkstn-3
Examiner: trainee
Notes: <leave empty> 

8. In the Select Image Destination window, enter the following information, as shown in Figure 31.2-1:


Image Destination Folder: E:\
Image Filename: ls-wkstn-3_image
Image Fragment Size: 1500
Compression: 6
Use AD Encryption: <leave unchecked>

<img width="864" height="644" alt="image" src="https://github.com/user-attachments/assets/5cc1978b-8a69-47ca-963b-036dad887f0f" />

NOTE: E:\ is a separate drive used for evidence collection. 


9. Select Finish.


10. Select Start to begin the creation of the image. Imaging of the logical disk may require up to 20 minutes to complete.


Use this exercise to answer the following question


-------------

### CDAH-M32L1-Strategize Threat Mitigation ###

Develop a Threat Mitigation Strategy
Host threat mitigation consists of two key responsibilities. The first responsibility is to eliminate the threat. The second responsibility is to improve defensive capabilities for preventing both continuing and future exploitation by similar threats. Although various strategies are available for threat mitigation, defense teams must strive to choose strategies that allow successful fulfillment of both threat mitigation responsibilities.

﻿

The following steps help defense analysts identify the best strategies to mitigate threats:

Analyze malicious activity.
Plan threat mitigation.
Develop a threat mitigation strategy.
Step 1: Analyze Malicious Activity
﻿

The IR team must complete an initial set of IR tasks before beginning mitigation. During the first phase of IR, Preparation, mission planning is conducted to identify critical systems, available security tools, and tactics. The second phase, Detection and Analysis, involves identifying and investigating malicious activity. The third phase of IR has three key goals: Containment, Eradication, and Recovery. After Containment, this phase requires analyzing malicious activity to strategize post-incident actions that fully mitigate the threat. Strategizing threat mitigation ensures that all known aspects of the malicious activity are accounted for when completing Containment, Eradication, and Recovery.

﻿

Malicious Email Attachment Scenario
﻿

Figure 32.1-1, below, illustrates a scenario in which the following malicious activity was identified during Detection and Analysis:

Host A was compromised after downloading an email containing a malicious HTML file attachment. Opening the malicious attachment executed JavaScript code that automatically downloaded a second-stage malware payload from an external IP address.
Hosts B and C were compromised because they share a vulnerability that was exploited by the malware delivered from Host A.
Hosts D and E on the network also received the malware from Host A but were not compromised because they were not vulnerable to the attack.

<img width="2500" height="1805" alt="image" src="https://github.com/user-attachments/assets/30326259-e3cf-4d74-9bb4-989c2a04b19f" />


An analysis of the scenario and identification of all hosts involved provides critical direction for the Containment, Eradication, and Recovery phase of IR. All hosts that received the malware require remediation, as summarized below:
Hosts A, B, and C were compromised by multiple forms of malware, so these hosts must be cleansed of malware and returned to a known good software configuration.
Hosts D and E received the malware and, although they were unaffected, must be cleansed of the malware from Host A.


After identifying the necessary mitigation actions, the next step is to plan how to implement the actions by creating a mitigation strategy.


Step 2: Plan Threat Mitigation


Although the second phase of IR involves significant analysis, the third phase of IR extends this analysis as part of its containment, eradication, and recovery planning efforts. The goal of the second phase of IR is to detect and analyze malicious activity and contain a potential breach. By contrast, one of the goals of the third phase is to correlate malicious activity with known threat behavior. The distinction between the two phases is most apparent when planning actions to mitigate the risks involved with threat behavior. This type of planning is critical for the third phase, but may be overlooked during the second phase of IR.


In the malicious email attachment scenario, Host A was compromised by malware, leading to additional malware compromising Hosts B and C. Actions during the second phase of IR likely did not include patching the vulnerable software on Hosts B and C, which were exploited by the malware. Additionally, the malicious email that was the root of the compromise may have been delivered to others in the organization. These emails need to be removed from all email accounts and measures need to be taken to prevent similar emails from being delivered. This attention to the risks involved in the compromise in the third phase of IR allows for containment, eradication, and recovery.


Development of a threat mitigation plan involves taking into consideration the analysis performed during the second phase of IR and applying this information to understand how the threat was successful. Applying the information includes remediating vulnerable software, malicious system changes to hosts, and user behavior that allowed the compromise. The IR team should also consider current policies and procedures that may be flawed. Deliberating and examining these considerations is similar to the actions performed by the threat actor. By understanding the weaknesses in the operating environment, better defenses and longer-lasting mitigations can be developed to help prevent future exploitation. According to the analyses, these defenses may include educating users about threats and safe work practices, revising policies and procedures, and implementing system and network changes.


In summary, threat mitigation planning involves both addressing the security concerns identified in the second phase of IR, as well as evaluating the operating environment to understand how the threats were successful in the first place. This allows the IR team to remediate both the immediate security concerns as well as to perform preventative maintenance to address the roots of the problem in the third phase of IR.


Step 3: Develop a Threat Mitigation Strategy


During the incident response process, three host machines were identified as compromised by malware. Review the information gathered through IR analysis and develop a strategy to mitigate the threats.


Workflow


1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:
Username: trainee
Password: CyberTraining1!



The IR team marked two files on this system as malicious.


2. Confirm the marked files are present on the system by opening a Command Prompt and navigating to their respective folders at the following directories:
C:\Users\trainee\Downloads\mailbox_cleaner.html
C:\Windows\Temp\sjuKKE82234.bin
The IR team’s report on the present incident states that malicious code exists in the file malibox_cleaner.html. This file was downloaded from an email attachment sent to a particular user, who then opened the file. The malicious file sjuKKE82234.bin was then downloaded to C:\Windows\Temp. Immediately afterwards, the hosts lin-hunt-cent and sift, on the same subnet as win-hunt, were compromised by malware. File transfer activity occurred between win-hunt and multiple other hosts, including lin-hunt-cent and sift but no additional malware compromises were discovered.


3. Log in to the VM lin-hunt-cent using the following credentials:
Username: trainee
Password: CyberTraining1!



The IR team marked one file on this system as malicious. 


4. Confirm the marked is present on the system by opening Terminal and navigating to its folder:
/opt/j8UHjdye45
The IR team investigated this executable file and determined that it exploits a common Linux application. The vulnerability was recently discovered and the software vendor provided the patch. Until remediated, this vulnerability allows for arbitrary remote command execution at an administrative level. No further malicious activity was detected on this host.


5. Log in to the VM sift using the following credentials:
Username: t
rainee
Password: CyberTraining1!



The IR team marked one file on this system as malicious.


6. Confirm the marked file is present by opening Terminal and navigating to its folder:
/opt/adWE9034
The IR team investigated this file and found it to be nearly identical to the malicious file found in the same folder on the host lin-hunt-cent. However, additional malicious activity was detected on this system. The following seven folders containing forensic evidence were accessed and encrypted within the cases folder within the root directory:
/cases
case1
case2
case3
case4
case5
case6
case7

The team discovered that these folders allowed full permissions to read, write, and execute for any user on the system. As a result, it is unknown if the malicious actor simply removed availability to these case files through encryption or if the sensitive information was accessed as well.


The three systems, win-hunt, lin-hunt-cent, and sift, were all infected with malware that originated from a user accessing a malicious email attachment on win-hunt. Malware was then distributed from win-hunt to lin-hunt-cent and sift which exploited a vulnerability in a commonly used Linux application. While no further malicious activity was detected on lin-hunt-cent, encryption of forensic case files and potential exfiltration of sensitive information occurred on sift, due in part to excessive folder and file permissions.


Use the information from this lab to strategize mitigation in the following questions


-----------


Incident Response Roles for Threat Mitigation
Although the Containment, Eradication, and Recovery phase of IR involves similar roles as in previous phases, individuals outside of the typical IR team may need to step in to fulfill specific duties at this stage. Understanding the operating environment and roles within the organization are necessary to choose the appropriate roles to mitigate threats.

﻿

Threat Mitigation
﻿

The IR tools used in previous phases, such as a SIEM and host monitoring tools found in the Sysinternals Suite, are also useful for verifying remediation in the Containment, Eradication, and Recovery phase. For example, the removal of malware and malicious system settings for malware persistence is expected to result in a change in system log activity, such as the removal of processes performing malicious network connections. This change in activity should be verified through host monitoring tools and SIEM queries and dashboards.

﻿

IR Roles in Threat Mitigation
﻿

Typical IR teams include the roles described in Table

<img width="2500" height="1113" alt="image" src="https://github.com/user-attachments/assets/b9789642-bb18-4bfc-ba93-37e90f2bf8ba" />

In addition to these roles, others may lend their talents in the IR process to perform forensics, system administration, user administration, vulnerability management, and other functions necessary to mitigate a threat. Depending on the operating environment and availability of staff, the IR Manager may require the IR team and additional personnel to perform mitigation activities.


An IR Manager plans threat mitigation roles as part of IR. This includes determining what roles are required for mitigation for both general purpose incidents as well issues that occur less often. General incidents include those regarding common security issues such as malware compromise and successful phishing attacks. Uncommon issues include large-scale security breaches. The results from the Detection and Analysis IR phase heavily determines the activities that are required for remediation. The IR Manager uses this information when assigning responsibilities to existing roles and coordinating efforts with other teams to draw upon their technical expertise concerning compromised systems.


Malicious Email Attachment Scenario


In the malware compromise scenario, it was determined that Hosts B and C were vulnerable to malware due to a common software vulnerability. The IR Team may be technically proficient in discovering and removing malware, but they may not have the authority or expertise to patch the vulnerable software to prevent future exploitation. In this case, the system administrator responsible for these hosts may be contacted to perform the necessary software patching and testing to ensure that the vulnerability is no longer present and that the application of the patch did not hinder any necessary functions of the hosts.


In summary, a successful mitigation of a threat not only removes the ability for an attacker to repeat an exploit, but also ensures that the mitigation strategy does not interfere with the normal, day-to-day operation of the host systems. This is one reason why it is important to develop a holistic threat mitigation strategy.

-------------


### CDAH-M32L2-Neutralize Threats ###

CPT Threat Mitigation Functions
An incident has occurred. The CPT is working to determine and carry out a threat mitigation strategy. Threat mitigation begins by understanding the system changes a malicious program has made on an infected host. 

﻿

System changes are defined and categorized as Indicators of Compromise (IOCs) associated with the malware. IOCs are determined by performing static and dynamic analysis of the malware. Once host analysts analyze the malware and determine IOCs, removal and neutralization of the threat begins.

﻿

A CPT performs the following steps when mitigating threats: 

Identify malware-related IOCs
Remove malicious artifacts
Determine and perform threat mitigation
Identify Malware-related IOCs
﻿

There are various types of malware. Each malware type includes its own design, file size, and functionality.  The wide range of malware types makes it impossible to use one solution for eliminating all malware threats. 

﻿

Dynamic Analysis
Dynamic analysis allows Host Analysts to identify actions that are performed by malware in order to compromise a system. Dynamic analysis is best performed in a sandbox environment, such as Cuckoo.

﻿

Malware-related IOCs may include basic events such as the creation of files with names that follow a prescribed pattern of characters, or the modification of a specific Windows Registry key. When these specific actions are observed and analyzed, they are recorded as IOCs associated with the malware. Once behaviors are identified on a compromised host, all malicious presence is removed and the threat is neutralized.

﻿

Removal of Malicious Artifacts
﻿

A threat mitigation strategy defines different options that exist for eliminating adversarial presence on a compromised host. The strategy can include actions ranging from re-imaging a system to removing malicious artifacts.

﻿

Re-imaging a system is most efficient for user workstations, however systems in an Industrial Control System (ICS) environment often require the removal of malicious artifacts. For this reason, identifying malware-related IOCs is necessary to ensure that the threat is entirely removed. If a malicious binary remains on the host, it is possible for the malware to execute in the future and perpetuate further compromise. 

﻿

Perform Threat Mitigation
﻿

After malware activity and artifacts have been observed and identified, the next step is to determine how to perform threat mitigation activities on the compromised hosts. 

﻿

An infection of malware is rarely limited to a single host. The manual removal of malicious artifacts on each host can be tedious, time-consuming, and inefficient. In the event of a malicious compromise across several hosts, automated solutions for threat mitigation must be explored. Using tools, such as PowerShell, allows analysts to create and run scripts to perform the necessary checks and removal of malicious artifacts.


-----------

Threat Neutralization
Threat neutralization is a crucial function of a CPT to minimize exposure to risks such as the theft of user credentials, the execution of malicious code, or the loss of systems, resources, and sensitive information. 

﻿

The steps for performing threat neutralization are as follows:

Identify malware activity.
Identify behavior indicating a compromise.
IR scripting and remote access.
Identifying Malware Activity
﻿

Malware activity can be identified using dynamic and static analysis of malicious code. Once an executable file has been identified as malicious, observing system changes often leads to the discovery of artifacts that can be used in the investigation.

﻿

Malware analysis allows the CPT to observe and experience malicious behavior in order to determine the likelihood of a compromise. When hunting for signs of host compromise across a network, the use of IR scripts can be more efficient than manually inspecting each system. 

﻿

The first step in neutralizing a threat is to identify the actions performed by the malicious code. These actions are observed with the help of a sandbox tool, such as Cuckoo, which is used in upcoming workflows.

﻿

Scenario
﻿

Using the ZeuS trojan as an example, ZeuS is capable of monitoring internet activity and recording user keystrokes. Suppose ZeuS was delivered to a victim through the use of phishing emails and malicious drive-by downloads. 

﻿

The Suspicious Process
Through the monitoring of host network activity, the download of an executable file can be detected, copied, and uploaded to Cuckoo for analysis. 

﻿

Cuckoo's analysis report provides information about the changes made by the malware, and the creation of the following suspicious process:

C:\Windows\system32\cmd.exe"/c "C:\Users\Bob\AppData\Local\Temp\tmp2aw5421d.bat
﻿

This suspicious process consists of a call to the built-in Windows command interpreter, cmd.exe, followed by the /c parameter. This instructs cmd.exe to execute a certain batch file found within a temporary directory. A batch file is a script containing executable instructions. This file is suspicious because it includes the execution of a binary file from inside another binary file. 

﻿

The Executed Batch File
The executed batch file resides in a temporary directory, suggesting that it was created by the executed malware. Cuckoo identified the creation of the batch file 2b828b74d57876f4_tmp2ae5421d.bat from the observed behavior, and determined that it was used to delete the original binary.

﻿

The behavior is an attempt by the malware to hide itself within the infected system. Eliminating the original malware executable covers evidence of the malware, and likely resulted in the creation of a new file containing malicious code. Understanding this type of activity allows an analyst to recognize behavior that indicates another host has been infected.

﻿

The Registry Change
The following code block displays activity observed by Cuckoo, showing the modification of the Windows Registry:

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
C:\Users\Bob\AppData\Roaming\Vaxw\tuiha.exe
﻿

Cuckoo describes the registry change as a method to automatically run the malware at boot. The specific key is described and controls specific programs that will automatically execute when a user logs on to Windows. 

﻿

The New File
Additionally, the registry change includes the file path to a hidden folder in a user’s directory. Notably, this is not a temporary directory. Furthermore, the executable designated in this key, tuiha.exe, is not the name of the original malicious file submitted for Cuckoo analysis, nor the name of the subsequent batch file that deleted it. 

﻿

Instead, tuiha.exe is a new file in a new subdirectory of the user’s AppData\Roaming folder. Assuming that the malware created this subdirectory and executable file, the existence of a similar directory in another system may indicate a compromise.

-----------

Identifying IOCs
The second step in neutralizing a threat is to identify behavior that indicates a compromise. 

﻿

This step is completed by discovering system changes made to a host by the malware. Although similar to the first step, this step results in CPTs arriving at a clearly defined set of IOCs associated with the malware.

﻿

Scenario Continued
﻿

Windows Sysinternals suite can be used to identify malicious behavior. Given that many of these artifacts involve system processes, Process Monitor can be used to discover and confirm file system and registry changes. 

﻿

The Executed Batch File
The ZeuS trojan, analyzed in Cuckoo, was executed on a Windows system. Shortly after, Process Monitor collected data pertaining to the creation of a process. 

﻿

The process includes the execution of the following batch file:

sample4.exe Process Create PID 2872 Command line: 
"C:\Windows\system32\cmd.exe"/c "C:\Users\Bob\AppData\Local\Temp\tmpb577ffe6.bat"
﻿

When an executable file is opened in Windows, a new process is created with the same name as the executable file. The ZeuS trojan is named sample4.exe. Process Monitor recognized the creation of the new process by sample4.exe and assigned to it the Process Identification Number (PID) 2872. 

﻿

The new process consisted of a call to the Windows built-in command interpreter with a command to execute a certain patch file in a temporary directory. This behavior is identical to the created suspicious process that was observed by Cuckoo in the sandbox. 

﻿

Identifying a Pattern
The name of the batch file is different from the one observed in Cuckoo due to randomization used by the malware. However, a pattern can be observed. Both file names begin with tmp, followed by eight alphanumeric characters, and end with .bat. The way these files were named may be according to a pattern, and knowledge of this can aid in automated detection of malicious activity.

﻿

Process Monitor also observed the modification of a Windows Registry value used to run an executable whenever a user logs on. The output from Process Monitor is as follows:

lodya.exe 3044 RegSetValue HKCU\Software\Microsoft\Windows\CurrentVersion\Run\{731…SUCCESS}
C:\Users\Bob\AppData\Roaming\Sywau\lodya.exe
﻿

This record describes that a process named lodya.exe successfully issued an instruction to set a registry key value. This key controls which programs automatically execute when a user logs on to Windows, and it is included in the Cuckoo report. 

﻿

Discovered IOCs
The malware behavior reported by Cuckoo was associated with activity found on a compromised host, using Sysinternals. The discovered IOCs as a result of this step include the creation of malicious batch files, executable files, and registry key values


-----------

IR Scripting and Remote Access
After IOCs are identified, they can be removed using scripting and remote access.

﻿

In PowerShell, the Get-Item cmdlet returns a specified item from a specified location and can be used to discover registry key values. 

﻿

Figure 32.2-1 below shows the cmdlet used to obtain the persistence mechanism planted by the ZeuS trojan

<img width="1210" height="132" alt="image" src="https://github.com/user-attachments/assets/6eb82722-7868-4ae7-b61d-e013468e659d" />

Once malware is found, PowerShell can be used to scan multiple hosts for malware persistence more quickly than accessing and manually analyzing Process Monitor on each individual host.


The Get-ChildItem cmdlet returns items found within a specified container. 


As shown in Figure 32.2-2 below, Get-ChildItem can be used to return the top five recently-modified files in a directory

<img width="904" height="620" alt="image" src="https://github.com/user-attachments/assets/8e26d050-2e2b-4796-8102-52bf953ec303" />

This information can be used to help search for the folders used by ZeuS to store its persistent executable file.


The cmdlets are available through an interactive terminal, however their true value comes from the ability to call them in a PowerShell script. A script allows for quick execution and can be deployed to systems across a network to search for a compromised host. The following script uses the discovered IOCs to help to find the compromise:
$path1 = 'C:\Users\Bob\AppData\Local\Temp'
$path2 = 'C:\Users\Bob\AppData\Roaming'
$pattern1 = 'tmp\w{8}.bat'
$pattern2 = '\w{5}.exe'

Get-ChildItem $path1 -recurse | where {$_.name -match $pattern1} | Select name
Get-ChildItem $path2 -recurse | where {$_.name -match $pattern2} | Select name

---------

Dynamic Analysis
Dynamic analysis is the process of executing malware in a sandbox environment and observing its behavior. A malicious Python script was found operating in the network. Analysis of the script has not yet been completed. 

﻿

Access an Ubuntu workstation and use Cuckoo to perform dynamic analysis of the malware. 

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) cuckoo with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

When an alert appears, as shown in Figure 32-2.3 below, select OK

<img width="588" height="237" alt="image" src="https://github.com/user-attachments/assets/55a98436-c886-48f4-991a-76fcdd16e43d" />

2. Open a new Terminal window. Enter the following command to start the Cuckoo Web User Interface (UI):
cuckoo web -H 0.0.0.0 -p 8080

 ﻿
6. Open Firefox ESR. Enter and navigate to the following Uniform Resource Locator (URL):
http://localhost:8080



7. Select Submit A File For Analysis from the Cuckoo dashboard.


8. Select the forge.py file from the Desktop. 


9. Select Submit.


10. Select Analyze on the Configure Your Analysis page. 


11. Allow Cuckoo to run the analysis. When the Task is indicated as Reported, select the Task.


Review the report and answer the following question

----------

Malicious Registry Key
Figure 32.2-4 below shows the malicious registry key, located on the Summary tab of the report, in the Signatures section

<img width="2048" height="695" alt="image" src="https://github.com/user-attachments/assets/198893a0-d83b-4016-9d1a-f2772c535e9a" />

The following registry key ensures the malicious binary is executed at host boot:
C:\Windows\System32\driverupd.exe
Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\DriverUpdate


--------------

Scripting to Neutralize Threats
The IR team identifies that the  forge.py  malicious script has been downloaded and placed in the C:\Users\Public\Documents path.

﻿

Use Windows PowerShell to determine if the forge.py script is present on hosts in the network, and to remove the forge.py script from compromised hosts.

﻿

Workflow
﻿

1. Log on to win-dev VM with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open PowerShell ISE as an Administrator. 

﻿

3. Select New Script and enter the following text:

```
$hosts = Get-Content -Path C:\Hosts\Hosts.txt

$Result = ForEach ($hosts in $hosts)

    { Invoke-Command -ComputerName $hosts {Get-ChildItem "C:\Users\Public\Documents\forge.py"}}

$Final = $Result | select PSComputerName | ft -auto -wrap
$Final
﻿
```

The script defines the $hosts variable by reading the content within the Hosts.txt. The script then defines the $Result variable with a foreach loop. 

﻿

The foreach loop takes each host in the Hosts.txt file and uses the Get-ChildItem cmdlet to pull the items and child items from the C:\Users\Public\Documents\ forge.py  path.

﻿

The result of Get-ChildItem is placed in the $Final variable, where the computer name of the computer containing the forge.py file, is presented. 

﻿

4. Run the script. Review the output.


----------------

Compromised Hosts
The new script returns the following output:

Cannot find path 'C:\forge.py' because it does not exist.
    + CategoryInfo          : ObjectNotFound: (C:\forge.py:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
    + PSComputerName        : cdah-wrks1

PSComputerName
--------------
cdah-wrks0
cdah-wrks2
﻿

The output confirms the file forge.py is located on hosts cdah-wr ks0 and  cdah-wrks2 on the following path: 

C:\Users\Public\Documents\forge.py



----------

Removing Files with PowerShell
Develop and run a Windows PowerShell script to quickly remove the forge.py files found on the cdah-wrks0 and cdah-wrks2 hosts. 

﻿

Workflow
﻿

1. Log on to win-dev VM with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the Hosts.txt file located on the following path:

C:\Hosts\Hosts.txt
﻿

3. Modify the Hosts.txt file to only include the compromised hosts cdah-wrks0 and cdah-wrks2.

﻿

4. Save and close the Hosts.txt file.

﻿

5. Open PowerShell ISE as an Administrator.

﻿

6. Select New Script. 

﻿

7. Enter the following script:

```

$hosts= Get-Content -Path "C:\Hosts\Hosts.txt" 

foreach ($onehost in $hosts) 
  {
        Remove-Item -Path "\\$onehost\c$\Users\Public\Documents\forge.py" -Force -Recurse
           }
﻿

```

The script defines the $hosts variable by reading the content in Hosts.txt. The foreach loop uses each host in the Hosts.txt file and searches for the forge.py file. If the script finds the forge.py file, it removes it from the host. 

﻿

8. Run the script.

﻿

The script executes successfull y by ret urning no errors.



----------------

Modifying the Registry Remotely
Hosts cdah-wrks0 and cdah-wrks2 are compromised with the forge.py malware. 

﻿

Use Command Prompt to remove the installed registry entry and quickly neutralize the threat.

﻿

Workflow
﻿

1. Log on to cdah-wrks0 VM with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Registry Editor and access the following key:

Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\DriverUpdate
﻿

The key installed by the malware is DriverUpdate and it includes the C:\Windows\System32\driverupd.exe path.

﻿

To neutralize the malware, the key must be removed on all hosts. It is possible to manually remove the key by accessing each compromised host, however that method exhausts valuable time and resources. Instead, use the Command Prompt to save time.  

﻿

3. Log on to win-dev VM with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

4. Open Command Prompt as Administrator.

﻿

5. Enter the following cmdlet:
```
REG DELETE \\cdah-wrks0\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\DriverUpdate

﻿```

6. When prompted to permanently delete all values under the registry key, enter Yes. 

﻿

7. Open the cdah-wrks0 VM. 

﻿

8. Open Registry Editor, and then access the key found in the following path:

Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run
﻿

The remote command accurately removes the malicious key and neutralizes the threat.

﻿

9. Complete Step 5 in this workflow once for cdah-wrks2. Use the following command:

```

REG DELETE \\cdah-wrks2\HKEY_LOCAL_MACHINE\SOFTWARE\WOW64
32Node\Microsoft\Windows\CurrentVersion\Run\DriverUpdate

```


------------



































































































































































































