###################################################################### MOD 26

---

## 1. Use NIST Best Practices for Incident Response

**Workflow Steps:**
1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:
   - Username: trainee
   - Password: CyberTraining1!

2. Open the Process Monitor (Procmon64) shortcut located on the desktop. Select Run, and select Yes.
   - **Explanation:** Procmon is part of Windows Sysinternals and records live file system activity.

3. Minimize Procmon, and return to the desktop. Select Lab1.exe, located on the desktop.

4. Close the malware notification.

5. Return to Procmon. Select Filter on the menu task bar, and select Filter on the drop-down menu. In the Process Monitor Filter window that appears, select Process Name, and enter Lab1.exe as the search filter, then Add.
   - **Explanation:**  
     - **Filter:** Process Name is set to Lab1.exe  
     - This shows only events generated by the Lab1.exe process, helping focus on the malware’s activity.

6. Scroll down the filtered output list, and analyze the results displaying interactions with the registry, created file activity, and network connections.

7. Close Procmon.

8. Open tcpview64, located on the desktop, to further analyze network connections from the MCA. Select Yes to open the application when prompted.
   - **Explanation:** TCPView shows active TCP and UDP connections.

9. In the TCPView search box, enter Lab1.exe to filter the network connections toward the MCA.
   - **Filter:** Only network connections initiated or owned by Lab1.exe are displayed.

10. Make a note of the remote IP address and port.

11. Open Autoruns64, located on the desktop. Select Run to continue. If administrative rights are requested, select Yes.
    - **Explanation:** Autoruns lists all auto-starting locations and persistence mechanisms on Windows.

12. Analyze the returned entries for anomalous activity. Once completed, close Autoruns.

13. To view Sysmon events pertaining to the MCA, open Google Chrome, and select the Security Onion bookmark. Log in using credentials:
    - Username: trainee@jdmss.lan
    - Password: CyberTraining1!

14. Set the time period of interest as Aug 2, 2022 @ 09:20:00.000 to Aug 2, 2022 @ 09:25:00.000, and select Update.
    - **Explanation:** Sets the Kibana dashboard to only show logs from the specified time range.

15. Analyze the resulting data.
    - Look for infected hosts, suspicious files, executables run, persistence mechanisms, and IPs/ports used for communication.

---

## 2. Identify Infrastructure Vulnerabilities

**Workflow Steps:**
1. Log in to the Virtual Machine (VM) acas using the provided credentials:
   - Username: trainee
   - Password: CyberTraining1!

2. Open a Firefox web browser and select the bookmark Nessus.

3. From the left pane of the Nessus dashboard, select My Scans, then select Mission Partner's Network.

4. Analyze the information presented under the tab Hosts and the provided network map to pinpoint scanned hosts.

5. Select the tab Vulnerabilities and analyze more specific details.

6. Select the tab VPR Top Threats to analyze remediation efforts.
   - **Explanation:** VPR (Vulnerability Priority Rating) helps focus on the most critical threats.

7. Select the vulnerability MS17-010: Security Update for Microsoft Windows SMB Server, as highlighted, to display more information regarding the criticality of this vulnerability.
   - **Explanation:** This vulnerability is associated with the EternalBlue exploit.

---

## 3. Prioritize Vulnerabilities With Elastic Stack

**Workflow Steps:**
1. Log in to the VM kali-hunt using the provided credentials:
   - Username: trainee
   - Password: CyberTraining1!

2. Open a Firefox web browser and select the bookmark Security Onion.

3. Select the hamburger menu at the top left, then select Kibana in the section Tools.

4. Select Alert under Event Category in the Security Onion - Navigation pane.

5. In the field highlighted, set the time period from Sep 22, 2022 @ 10:00:00.000 to Sep 22, 2022 @ 13:00:00.000, then select Refresh.
   - **Explanation:** Focuses the analysis on events during a specific suspected incident window.

6. To analyze events using port 445, add the following filter then select Refresh:
   - **Filter:** destination.port: 445  
   - **Explanation:** Shows only traffic/events where the destination port is 445 (SMB).

7. To allocate SMB usage along with the exploit MS17-010, apply the following rules to the search:
   - **Filter:** event.severity_label.keyword: high AND rule.name.keyword: ET EXPLOIT Possible ETERNALBLUE Probe MS17-010 (MSF style)
   - **Explanation:** Shows only high-severity events where the rule name matches the identified exploit.

8. Analyze the fields destination.ip and message in the log at 12:33:11.272.

9. Remove the previous filter rule and replace it with the following rule:
   - **Filter:** rule.name.keyword: ET POLICY Powershell Activity Over SMB - Likely Lateral Movement  
   - **Explanation:** Detects lateral movement activity via PowerShell over SMB.

10. Analyze the field message in the log at 12:59:40.698.

---

## 4. IR in OT and IT Architecture | Part 1

**Workflow Steps:**
1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:
   - Username: trainee
   - Password: CyberTraining1!

2. Open the Chrome web browser, select the Security Onion bookmark, and log in:
   - Username: trainee@jdmss.lan
   - Password: CyberTraining1!

3. Select the hamburger menu icon in the top left corner, and select Kibana in the Tools section.

4. Select the hamburger menu icon again, and select Discover in the Analytics section.

5. Set the time period of interest from Sep 29, 2022 @ 10:00:00.000 to Sep 29, 2022 @ 13:00:00.000, and select Update.

6. Use this Kibana Query Language (KQL) query to locate the network traffic associated with the host in the Business Processing Department, and select Update:
   - **KQL Query:** destination.ip: 172.16.3.2  
   - **Explanation:** Shows logs with destination IP matching the business workstation.

7. Analyze the log captured on Sep 29, 2022 @ 12:28:26.976.

8. Remove the previous KQL query, and use the new KQL query to search for the IP address of the PLC. Select Update:
   - **KQL Query:** source.ip: 172.16.80.10  
   - **Explanation:** Shows logs with source IP matching the PLC.

9. Add the following filter to analyze Modbus protocol traffic, and select Save:
   - **Filter:** event.dataset.keyword: modbus  
   - **Explanation:** Filters logs to only those using the Modbus protocol, typical for OT environments.

10. Analyze the log captured on Sep 29, 2022 @ 12:59:59:980.

---

## 5. IR in OT and IT Architecture | Part 2

**Workflow Steps:**
1. Remove the Modbus filter and KQL query that was set in the previous task, and add a new query, to include the following:
   - **KQL Query:** source.ip: 172.16.3.2 and destination.ip: 172.16.80.10  
   - **Explanation:** Shows traffic where the business workstation is talking directly to the PLC.

2. Analyze the log captured on Sep 29, 2022 @ 12:41:44.556. Notice the port and protocol used.

3. Select the hamburger menu icon, and select Dashboard under Analytics.

4. Select Network under Event Category.

5. Edit the KQL query search bar to include the IP address of the PLC in the query. Select Refresh:
   - **KQL Query:** event.category: network and source.ip: 172.16.80.10  
   - **Explanation:** Displays all network events originating from the PLC.

6. Analyze the Security Onion - Destination IP pane.

---

# Summary of Commands and Filters

- **Procmon64/Autoruns64/TCPView:**  
  - Used to observe process, persistence, and network activity on Windows.
  - Filters (like Process Name in Procmon or search in TCPView) allow you to zero in on malicious or suspicious activity.

- **Kibana/Elastic Stack Filters and Queries:**  
  - **destination.port: 445** – Focuses on SMB traffic.
  - **event.severity_label.keyword: high AND rule.name.keyword: ...** – Narrows view to high-severity events for a specific exploit (e.g., EternalBlue).
  - **rule.name.keyword: ...** – Finds specific detection rules, like lateral movement.
  - **destination.ip: [IP] / source.ip: [IP]** – Filters logs based on host IPs for incident tracing.
  - **event.dataset.keyword: modbus** – Restricts view to Modbus protocol traffic, common in OT.
  - **event.category: network** – Shows all network-related events.

---------------------------

################################################################################# MOD 27

Here’s a comprehensive breakdown from the file dumpdump.md, focusing on all workflow steps (“Workflow” sections and numbered steps) and explanations for any commands or filters mentioned.

---

## 1. Host Isolation: PowerShell Isolation Tool Workflow

**Workflow Steps:**

1. Log in to VM dc01 (Username: trainee, Password: CyberTraining1!)
2. Open PowerShell ISE.
3. Define user-supplied parameters:
   ```powershell
   param(
       [Parameter()]
       [String]$ComputerName,
       [String]$RouterIP,
       [String]$UserName,
       [String]$Password
   )
   ```
4. Import Active Directory module:
   ```powershell
   Import-Module ActiveDirectory
   ```
5. Obtain IP of isolated computer:
   ```powershell
   $ComputerIP = $(Resolve-DnsName $ComputerName).IPAddress
   ```
6. Turn off network adapter in five minutes:
   ```powershell
   Invoke-Command -ComputerName $ComputerName -ScriptBlock {Register-ScheduledTask -TaskName 'Isolate' -InputObject ((New-ScheduledTask -Action (New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-Enable-NetAdapter -Name "Ethernet1" -Confirm:$false') -Trigger (New-ScheduledTaskTrigger -Once -At (Get-Date).AddMinutes(5)) -Settings (New-ScheduledTaskSettingsSet)))}
   ```
7. Remove host from domain:
   ```powershell
   Remove-Computer -ComputerName "$ComputerName" -UnjoinDomainCredential energy\trainee -WorkgroupName "Isolated" -Force
   ```
8. SSH into the router:
   ```powershell
   plink -ssh vyatta@$RouterIP -i $env:UserProfile\id.ppk -batch
   ```
9. Begin router configuration:
   ```
   /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin;
   ```
10. Create firewall address group:
    ```
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED address $ComputerIP;
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED description 'Isolated IP Addresses';
    ```
11. Create firewall rule:
    ```
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule default-action 'accept';
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule description 'ISOLATED';
    ```
12. Add drop rule for isolated host:
    ```
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 action 'drop';
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 description 'Isolate IP address';
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 source group address-group ISOLATED;
    ```
13. Apply rule to interfaces:
    ```
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth1 firewall local name Isolation-Rule;
    (repeat for eth2-eth7)
    ```
14. Commit/save changes:
    ```
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit;
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save;"
    ```
15. Ensure script is correct (see above for final script).
16. Save as IsolateHost.ps1.

**Explanation of Commands:**
- `param(...)`: Sets up script parameters.
- `Import-Module ActiveDirectory`: Allows manipulation of AD objects.
- `Resolve-DnsName ...`: Gets IP address for a hostname.
- `Invoke-Command ... Register-ScheduledTask ...`: Schedules disabling of network adapter remotely.
- `Remove-Computer ...`: Removes host from AD domain.
- `plink ...`: SSH command-line client for automating router configuration.
- `/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper ...`: Vyatta firewall/router config commands.
- `commit; save;`: Commits and saves router configuration.

---

## 2. Restoration Tool Workflow

**Workflow Steps:**

1. Log in to VM dc01 (Username: trainee, Password: CyberTraining1!)
2. Open PowerShell ISE.
3. Define user-supplied parameters:
   ```powershell
   param(
       [Parameter()]
       [String]$ComputerName,
       [String]$RouterIP
   )
   ```
4. Import AD module:
   ```powershell
   Import-Module ActiveDirectory
   ```
5. Restore network access on router:
   ```bash
   plink -ssh vyatta@$RouterIP -i $env:UserProfile\id.ppk -batch "/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin; /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall group address-group ISOLATED; /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall name Isolation-Rule; ... (repeat for eth1-eth7); /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit; /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save;"
   ```
6. Add host back to domain:
   ```powershell
   Add-Computer -ComputerName $ComputerName -LocalCredential $ComputerName\Administrator -DomainName energy.lan -Credential energy\trainee -Restart -Force
   ```
7. Save as RestoreIsolatedHost.ps1.
8-9. Log in to VM eng-wkstn-1 (Username: trainee, Password: CyberTraining1!), open PowerShell.
10. Enable network adapter:
    ```powershell
    Enable-NetAdapter -Name "Ethernet1" -Confirm:$false
    ```
11-13. Run RestoreIsolatedHost.ps1 from dc01.

**Explanation:**
- `Add-Computer ...`: Rejoins computer to the domain.
- `Enable-NetAdapter ...`: Re-enables host’s network adapter.

---

## 3. Identify a Compromised Host (Security Onion & Kibana)

**Workflow Steps:**

1. Open win-hunt VM (Username: trainee, Password: CyberTraining1!)
2. Open Chrome.
3. Open “1 - DashBoard - Security Onion” bookmark.
4. Log in to Security Onion Console.
5. Adjust time frame (Oct 4, 2022 @ 05:00:00 → Oct 4, 2022 @ 17:00:00), document log counts.
6. Select Network under Event Category.
7. Confirm time frame and select source IPs.
8. Observe IPs in destination ports data.
9. Go to Kibana Discover - Elastic.
10. Set columns: source.ip, source.port, agent.type, destination.ip, destination.port.
11. Add filter to show only data with destination port:
    ```
    destination.port exists
    ```
12. Search for main engineer subnet traffic:
    ```
    destination.port : <port> and event.dataset.keyword :* exe
    event.provider : Microsoft-Windows-Sysmon
    ```
    - Filters for traffic to destination port, involving executable files and Sysmon logs.

**Explanation:**
- `destination.port exists`: Only shows logs with a destination port value.
- `event.dataset.keyword :* exe`: Finds log events related to executable files.
- `event.provider : Microsoft-Windows-Sysmon`: Filters for events provided by Sysmon.

---

## 4. Forensic Artifact Acquisition (Redline)

**Workflow Steps:**

1. Open eng-wkstn-1 VM (Username: trainee, Password: CyberTraining1!)
2. Create folder “Memory Analysis 2.”
3. Open Redline > Create Standard Collector.
4. In Redline, check “Acquire Memory Image,” set destination folder.
5. Follow “Open Directory Containing Portable Package” link.
6. Close open dialogs in Redline.
7. Right-click RunRedlineAudit, Run as administrator.
8. Wait for Redline CLI to complete.
9. In Redline dashboard, open AnalysisSession1.mans.
10. In Analysis Data pane, select Processes, review for malicious ones.
11. Filter Username column for “trainee.”
12. In Analysis Data, select Ports to analyze process network connections.

**Explanation:**
- Redline is an incident response tool for memory/process analysis.
- Filters in Redline help isolate suspicious processes by user or port.

---

## 5. Log Analysis and Preservation (Kibana, PowerShell)

**Kibana Workflow Steps:**

1. Open win-hunt VM.
2. Open Chrome.
3. Select Discover - Elastic bookmark.
4. Log in to Security Onion Console.
5. Set search time frame (Sep 21, 2022 @ 00:00:00 → Sep 21, 2022 @ 23:30:00).
6. Filter by type, set Hide Missing Fields off.
7. Add columns: agent.name, agent.type, event.code, event.action, event.dataset, event.module, log.level.
8. Query:
    ```
    event.code: 1102 or event.code: 104 or event.code: 517
    ```
    - These codes indicate log clear events.

**PowerShell Workflow Steps:**

1. Open bp-wkstn-1 VM (Username: trainee, Password: CyberTraining1!)
2. Run:
    ```powershell
    get-eventlog -list; get-service "ev*" | sort-object status
    ```
3. Open bp-wkstn-3 VM (Username: administrator, Password: CyberTraining1!)
4. Run above PowerShell commands.
5. Start any stopped event log services:
    ```powershell
    start-service -name "ServiceName"
    ```
6. Open services.msc to check Windows Event Log service startup type.

**Explanation:**
- `get-eventlog -list`: Shows all available event logs.
- `get-service "ev*"`: Lists all services starting with “ev” (e.g., event log services).
- `start-service -name ...`: Restarts a stopped service.
- `services.msc`: GUI for managing Windows services.
- Event codes:
    - 1102: Windows Event Log was cleared.
    - 104: Event log was cleared.
    - 517: Windows Event Log was cleared.

---

## 6. Confirm Modification of Logs

**Workflow Steps:**

1. Open win-hunt VM.
2. Open Chrome.
3. Select Discover-Elastic.
4. Log in to SOC.
5. Set time frame.
6. Filter by type, Hide missing fields off.
7. Ensure columns are added.
8. Add filter for agent.name = bp-wkstn-3.
9. In Edit Filter, enter agent.name, select "is", value bp-wkstn-3.
10. Apply.
11. Search for:
    - `event.code: 6006`
    - `event.action: Log cleared`

**Explanation:**
- `event.code: 6006`: Windows event log service stopped.
- `event.action: Log cleared`: Looks for log-clearing events.

---

## 7. Find Malware Attack Paths

**Workflow Steps:**

1. Open bp-wkstn-3 VM.
2. Run MMC.
3. Add Computer Management snap-in for Local Computer.
4. Enable Windows Event Log service (set Startup Type to Automatic, Start it).
5. Open Sysmon Operational event log.
6. Filter current log:
    - Date range: 9/21/2022 12:00:00 AM to 9/22/2022 11:30:00 PM
    - Event IDs: 1,11,13
7. Use Find in log: search for "clear-eventlog"
8. In Kibana, set time frame as above, add columns, filter for agent.name = bp-wkstn-3.
9. Query:
    ```
    event.action: "Process Create (rule: processCreate)" and process.command_line: "powershell"
    ```
    - Finds processes created via PowerShell.

**Explanation:**
- Sysmon Event IDs:
    - 1: Process creation.
    - 11: File creation.
    - 13: Registry object creation.
- Kibana query finds PowerShell-created processes, which are often part of attacker TTPs.

---

## 8. Malware Analysis (Static & Dynamic)

**Workflow Steps:**

1. Open VM sandbox (Username: trainee, Password: CyberTraining1!)
2. Run C:\Users\trainee\Desktop\Malware\msg.exe.
3. Analyze file statically/dynamically (use tools like ProcMon, Process Explorer, Autoruns).

---

## 9. Command-and-Control Mechanism, Timeline, and Analysis

**Workflow:**  
These sections are more descriptive, but involve using forensic tools/processes to:
- Examine C2 indicators (network connections, registry entries, processes).
- Build timelines using file and event timestamps.

---

# Summary Table of Key Commands/Filters

| Command/Filter                                                                            | Explanation                                                                             |
|-------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| `param(...)`                                                                              | PowerShell script parameters                                                            |
| `Import-Module ActiveDirectory`                                                           | Loads AD cmdlets                                                                        |
| `Resolve-DnsName $ComputerName`                                                           | Resolves computer name to IP                                                            |
| `Invoke-Command ... Register-ScheduledTask ...`                                           | Schedules network disable task on remote host                                           |
| `Remove-Computer ... -UnjoinDomainCredential ... -WorkgroupName ... -Force`               | Removes host from AD domain                                                             |
| `plink -ssh ...`                                                                          | SSH tool for router config                                                              |
| `/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper ...`                                             | Vyatta router/firewall config                                                           |
| `Add-Computer ... -DomainName ... -Credential ... -Restart -Force`                        | Adds host to domain, restarts                                                           |
| `Enable-NetAdapter ...`                                                                   | Enables network adapter                                                                 |
| `get-eventlog -list; get-service "ev*" | sort-object status`                                | Lists event logs and event-related services                                             |
| `start-service -name "ServiceName"`                                                       | Starts a stopped service                                                                |
| `services.msc`                                                                            | Opens Services management GUI                                                           |
| `event.code: 1102 or event.code: 104 or event.code: 517` (Kibana/Elastic)                | Finds log-clear events                                                                  |
| `destination.port exists`                                                                 | Filters logs to those with a destination port                                           |
| `event.dataset.keyword :* exe`                                                            | Finds logs related to executables                                                       |
| `event.provider : Microsoft-Windows-Sysmon`                                               | Filters for Sysmon logs                                                                 |
| `event.action: "Process Create (rule: processCreate)" and process.command_line: "powershell"` | Finds process creation events launched by PowerShell                                    |

---

If you need any section expanded or a specific filter/command explained in more depth, just let me know!



####################################################################################################################################### MOD 28


Here’s a comprehensive extraction of all workflow steps from dumpdump.md, followed by explanations for each command and filter mentioned in those workflows.

---

## Extracted Workflow Steps and Command/Filter Explanations

### 1. Identify the Malware for Analysis (Volatility)

#### Workflow Steps

1. Open the Virtual Machine (VM) cuckoo.  
   **Credentials:** Username: trainee, Password: CyberTraining1!
2. Open the desktop folder Lab1, right-click and select Open in Terminal.
3. Run the command:
   ```
   volatility imageinfo -f Lab1.vmem
   ```
   _Find the profile for the memory capture._
4. Run:
   ```
   volatility pstree -f Lab1.vmem --profile=WinXPSP2x64
   ```
   _Analyze running processes._
5. Run:
   ```
   volatility connscan -f Lab1.vmem --profile=WinXPSP2x64
   ```
   _View open network connections._

#### Command Explanations

- **volatility imageinfo -f Lab1.vmem**  
  Identifies the correct profile needed to analyze the memory image (Lab1.vmem).
- **volatility pstree -f Lab1.vmem --profile=WinXPSP2x64**  
  Lists processes as a tree structure from the memory image using the specified profile.
- **volatility connscan -f Lab1.vmem --profile=WinXPSP2x64**  
  Scans for network connections that were active at the time of the memory capture.

---

### 2. Extract the Malware and Make It Available (Autopsy)

#### Workflow Steps

1. Open web browser, go to localhost:9999/autopsy.
2. Select New Case.
3. Enter "toteslegit" in Case Name, select New Case.
4. Select Add Host.
5. Select Add Host.
6. Select Add Image.
7. Select Add Image File.
8. Enter `/home/trainee/Desktop/Lab1/Lab1.E01` in Location, leave Type as Disk, Import Method as Symlink.
9. Select Next.
10. Select Add.
11. Select OK.
12. Select the radio button next to C:/, select Analyze.
13. Select File Analysis.
14. Enter "toteslegit" in File Name search.
15. Select the malicious executable to view contents.
16. Select Export, then Save File to disk.

---

### 3. Analyze the Malware (Cuckoo Sandbox)

#### Workflow Steps

1. Open browser, go to localhost:8080.
2. In Cuckoo interface, select Submit a file for analysis.
3. In dialog, go to Downloads and select the malicious file.
4. Click Analyze.
5. Wait for status to change to Reported.
6. Click file name to see analysis results.
7. Review Signature findings and Behavioral Analysis tabs for details.

---

### 4. Find a Phishing Email Attack Entry Point

#### Workflow Steps

1. Open desktop folder Lab2, right-click, Open in Terminal.
2. Run:
   ```
   volatility imageinfo -f Lab2.vmem
   ```
   _Find the profile._
3. Run:
   ```
   volatility -f Lab2.vmem --profile=WinXPSP2x64 filescan | grep important
   ```
   _Locate email file in memory._
4. Run:
   ```
   sudo volatility -f Lab2.vmem --profile=WinXPSP2x64 dumpfiles -Q 0x0000000002ea3720 -n -D /home/trainee/Desktop/Lab2
   ```
   _Extract the email from memory._
5. Run:
   ```
   strings 'file.None.0xfffffadfe74e7cf0.important!.eml.dat'
   ```
   _View extracted email contents._

#### Command Explanations

- **filescan** — Scans for file objects in memory.
- **grep important** — Filters files with "important" in the name.
- **dumpfiles** — Extracts the file from memory using its offset (`-Q`).
- **strings** — Displays printable strings from the extracted file.

---

### 5. Find a Drive-By Download Attack Entry Point

#### Workflow Steps

1. Open desktop folder Lab3, Open in Terminal.
2. Run:
   ```
   volatility imageinfo -f Lab3.vmem
   ```
3. Run:
   ```
   volatility -f Lab3.vmem --profile=WinXPSP2x64 pslist
   ```
   _Check running processes._
4. Run:
   ```
   volatility -f Lab3.vmem --profile=WinXPSP2x64 iehistory
   ```
   _Check Internet Explorer history._

#### Command Explanations

- **pslist** — Lists processes from the memory image.
- **iehistory** — Extracts Internet Explorer browser history from memory.

---

### 6. Identify the Scope (Elastic/Kibana)

#### Workflow Steps

1. Log in to VM cuckoo-hunt (Username: trainee, Password: CyberTraining1!).
2. Open Firefox, go to https://199.63.64.92/.
3. Log in to Security Onion (Username: trainee@jdmss.lan, Password: CyberTraining1!).
4. Select Kibana.
5. Set Time Range to Feb 7 2023, 13:30–13:50.
6. Enter filter:  
   ```
   user.name: tammy.wall
   ```
   _Find logs for user._
7. Select Destination IP field to see top IPs.
8. Add IP 104.53.222.103 as filter.
9. Examine connection log details.
10. Remove filter, apply:
    ```
    agent.type: winlogbeat AND 104.53.222.103
    ```
    _See all logs with this IP._
11. Apply:
    ```
    agent.type: winlogbeat AND “stream-installer.exe”
    ```
    _See all logs with this executable._
12. Expand logs, identify Destination and Host IPs.
13. Identify IP for eng-wkstn-3.
14. Use filter file.target and select Visualize.
15. Back to Kibana discover page.
16. Enter:
    ```
    agent.type: winlogbeat AND “stream-update.exe”
    ```
    _Search for more malware activity._
17. Analyze search results, select destination.ip to view addresses.
18. Select host.ip filter for connected devices.

#### Filter Explanations

- **user.name: tammy.wall** — Filter logs by this user.
- **agent.type: winlogbeat AND 104.53.222.103** — Show logs from Winlogbeat agent involving this IP.
- **agent.type: winlogbeat AND "stream-installer.exe"** — Logs for the specific executable.
- **file.target** — Filter for specific file targets.
- **destination.ip** and **host.ip** — Show top destination and host IPs for activity.

---

### 7. Gather Threat Intelligence (Volatility & Cuckoo)

#### Workflow Steps

1. Log in to cuckoo-hunt VM (Username: trainee, Password: CyberTraining1!).
2. Right-click Evidence folder, Open in Terminal.
3. Use `imageinfo` (output provided), profile is Win10x64_14393.
4. Run:
   ```
   vol.py psscan -f memdump.mem --profile=Win10x64_14393
   ```
   _Find processes._
5. Search output for stream-update and stream-install processes.
6. Identify their PIDs.
7. Run:
   ```
   vol.py cmdline -p <PID> -f memdump.mem --profile=Win10x64_14393
   ```
   _See command line for each process._
9. Extract process:
   ```
   vol.py procdump -p 4328 -u -f memdump.mem --profile=Win10x64_14393 --dump-dir=Extracts/
   ```
10. In Terminal, run:
    ```
    cuckoo web
    ```
11. Open Firefox, go to localhost:8000.
12. Submit extracted executable for analysis.
13. Select Analyze.
15. Review analysis summary and threat score.
17. Repeat analysis for stream-update.exe.

#### Command Explanations

- **psscan** — Scans for process objects in memory.
- **cmdline** — Displays command-line arguments for specified PID.
- **procdump** — Dumps process executable from memory.
- **cuckoo web** — Launches Cuckoo Sandbox web interface.

---

### 8. Analyze a Compromised Virtual Machine (win-admin-2)

#### Workflow Steps

1. Log in to VM win-admin-2 (Username: Trainee, Password: CyberTraining1!).
2. Analyze VM and identify artifacts.  
   _Artifacts include malicious files, hidden folders, and security settings._

---

### 9. Eradicate Threats

#### Workflow Steps

1. Log in to win-admin-2 VM.
2. Delete dc.exe and DarkComet-RAT-5.3.1-master directory.
3. Set Windows Defender SmartScreen "Check apps and files" to On.
4. Set "Enable Remote Desktop" to Off.

---

### 10. Aid Recovery with Sysinternals

#### Workflow Steps

1. Log in to win-admin-2 VM.
2. Access Sysinternals at C:\Users\trainee\Desktop\SysinternalsSuite.
3. Open Autoruns64, let it scan for 3 minutes.
4. Review Autoruns data for DarkComet and associated .exe files.

---

### 11. Return from Isolation (win-admin-3 and win-admin-4)

#### Workflow Steps (win-admin-3)

1. Log in to win-admin-3 VM.
2. Review and validate security baseline for removal of adversarial presence.

#### Workflow Steps (win-admin-4)

1. Log in to win-admin-4 VM.
2. Review and validate security baseline for removal of adversarial presence.

---

### 12. Post-Exploit Recovery Errors

#### Error Discovery Steps

- Use Process Explorer (procexp64) to filter for Lazr.exe.
- Use Autoruns64 to check for scheduled task StartIT associated with Lazr.exe.

---

## Summary of Commands and Filters Used

- **volatility imageinfo** — Profile identification for memory.
- **volatility pstree/pslist/psscan** — Process analysis.
- **volatility connscan** — Network connection extraction from memory.
- **volatility filescan/dumpfiles** — Locating and extracting files from memory.
- **volatility iehistory** — Browser history from memory.
- **strings** — Extract readable text from files.
- **Kibana filters** — user.name, agent.type, file.target, destination.ip, host.ip for log/event filtering.
- **vol.py cmdline/procdump** — Command line and process memory extraction.
- **cuckoo web** — Start Cuckoo Sandbox interface.
- **Sysinternals Autoruns/Process Explorer** — Check for persistence and running malware.
- **Windows Defender/Remote Desktop settings** — Security hardening steps.

---

If you want a more detailed explanation of any specific command, filter, or workflow, let me know!


################################################################################################################## MOD 29


Here are all the workflow steps from the dumpdump.md file, along with explanations for any commands and filters mentioned:

---

## 1. Scan ICS Networks (Zenmap/Nmap)

**Workflow Steps:**

1. Open a console session to the Virtual Machine (VM) hmi-1.
2. Open the VM win-hunt. The login credentials are as follows:  
   Username: trainee  
   Password: CyberTraining1!
3. Open Zenmap by selecting the Nmap - Zenmap GUI desktop shortcut.
4. Select the drop-down arrow for the Target field, and select the pre-populated address ranges.
5. Select Scan.
6. Select the Topology tab for a high-level visualization of node distribution based on the traceroute feature of Nmap.
7. Close the Zenmap console by selecting the X in the upper right corner and selecting Close anyway when prompted.
8. Return to the VM hmi-1 console session.

**Commands/Filters Explanation:**

- **Zenmap/Nmap Scan:**  
  The scan profile performs a full TCP connect scan against a subset of ports typical to ICS networks. The "Target" field in Zenmap selects which hosts or networks to scan, and the Command field (auto-updated) shows the exact Nmap command.
- **Topology Tab:**  
  This uses traceroute data from the scan to graphically represent network node relationships.

---

## 2. Passive Enumeration of ICS Networks (GRASSMARLIN)

**Workflow Steps:**

1. Open GRASSMARLIN by selecting the GrassMarlin shortcut on the desktop.
2. Select File > Open Session.
3. Select Documents > OT Network Map.gm3, and select Open.
4. From the toolbar, select Packet Capture > Manage Networks.
5. Remove the existing network definitions by selecting the Classless Inter-Domain Routing (CIDR) blocks and selecting the Delete key on the keyboard.
6. In the Add CIDR field, enter the first CIDR block of 172.16.80.0/29, and select the Add CIDR button.
7. Repeat the previous step to add the following CIDR blocks:  
   - 172.16.80.8/29  
   - 172.16.80.16/28  
   - 172.16.79.32/29
8. Select Finish to complete the process.
9. In the left pane, select the drop-down arrow to the left of the 172.16.80.0/29 subnet. Right-click 172.16.80.2, and select View Details for 172.16.80.2.
10. Resize the Node Details window that appears so that the device attributes are visible.
11. Close the Node Details window.
12. Select the drop-down arrow to the left of the 172.16.80.8/29 subnet. Right-click 172.16.80.10, and select View Details for 172.16.80.10.
13. After resizing the window, view the device attributes. In this case, the device category has been properly identified as a PLC.

**Commands/Filters Explanation:**

- **CIDR Blocks:**  
  CIDR (Classless Inter-Domain Routing) blocks define IP address ranges for network segmentation.
- **View Details:**  
  Allows detailed examination of detected ICS devices, including fingerprinting information.

---

## 3. Control a PLC with Modbus (ModbusPal/ctmodbus)

**Workflow Steps:**

1. Open the Virtual Machine (VM) win-hunt.  
   Username: trainee  
   Password: CyberTraining1!
2. Select the ModbusPal desktop shortcut.
3. Import the PLC simulation project file by selecting the Load button and opening the file PLC_Simulation.xmpp located in C:\users\trainee\Documents.
4. Activate the simulation by selecting the Play button and select Run to start the Modbus server. Select the eye icon to the right of the PLC object to view the PLC settings.
5. Select the Coils tab to view the configured coils.
6. Select the run_ctmodbus.bat desktop icon to open the ctmodbus tool.
7. In the ctmodbus terminal, run the help command.
8. Run the following command to open a session with the Modbus simulator:  
   `connect tcp 127.0.0.1:502`
9. Once connected, press Enter to acknowledge the message.
10. Run the following command to read the values for the first five holding registers on the PLC:  
    `read holdingRegisters 0-4`
11. Compare the output from the read holdingRegisters command to the holding registers displayed in the PLC.
12. Run the following command to read the first two coil values on the PLC:  
    `read coils 0-1`
13. Run the following command to increase the MaxVoltage holding register value to 240 V:  
    `write register 3 240`
14. Run the following command to configure the PLC’s OutputVoltage to 220 V:  
    `write register 1 220`
15. Run the following command to turn on the safety override:  
    `write coil 1 1`

**Commands/Filters Explanation:**

- **connect tcp 127.0.0.1:502**  
  Connects ctmodbus to the Modbus server running locally on port 502 (the default Modbus TCP port).
- **read holdingRegisters 0-4**  
  Reads the values from holding registers 0 through 4.
- **read coils 0-1**  
  Reads the state (on/off) of coils 0 and 1.
- **write register [address] [value]**  
  Writes a specified value to a holding register at the given address.
- **write coil [address] [value]**  
  Writes a value (typically 0 or 1) to a coil at the given address.
- **help**  
  Lists available ctmodbus commands and their descriptions.

---

## 4. IR Practices and ICS Systems, Part 1 (GRASSMARLIN)

**Workflow Steps:**

1. Log in to the Virtual Machine (VM) win-hunt with the following credentials:  
   Username: trainee  
   Password: CyberTraining1!
2. Select the GrassMarlin shortcut on the Desktop.
3. Select File, and then select Open Session.
4. Select baseline.gm3 from the Desktop/Case folder, and then select Open.
5. Open the post_exploit.gm3 file by repeating Step 3 and Step 4. Select No when prompted to save the current file.
6. Compare the baseline and post_exploit environments to answer the following questions.

**Commands/Filters Explanation:**

- **Open Session:**  
  Loads previously captured network traffic for analysis and comparison.

---

## 5. IR Practices and ICS Systems, Part 2 (Sysmon/Event Viewer)

**Workflow Steps:**

1. Log in to the VM win-hunt with the following credentials:  
   Username: trainee  
   Password: CyberTraining1!
2. If open, close GRASSMARLIN. Select Close, and then select No when prompted to save changes.
3. Navigate to the Desktop/Case/Logs directory and open sysmon.evtx in Windows Event Viewer.
4. Select the Date and Time column header to sort the events from oldest to newest. Navigate to the first event.
5. Select the Find icon in the Action pane.
6. Enter the following destination IP address:  
   `172.16.4.20`
7. Select Find Next.
8. Click Close on the Find dialog box.

**Commands/Filters Explanation:**

- **sysmon.evtx:**  
  Windows Event Viewer log file for Sysmon (System Monitor), which logs process creation, file creation, and network connections.
- **Find (with destination IP):**  
  Filters the logs to show only events involving network connections to the specified IP address.
- **Sort by Date and Time:**  
  Orders events chronologically for easier investigation.

---

If you need more detail about any specific workflow or command, let me know!


################################################################################################# MOD 30


Here are all the workflow steps pulled out from the file, organized by section. After each workflow, you'll find explanations for any commands or filters mentioned.

---

## 1. **Analyzing IR Script Functionality Workflow**
### Steps:
1. Open the Virtual Machine (VM) lin-hunt-cent. The login credentials are as follows:  
   **Username:** trainee  
   **Password:** CyberTraining1!
2. Locate the Python scripts by navigating to `/home/trainee/Desktop/Scripts`.
3. Analyze the scripts in the folder to assess their functionality. Examine the script code and run the scripts in a terminal window to make the assessment.
4. Use this workflow to answer the following questions.

**Explanation:**  
- **Navigating:**  
  - `cd /home/trainee/Desktop/Scripts` changes directory to where the scripts are stored.
- **Running scripts:**  
  - You run Python scripts in the terminal, e.g., `python scriptname.py` or `./scriptname.py` if executable.
---

## 2. **Modify a Python Script to Increase Automation Capability Workflow**
### Steps:
1. Open the VM lin-hunt-cent. Login as before.
2. Launch a terminal, navigate to `/home/trainee/Desktop/Scripts`.
3. To prepare for script modification, make a copy of the original `script3.py` file:  
   `cp script3.py checkprocs.py`
4. Open the new `checkprocs.py` script in an editor, and modify the script to remove user interaction and iterate over all processes. Comment out all code from line 22 to 31.
5. Insert the following five lines of code, starting at line 32:
   ```python
   for subdir in os.listdir('/proc'):
       if subdir.isdigit():
           proc_id = int(subdir)
       else:
           continue
   ```
6. Save the script and test the modifications by executing:  
   `sudo ./checkprocs.py`  
   **Note:** Use the sudo password CyberTraining1!

**Later Steps (Detect deleted executables):**
1. From the terminal, make a copy of the sleep binary and execute it in the background:  
   `cp /usr/bin/sleep /tmp/testsleep`  
   `/tmp/testsleep 9999999 &`
2. Run `script3.py`, enter the PID, observe output, delete the binary, and rerun:
   ```bash
   sudo ./script3.py
   rm -f /tmp/testsleep
   sudo ./script3.py
   ```
3. Modify fourth line from end:  
   `if pid_info and pid_info["exe"].split()[-1] == "(deleted)":`
4. Comment out the final two lines of code.
5. Save and rerun:  
   `sudo ./checkprocs.py`

**Explanation:**  
- **cp:** Copies files.  
- **&:** Runs a process in the background.  
- **rm -f:** Force-removes a file.  
- **sudo:** Runs a command with superuser privileges.  
- **os.listdir('/proc'):** Lists all entries in `/proc` (process IDs).  
- **subdir.isdigit():** Checks if the directory name is a number (i.e., a process).
---

## 3. **Create an Incident Response Script in Python Workflow**
### Steps:
1. Open VM and login.
2. Navigate to `/home/trainee/Desktop/Scripts`.
3. Open `checkhashes.py` in a text editor.
4. At location MOD1, add:
   ```python
   hash_list_file = sys.argv[1]
   startpath = sys.argv[2]
   ```
5. At MOD2, add:
   ```python
   hash_list = []
   with open(hash_list_file) as fd:
       hash_list = fd.read().splitlines()
   ```
6. At MOD3, add:
   ```python
   for root, d_names, f_names in os.walk(startpath):
       for f in f_names:
           fname = os.path.join(root, f)
           f_hash = md5(fname)
           if f_hash in hash_list:
               print(f_hash, fname)
   ```
7. Save all changes.
8. In the Scripts directory, open a terminal.
9. Execute:
   ```
   ./checkhashes.py ./hash_list.txt /usr/bin
   ./checkhashes.py ./hash_list.txt /usr/sbin
   ```

**Explanation:**  
- **sys.argv:** Command-line arguments in Python.
- **os.walk:** Recursively walks through directories.
- **md5(fname):** Returns the MD5 hash of a file.
- **print(f_hash, fname):** Prints hashes that match known bad hashes.
---

## 4. **Evaluate Incident Response Tasks for Automation Workflow**
### Steps:
1. Launch a terminal window, run:
   `sudo su -`
2. Investigate reports of a bound TCP port 3600:
   ```bash
   netstat -natp
   PID=$(netstat -natp | grep 3600 | awk '{ print $7 }' | cut -d'/' -f1)
   ```
3. View process details:
   ```bash
   ps -ef | grep $PID | grep -v grep
   cd /proc/$PID
   ls -l exe
   ```
4. Navigate to the hidden folder and view contents:
   ```bash
   cd /tmp/...
   ls -l
   ```
5. Identify systemd startup config for the process:
   `ps -o unit= $PID`
6. Show systemd service info:
   `systemctl status display-client`
7. Examine account logon activity:
   `last`

**Explanation:**  
- **sudo su -:** Become root user.
- **netstat -natp:** List network connections; `-n` numeric, `-a` all, `-t` TCP, `-p` process info.
- **grep 3600:** Filters for lines with port 3600.
- **awk '{ print $7 }':** Extracts the 7th column (PID/Program name).
- **cut -d'/' -f1:** Splits on `/`, takes the first part (PID).
- **ps -ef:** Shows all processes.
- **grep -v grep:** Excludes the `grep` process itself from the results.
- **ls -l exe:** Shows the executable for the process.
- **ps -o unit= $PID:** Prints the systemd unit name for a given PID.
- **systemctl status [service]:** Shows status of a systemd service.
- **last:** Lists user login history.
---

## Summary Table

| Workflow Section                                        | Key Commands/Filters                                                                                                                                         |
|---------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Analyzing IR Script Functionality                       | cd, running scripts (python or ./script.py)                                                                                                                  |
| Modify Python Script (Automation, Detect Deleted Exe)   | cp, &, rm -f, sudo, os.listdir, isdigit(), checking for (deleted)                                                                                             |
| Create IR Script (Hash Checker)                         | sys.argv, os.walk, md5(), print(), ./checkhashes.py [args]                                                                                                   |
| Evaluate IR Tasks for Automation                        | sudo su -, netstat -natp, grep, awk, cut, ps -ef, cd /proc/$PID, ls -l exe, ps -o unit= $PID, systemctl status, last                                        |

---

Let me know if you want a deeper explanation of any command, filter, or step!


```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-


import argparse
from datetime import datetime
import psutil
import subprocess

config = {"mem": False, "part": False, "net": False}

parser = argparse.ArgumentParser()
parser.add_argument("-m", "--mem", help="collect mem info", action="store_true")
parser.add_argument("-p", "--part", help="collect part info", action="store_true")
parser.add_argument("-n", "--net", help="collect net info", action="store_true")
args = parser.parse_args()
if args.mem:
    config["mem"] = True
if args.part:
    config["part"] = True
if args.net:
    config["net"] = True

def b_to_GB(bytes):
    gb = bytes/(1024*1024*1024)
    gb = round(gb, 2)
    return gb

with open("/proc/uptime", "r") as f:
    uptime = f.read().split(" ")[0].strip()
uptime = int(float(uptime))
uptime_hours = uptime // 3600
uptime_minutes = (uptime % 3600) // 60
print("[+] System Uptime: " + str(uptime_hours) + ":" + str(uptime_minutes) + " hours")

if config["mem"]:
    print("----------------")

    vmem = psutil.virtual_memory()
    print("[+] Mem present: ", b_to_GB(vmem.total), "Gb")
    print("[+] Available: ", b_to_GB(vmem.available), "Gb")
    print("[+] Used: ", b_to_GB(vmem.used), "Gb (", vmem.percent, "%)")

if config["part"]:
    print("----------------")

    disk_partitions = psutil.disk_partitions()
    for partition in disk_partitions:
        print("[+] Partition Device: ", partition.device)
        print("\t[+] File System: ", partition.fstype)
        print("\t[+] Mountpoint: ", partition.mountpoint)
    
        disk_usage = psutil.disk_usage(partition.mountpoint)
        print("\t[+] Total Disk Space: ", b_to_GB(disk_usage.total), "GB")
        print("\t[+] Free Disk Space: ", b_to_GB(disk_usage.free), "GB")
        print("\t[+] Used Disk Space: ", b_to_GB(disk_usage.used), "GB")
        print("\t[+] Percentage Used: ", disk_usage.percent, "%")

if config["net"]:
    print("----------------")

    Id = subprocess.check_output(['netstat','-nat']).decode('utf-8').split('\n')
    new = []

    for item in Id:
        if "LISTEN" in item or "ESTABLISHED" in item:
            new.append(str(item))
    for i in new:
        print("[+] ", i)

```

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-


import platform
import pwd
import os

print("[+] Node: ", platform.node())
print("[+] Platform: ", platform.platform())

print("==================================================")

shell_user_list = {}
odd_user_list = {}
users = pwd.getpwall()
shells = open("/etc/shells")
for user in users:
    if user.pw_shell in shells.read():
        shell_user_list[user.pw_name] = [user.pw_uid, user.pw_gid, user.pw_shell]
    elif user.pw_shell != "/sbin/nologin":
        odd_user_list[user.pw_name] = [user.pw_uid, user.pw_gid, user.pw_shell]
    shells.seek(0)
shells.close()

for key in shell_user_list:
    print(f"{key} shell access")
    if shell_user_list[key][0] == 0 and key != "root":
        print(f"\t{key} has uid 0")
    if shell_user_list[key][1] == 0 and key != "root":
        print(f"\t{key} has gid 0")
for key in odd_user_list:
    print(f"{key} shell {odd_user_list[key][2]}")
    if odd_user_list[key][0] == 0 and key != "root":
        print(f"\t{key} has uid 0")
    if odd_user_list[key][1] == 0 and key != "root":
        print(f"\t{key} has gid 0")

do_disable = input("Disable any accounts (YES)? ")
if do_disable == "YES":
    acct_list = input("Enter comma-separated list of accounts to disable: ")
    for acct in acct_list.strip().replace(' ', '').split(","):
        print("Disabling:", acct)
        os.system(f"usermod -L {acct}") 
```

```
#!/usr/bin/python3

import os
import subprocess

def pid_check(pid):
    try:
        pid_info = {"cmd": "", "exe": ""}
        fn = f"/proc/{pid}"
        with open(f"{fn}/cmdline") as f:
            pid_info["cmd"] = f.readline().replace("\x00", " ").strip()
        exe_check = subprocess.check_output(["ls", "-l", f"{fn}/exe"], stderr=subprocess.DEVNULL).decode('utf-8').split('\n')
        pid_info["exe"] = exe_check[0].split('>')[-1].strip()
        return pid_info
    except:
        return False

proc_id = 0
pid_info = False

# This is line 21
while proc_id <= 0:
    try:
        proc_id = int(input("Enter process ID to examine (0 to exit): "))
    except:
        pass
    if proc_id == 0:
        exit()

if proc_id > 0:
# This is line 31
    pid_info = pid_check(proc_id)
    if pid_info:
        print(f'[+] PID={proc_id}: CMD="{pid_info["cmd"]}", EXE="{pid_info["exe"]}"')
    else:
        print(f"[+] PID={proc_id}: Could not get info")


```

```
#!/usr/bin/python3

import os
import sys
import hashlib

def md5(f):
    md5_hash = hashlib.md5()
    try:
        with open(f, "rb") as fd:
            for chunk in iter(lambda: fd.read(4096), b""):
                md5_hash.update(chunk)
        return md5_hash.hexdigest()
    except:
        return False

#MOD1: get command line arguments
hash_list_file = sys.argv[1]
startpath = sys.argv[2]

#MOD2: store hashes from file in hash_list
hash_list = []
with open(hash_list_file) as fd:
    hash_list = fd.read().splitlines()

#MOD3: recursively search under startpath, print files matching the hashes
for root, d_names, f_names in os.walk(startpath):
    for f in f_names:
        fname = os.path.join(root, f)
        f_hash = md5(fname)
        if f_hash in hash_list:
            print(f_hash, fname)

```

