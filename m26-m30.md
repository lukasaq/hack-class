
### CDAH-M26L1-NIST 800-61 IR Best Practices ###

NIST 800-61 Overview
Computer security IR is an important component of Information Technology (IT) programs. Establishing a successful IR capability requires effective and efficient planning and resources. NIST 800-61 was enacted to assist organizations in mitigating potential impacts to business operations and assets. The publication provides practical guidance on how to respond to degrading incidents. The guidelines in NIST 800-61 are independent of particular hardware, Operating Systems (OS), protocols, and applications while providing insight on the following: 

Establishing IR capabilities.
Maintaining situational awareness and handling of incidents using the IR lifecycle.


-----------


Incident Response Programs
An established IR plan, policy, and procedure are important to effectively and efficiently handle the task of mitigating a security breach. Rapid response when a security breach occurs is essential to minimize loss or theft of critical information and disruption of services within an organization. The mission partner should create a plan, policy, detailed list of actionable events, and Standard Operating Procedures (SOP) to prepare for an incident. The Cyber Protection Team (CPT) should review and use these documents to assist the mission partner during an IR.
﻿﻿

﻿

The following guidelines created by NIST describe policies, plans, and procedures related to IR:

﻿

Policies
﻿

IR policies differ in implementation, but each should contain variants of the following elements:

Purpose and goals.

Scope (who, what, and when).

Descriptions of possible IRs.

Definitions of team roles, responsibilities, and levels of authority.

Incident rating scale.

Organization chart.

Communication guidelines.

Plans
﻿

A formal, focused, and coordinated approach to responding to incidents can make the difference between a successful and failed event. The plan lays out the necessary resources and management support. A proper plan considers the following elements:

Company mission, objectives, and values.

Consent from leadership.

Communication methods. 

Correlation of risk and threat.

Scheduled road map with timeline of events.

SOPs
﻿

Procedures should be based on the IR policy and plan. This includes toolsets implemented, techniques used, and communication practices. These procedures should stem from company goal prioritizations and be used as a training and instructional baseline.

﻿

External Parties
﻿

Organizations often communicate with external parties regarding an incident. While maintaining appropriate OPSEC, the mission partner may find communication with the following parties helpful in mitigating attacks on the network:

Public Affairs office

Legal department

Management

Media

Law enforcement

Internet Service Providers (ISP)

Software vendors

CPT Roles and Responsibilities
﻿

Per Cyber Warfare Publication (CWP) 3-33.4, Cyber Protection Team (CPT) Organization, Functions, and Employment:

﻿

“If MCA [Malicious Cyber Activity] discovery and mitigation exceeds local network operators or local service provider expertise, capabilities, or capability, CPTs may respond to provide support conducting cyberspace defense actions, either remotely or by deploying to the affected location, or a combination thereof. A CPT’s role in reinforcing or augmenting local network defenders resides in the CPT’s execution of approved Joint Mission Essential Tasks (JMETs) by maneuvering dynamically to reconnoiter terrain in networks and systems and validate MRT-C [Mission-Relevant Terrain in Cyberspace] (or KT-C [Key Terrain in Cyberspace] if required) and MCA.”

﻿

NOTE: Bracketed material has been added above to define various acronyms.

﻿

CPTs respond to provide support to a mission partner during an IR scenario to perform four primary functions:

Hunt

Clear

Enable hardening

Assess

﻿<img width="1071" height="636" alt="image" src="https://github.com/user-attachments/assets/fcc16127-9154-4810-af35-e3ff928d7217" />
<img width="1125" height="630" alt="image" src="https://github.com/user-attachments/assets/b2a0afb1-fe35-4f44-9203-c5c763a37979" />
<img width="1079" height="658" alt="image" src="https://github.com/user-attachments/assets/1968712a-aae0-428f-8324-064cfea87484" />

-----------



Phases of the IR Lifecycle
The IR lifecycle consists of four phases, shown in Figure 26.1-1. The initial phase, Preparation, consists of establishing a trained CPT and analyzing available equipment within the Joint Deployable Mission Support System (JDMSS) kit based on locally protected network or system configurations. This is done to determine necessary hardware and applications based on mission scope and scale. Also, a set of controls based on the results of risk assessments is implemented to attempt to limit the number of incidents; residual risk persists after controls are inherited. The second phase, Detection and Analysis, is necessary to alert the organization about any incident that occurs. In the third phase, the incident can be eradicated by containing it and ultimately recovering from it. The final phase, Post-Incident Activity, consists of a generated report documenting the cause and cost of the incident as well as recommended hardening steps by the CPT to prevent future incidents. 



<img width="2500" height="1253" alt="image" src="https://github.com/user-attachments/assets/67476414-0318-4dd3-8855-630b8d49c623" />


------------------

Preparation
﻿

﻿

Sustaining CPT readiness includes deliberate planning, preparation, execution, and assessment, but CPTs are not intended to replace a supported organization’s local network defenders. Onsite CPTs complete their own Mission Analysis (MA) before determining any actions.

﻿

Per CWP 3-33.4:

﻿

“Once CPT MA is completed, available CPT forces are examined to determine CPT mission accomplishment capability. The scope of the proposed mission and other on-going CPT requirements factor into mission element and crew selection. Specifically, CPT leadership examines the team members’ experience, proficiency, and training levels, as well as administrative readiness status against the number of personnel required to complete the mission as determined during CPT MA. The scope of the terrain and operational-level mission completion date drive the number of personnel required. For example, a critical hunt and clear operation may necessitate twenty-four-hour-a-day coverage over a one week period and require more personnel than an enable hardening or assess mission with a longer completion deadline conducted during normal duty hours only. Once selected, personnel prepare for mission execution.”

﻿

IR methodologies emphasize preparation and ensuring that systems, networks, and applications are sufficiently secure. Preparing to handle and prevent incidents includes the following:

Information gathering: This involves promptly accessing available information, including network diagrams, contact directory, on-call information, network application and technology documentation, network baselines, and hashes of known good files in the mission partner’s network.

Coordination: This involves establishing an IR plan, cementing roles and responsibilities, and demonstrating an effective line of communication between the CPT and mission partner. There should be an issue-tracking system, smartphones, encrypted software, and a war room, all for the purpose of having secure communication methods on a separate medium from the location of the attack.

Checklists: Actions must be taken quickly during an IR. Checklists provide guidelines on steps to be performed to handle an incident. 

Mitigation plans: This includes determining supplies readily available for restoration and recovery purposes, such as clean laptops for analysis, a sandbox for testing, blank media discs, portable printers, clean OS images, and additional tools needed in conjunction with the CPT JDMSS kit.

---------------


Detection and Analysis
﻿

﻿

Threat-focused hunt operations illuminate known or unknown malicious cyber actors and determine MCA scope and purpose within the mission partner’s protected network or system. Hunting is the process of proactively and iteratively searching through networks to detect evidence of MCA to gain and maintain contact with an adversary and develop the situation. Network defenders and Cyber Security Service Providers (CSSP) should not rely on CPT hunting operations for threat detection. Passive incident detection and threat hunting operations can, and should, be conducted simultaneously. 

﻿

Hunt operations involve active reconnaissance and counter-reconnaissance on the mission partner’s supported network. The steps below correspond to the Preparation and Detection and Analysis phases of an IR lifecycle:

﻿

1. Gain and maintain situational awareness of the MCA.

2. Consult with Subject Matter Experts (SME) to determine methods and intent behind MCA.

3. Engage with mission partner CSSPs to assist with an IR plan.

4. Make a risk mitigation recommendation based on the benefits or consequences of continuing hunt operations versus initiating clear operations.

﻿

Executing proactive hunt operations requires consideration of, but is not limited to, the following:

Constantly evolving attack vectors; methods; or Tactics, Techniques, and Procedures (TTP).

Dwell time.

Risk to mission.

Available intelligence.

Attack Vectors   
﻿

Different types of incidents merit different response strategies. The following vectors provide a basis for defining more specific handling procedures:

External/Removable Media: Attacks from a removable media device, such as a Universal Serial Bus (USB) device or Compact Disc (CD), to execute malicious code on a vulnerable system. 

Attrition: Attacks employing brute force methods to compromise, degrade, or destroy  networks, systems, and services.

Web: Attacks executed from a website or web-based application (for example, Cross-Site Scripting [XSS] attacks).

Email: Attacks executed via email messages or attachments. 

Impersonation: Attacks involving the replacement of something benign with malicious intent (for example, Man-in-the-Middle [MitM] attacks, spoofing, Structured Query Language injection [SQLi]). 

Improper Usage: Incidents resulting from violation of organization policies by authorized users (for example, installation of file-sharing software). 

Loss or Theft of Equipment: The loss or theft of a computing device or media used by an organization.

Signs of Incident 
﻿

The most tedious part of an IR process is accurately detecting and assessing possible incidents. This includes determining if an incident has occurred and the type, context, and magnitude of the problem. Signs of incidents fall into two categories: precursors and indicators. Incorporating technologies that can flag malicious activity, such as antivirus software, Intrusion Detection Systems (IDS)/Intrusion Prevention Systems (IPS), and Security Information and Event Management (SIEM), is essential. 

﻿

Precursors
﻿

Precursors are signs of an attack prior to the attack’s occurrence. The best way to mitigate damages from an attack is to stop it before it occurs. If precursors are detected, an incident may be prevented by altering the security posture of the organization. Examples of precursors include the following:

Web server log entries indicate the use of a vulnerability scanner.

An outside notable threat states that the organization will be attacked.

Indicators
﻿

Indicators are signs that an attack is actively occurring against a network. Indicators are relatively common. Examples of indicators include the following:

An IDS alerts a buffer overflow attempt.

Host records display an auditing configuration change in logs.

Application logs display multiple failed login attempts from a remote system.

Analysis
﻿

CPTs should work diligently to analyze and validate each incident following a predefined IR plan. NIST recommends the following to aid in this process:

Create a network profile.

Understand the mission partner’s normal network behavior.

Have a log retention policy.

Correlate potential incidents with multiple network sources.

Keep all host clocks synced.

Create a network knowledge base.

Research information on unusual activity.

Collect additional data using packet sniffers.

Filter out insignificant data. 

Incident Documentation
﻿

All evidence about the status of the incident, such as system events, conversations, and observed changes in files, should be documented. The incident data should be safeguarded, as it contains sensitive information. 

﻿

Incident Prioritization and Notification
﻿

Each time an incident is discovered, a risk-based analysis must be considered and discussed with the appropriate personnel on any further actions that must be taken. Incident analysis can be broken down into three separate impact areas — functional impact, information impact, and recoverability impact — and the levels of threat of each. 

﻿

Functional Impact
﻿

Does the incident impact user productivity or system availability? Table 26.1-1 describes the four threat level categories of functional impact:

﻿
<img width="2500" height="1177" alt="image" src="https://github.com/user-attachments/assets/40ff2ed6-0e67-4e94-b374-ab3523e7e7d5" />


Information Impact


Could the incident result in the release of sensitive company or personal information? Table 26.1-2 describes the four threat level categories of information impact:

<img width="2500" height="1118" alt="image" src="https://github.com/user-attachments/assets/e02c4375-4c16-4f06-99d8-a66b5815bb06" />

Recoverability Impact


If possible, what resources would be required to recover from the incident? Table 26.1-3 describes the four required resource categories of recoverability impact:


<img width="2500" height="1028" alt="image" src="https://github.com/user-attachments/assets/ad2851e0-5527-42a3-ba74-22f501ab02d6" />



-------------------

Containment, Eradication, and Recovery
﻿

﻿

Once the Detection and Analysis phase is handled properly, the following is performed, corresponding to the Containment, Eradication, and Recovery phase as directed or tasked: 

﻿

1. Contain affected systems and networks simultaneously to prevent adversary repositioning.

2. Neutralize and eradicate adversary activities in each network or system.

3. Observe and characterize adversary behavior and TTP to enable follow-on operations (for example, enable hardening).

4. Enable recovery or restoration of affected systems and networks.

﻿

Containment Strategy
﻿

Strategies vary based on the type of incident, and a strategy should be created and documented for each major incident type. Criteria for determining the appropriate strategy include the following:

Potential damage to, and theft of, resources.

Evidence preservation.

Service availability.

Resources and duration needed to implement the strategy and provide an effective solution.

Effectiveness of the strategy.

Evidence Gathering and Handling
﻿

Evidence should be gathered according to procedures that meet all regulations. A detailed log should be kept for all evidence, including the following:

Details on who collected the information.

Where evidence was collected.

When evidence was collected.

Where and how evidence was stored.

Identifying Attackers
﻿

Identification of the attacking host(s) can be a time-consuming and futile process. It can prevent a CPT from achieving the primary goal of minimizing the impact to the mission partner’s network environment. Nevertheless, any information found could aid authorities in the capture or identification of the attacker. Methods for identifying attacking hosts are as follows:

Validating the attacking host’s IP address.

Researching the attacking host online.

Monitoring incident databases.

Monitoring attacker communication channels.

NOTE: When doing online open-source research of attacking hosts, use a non-attributable system while maintaining OPSEC.

﻿

Eradication and Recovery
﻿

Eradication and recovery are done in a phased approach so that remediation steps are prioritized. Eradication is done to eliminate components of the incident, such as deleting malware and disabling breached user accounts. In some cases, eradication is not necessary or is done in tandem with recovery efforts. During recovery, systems are restored to normal operation and hardening actions are initiated on known vulnerabilities to prevent similar incidents in the future. 


-----------

Post-Incident Activity
﻿

﻿

Post-incident activity involves learning and improving based on new threats, improved technology, and lessons learned. After an IR, the network should be in a more secure state. Maintaining a secure state means learning from mistakes and improving security posture, such as developing improved policies and procedures for future incidents. All collected actionable data is to be secured and retained for a period of time specified in record retention policies by the organization for legal proceedings. Post-mortem meetings should be conducted with all parties involved in the IR to contemplate lessons learned (objective and subjective data) during the IR lifecycle. 

﻿

Follow-up reports using collected incident data should be generated. This data can be put back into the risk assessment process, ultimately leading to the selection of additional security controls. The checklist in Table 26.1-4, reproduced from NIST 800-61, provides major steps to be followed in the handling of an incident:

<img width="1962" height="2500" alt="image" src="https://github.com/user-attachments/assets/c39c070b-f477-4d35-8f50-80935e604131" />

<img width="1087" height="650" alt="image" src="https://github.com/user-attachments/assets/d7e5ff0b-b344-4a89-9b07-ad4bc2c2ddac" />


--------------------

NIST Best Practices
Keeping the number of incidents reasonably low to protect the business processes of an organization is imperative. More incidents may occur if security controls are insufficient, and the IR team may be overwhelmed. As a result, slow and incomplete responses by the team may occur, negatively impacting the business process of an organization through more extensive network damage and longer periods of service and unavailability.

﻿

An IR team can play a key role in risk assessment and training by identifying gaps in the security architecture. The following provides an overview of primary recommended practices for securing systems, networks, and applications. 


<img width="2500" height="1194" alt="image" src="https://github.com/user-attachments/assets/aa3fba34-1dd7-47bd-ac66-efcaf8ba7ef5" />

Risk Assessments


Periodic risk assessments should be conducted regularly to identify critical resources within the organization to emphasize monitoring and response activities. An assessment determines what risks are posed by combinations of threats and vulnerabilities to systems and applications. Risks can be mitigated, transferred, or accepted. 


Host Security


All hosts should have auditing enabled and be hardened appropriately using standard configurations. Hosts should be configured to log significant security events and follow the principle of least privilege, granting users only the necessary privileges to complete authorized tasks.


Malware Prevention


Malware protection should be deployed at the host level (for example, server and workstation OS), the application server level, and the application client level. 


User Awareness and Training


Users within an organization should be aware of policies and procedures regarding appropriate use of networks, systems, and applications. By improving user awareness, the frequency of incidents should be reduced. 


----------

Use NIST Best Practices for Incident Response
An Administrator account within the mission partner’s network browsed to a web page that was hosted by a workstation located within the network environment. The Administrator account was present there from Aug 2, 2022 @ 09:20:00.000 to Aug 2, 2022 @ 09:25:00.000. The user downloaded and executed a file that resulted in suspicious activity on the host. 

﻿

For training purposes and resource limitations, a sandbox environment was created and the suspicious file was implanted and replicated on the Host Analyst machine.

﻿

Items of interest include the following:


Created files

Persistence mechanisms

Network activity


Complete the steps in the following lab to investigate the potential MCA and the resulting events using Windows Sysinternals and Kibana. 

﻿

NOTE: In a real event, the primary functions of an IR lifecycle —  Preparation, Detection and Analysis, Containment, Eradication and Recovery, and Post-Incident Activity — are conducted by the IR team.
﻿

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) win-hunt using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

The following steps align with the Preparation and Detection and Analysis phases of an IR lifecycle. 

﻿

2. Open the Process Monitor (Procmon64) shortcut located on the desktop. Select Run, and select Yes. 

﻿

Procmon is part of Windows Sysinternals and records live file system activity, such as process creations and registry changes. 

﻿

3. Minimize Procmon, and return to the desktop. Select Lab1.exe, located on the desktop. 

﻿

4. Close the malware notification:

﻿<img width="1272" height="632" alt="image" src="https://github.com/user-attachments/assets/2033693c-edf1-4a50-ae01-7a16116fa3a4" />


﻿

At this point in a real event, a Clear operation would be in effect, and the host in the mission partner’s network would immediately be contained and quarantined (for example, by disabling the Network Interface Card [NIC]) to prevent the MCA from propagating to other hosts. 


Malware protection should be deployed at the host level (for example, server and workstation OS), the application server level, and the application client level within a network environment. 


5. Return to Procmon. Select Filter on the menu task bar, and select Filter on the drop-down menu. In the Process Monitor Filter window that appears, select Process Name, and enter Lab1.exe as the search term. Select Add and OK. 


<img width="1487" height="852" alt="image" src="https://github.com/user-attachments/assets/fd5bb880-cfbd-452a-9455-99e0fcf13aa4" />


<img width="1180" height="724" alt="image" src="https://github.com/user-attachments/assets/60a3e5af-4f6a-438c-95a4-decec75118da" />

NOTE: If Add is not selected after inputting the filter, a prompt asks to add the filter. 


The events are now filtered to display the MCA. Specific files, connections, or processes that the application is accessing can now be analyzed. 


6. Scroll down the filtered output list, and analyze the results that display interactions with the registry, created file activity, and network connections. 


NOTE: Additional filters can be applied to Procmon, if needed, to assist with the output analysis. 


7. Close Procmon.


8. Open tcpview64, located on the desktop, to further analyze network connections from the MCA. Select Yes to open the application when prompted. 


TCPView displays detailed listings of all Transmission Control Protocol (TCP) and User Datagram Protocol (UDP) endpoints on a system, including local and remote addresses and the state of any TCP connections. 


9. In the TCPView search box, enter Lab1.exe to filter the network connections toward the MCA:  


<img width="1374" height="142" alt="image" src="https://github.com/user-attachments/assets/b8399fee-9966-4734-a2f5-1f1a4b40b3ed" />

The output shows that the application is continuously making connections to a remote IP address over a specific port. 


10. Make a note of the remote IP address and port. 


Another Windows Sysinternals tool, Autoruns, can be used to analyze and detect any persistence mechanisms that malware is using to survive on the infected host. To survive and evolve, malware must outlive a system reboot by creating a persistence mechanism, such as a scheduled task or specific run keys in the registry. 


11. Open Autoruns64, located on the desktop. Select Run to continue. If administrative rights are requested, select Yes.


The tabs located on the taskbar are the areas that Autoruns checks for persistence. 


12. Analyze the returned entries for anomalous activity. Once completed, close Autoruns. 


<img width="2050" height="852" alt="image" src="https://github.com/user-attachments/assets/73f7febe-919c-41ef-bf44-a6da0e9af57e" />


It is evident that the MCA creates a persistence mechanism by creating a specific run key in the registry. 


The Clear operation in an IR lifecycle can move forward, and the Host Analyst can use Kibana to correlate the MCA behavior with Indicators of Compromise (IOC) and TTPs. 


13. To view Sysmon events pertaining to the MCA, open Google Chrome, and select the Security Onion bookmark. Log in using the following credentials:
Username: trainee@jdmss.lan
Password: CyberTraining1!



NOTE: If the warning Your connection is not private appears, select Advanced, and select Proceed to 199.63.64.92 (unsafe). 


14. Set the time period of interest as Aug 2, 2022 @ 09:20:00.000 to Aug 2, 2022 @ 09:25:00.000, and select Update.


15. Analyze the resulting data. 


Look for the infected host(s) in the mission partner’s network, suspicious files that were created, executables run, persistence capabilities, and IPs or ports used for communication.

<img width="2048" height="962" alt="image" src="https://github.com/user-attachments/assets/fe32d915-26e6-4abd-a366-b6f9b765192f" />


Once the critical details of adversary behavior are discovered, Eradication (for example, deleting malware and disabling breached user accounts) and Recovery or Restoration, followed by Hardening actions on the infected host(s) within the mission partner’s network, can be performed. These actions are crucial to restore normal system operations.


Some Hardening actions are as follows: 
Propose network architecture changes to improve security and reduce risk.
Ensure unnecessary services are disabled.
Ensure that the latest patches are installed.
Audit installed software.
Enforce an audit policy.
Enhance security systems and logging.

Assessing post-incident activity is critical to an organization’s security posture, and all hosts should have auditing enabled and be hardened appropriately using standard configurations. Users within an organization should also be aware of policies and procedures regarding appropriate use of networks, systems, and applications and be given only the necessary permissions to conduct tasks. 


By following these procedures and conducting periodic risk assessments regularly to identify critical resources within an organization, the frequency of incidents is reduced. 


Answer the questions that follow. 

<img width="1133" height="694" alt="image" src="https://github.com/user-attachments/assets/76866370-2681-4750-ac77-b194bba9b7a2" />
<img width="1090" height="710" alt="image" src="https://github.com/user-attachments/assets/8c5ce722-69f6-40ca-adf1-931ab14e830d" />
<img width="1043" height="621" alt="image" src="https://github.com/user-attachments/assets/2bae75a0-9bf7-473b-8825-8d2969b96844" />
<img width="1055" height="732" alt="image" src="https://github.com/user-attachments/assets/98c4aa15-bbf2-4e2e-809c-d2f7eaac34a8" />
<img width="1096" height="654" alt="image" src="https://github.com/user-attachments/assets/7947d3b9-100e-42e9-918d-0bdcc1e0d361" />

----------------

IR OPSEC Considerations
OPSEC is the security and risk management process to ensure the protection of details and assets of an organization’s network environment. In IR, OPSEC is required to validate that the mission or operation of a mission partner’s network environment can function without being further compromised by MA, and the assets are not returned to operation until the incident at hand has been fully resolved and malware has been eradicated. 

﻿

Containment, eradication, and recovery methods while prioritizing, securing, and maintaining critical assets within the network environment to reduce the risk of further network compromise must be a primary focus. The most expedient efforts to restore the organizational operations to a minimum operating state must be applied. To reduce the risk of further network compromise, the following must be performed:

Information Gathering: Deployment of additional sensors may provide an adversary with critical information due to undesired monitoring and logging. Containment of infected machines before gathering additional information may be necessary.
Containment: Delaying containment of compromised hosts to gather additional information is risky and is a liability to the mission partner as it allows attacks to continue. Compromised hosts must be isolated and ensure that all affected systems have threats eradicated and capabilities restored before allowing operations to return to a normal state. 
Communication: Coordination with the mission partner is common during planning and up to execution, depending on the mission task. Hunt missions may result in minimal or no communication with the mission partner for OPSEC reasons. The internal team ultimately makes the operational decisions. 
Post-Incident Recovery: Recovery or restoration actions to reestablish security and defenses using verification checklists, as seen in Table 26.1-4, must be performed. In addition, observations must be collected, and security and defenses must be collected in preparation for future Defensive Cyber Operations (DCO). All of this must occur while prioritizing OPSEC. 
﻿
<img width="1144" height="672" alt="image" src="https://github.com/user-attachments/assets/eff04e09-e2e8-4d71-ba41-6dad1092c5c7" />
<img width="1111" height="713" alt="image" src="https://github.com/user-attachments/assets/074390ec-d905-41b8-a4d5-51ca03cc4e8e" />


-----------

### CDAH-M26L2-Identify Critical Systems and Vulnerabilities within Infrastructure ###

Critical Systems
An enterprise network is composed of hardware devices connected together through an intricate series of network links. Every configured device has the possibility of containing vulnerabilities. Network administrators attempt to mitigate the risks associated with these devices, however vast this task may seem. The vulnerabilities these devices emit are a weakness in architecture and provide a potential foothold for an adversary to gain access to a network and perform lateral movement to search for key data or assets. This risk is why cybersecurity teams must establish a complete and accurate view of all the critical systems that are part of a network, then attempt to address each vulnerability.

﻿

The following three tables define common critical network systems and the roles they play in the network. The tables describe why each system is critical and targeted and categorize them as follows:

Network Devices
Constructs
Applications

Network Devices

<img width="856" height="1600" alt="image" src="https://github.com/user-attachments/assets/bd58743f-d0ac-4012-a7f8-7ab1c870b052" />

Constructs

<img width="1600" height="615" alt="image" src="https://github.com/user-attachments/assets/53bc48fb-b4a1-40a4-ba42-b1909559cbd6" />

Applications


<img width="1581" height="1600" alt="image" src="https://github.com/user-attachments/assets/e76876a1-bc30-44bb-9d06-62fb6e9ca8dd" />


<img width="1110" height="599" alt="image" src="https://github.com/user-attachments/assets/b1040abc-1b71-4d42-b341-c086de0b7304" />

<img width="1004" height="638" alt="image" src="https://github.com/user-attachments/assets/c4ce2a8c-d385-4841-a398-62b3e45bcaab" />
<img width="1120" height="628" alt="image" src="https://github.com/user-attachments/assets/971adeb5-900d-4de0-9f3e-db53d4c8319e" />

------------------


Understanding Critical Devices and Associated Risk
Every military operation must follow an Intelligence Preparation of the Operational Environment (IPOE) process. The IPOE requires an analysis of enemy capabilities, possible courses of action, and a detailed analysis of Key Terrains (KT). KT are physical locations that may provide an advantage to an adversary. KTs are easy to identify on a map. Identifying key terrain provides valuable information on where to focus efforts to defend or attack a physical location. 

﻿

The level of analysis required for an IPOE also applies to cyberspace operations. The Joint Publication 3-12, Cyberspace Operations defines the term "cyberspace" as a "global domain within the information environment consisting of the interdependent network of Information Technology (IT) infrastructures, including the Internet, telecommunications networks, computer systems, and embedded processors and controllers." 

 

Key Terrains in Cyberspace (KT-C)
﻿

Cyber terrain is not always directly related to a physical location. Instead, cyber terrain may include physical mediums such as software, Operating Systems (OS), network protocols, virtual personas, and other computing devices. KT-C are considered physical nodes or data that enable or support mission execution. Adversaries may attempt to exploit, compromise, damage, or destroy various elements of KT-C. If an adversary inflicts damage to a particular area of the network or a particular component of infrastructure, the impact on the mission depends on the function of the network area or component. KT-C fall into three tiered categories that are based on the levels of impact any attack has on the Operational Environment (OE). This will be covered in greater detail in the next section. 

﻿

The United States Cyber Command (USCYBERCOM) Operational Guidance, Identification of Mission Relevant Terrain in Cyberspace, provides guidelines for Defensive Cyber Operations (DCO) team members working with cyber terrain. This guide requires the following components when defining cyber terrain, which include both logical and physical components:

KT-C: Any locality or area (physical or logical) where seizure, retention, or other specified degree of control provides a marked advantage in cyberspace to any combatant. 

Mission Relevant Terrain in Cyberspace (MRT-C): All devices, internal/external links, OSs, services, applications, ports, protocols, hardware, and software on servers required to enable the function of a critical asset.

Task Critical Asset (TCA): An asset so critical that its incapacitation or destruction would have a serious, debilitating effect on the ability of one or more Department of Defense (DoD) or Office of the Secretary of Defense (OSD) components to execute the capability or mission-essential task it supports. 

Defense Critical Asset (DCA): An asset so critical to operations in peace, crisis, and war that its incapacitation or destruction would have a serious, debilitating effect on the ability of the DoD to fulfill its missions. TCAs are used to identify DCAs.

Identifying terrain has a direct impact on a Cyber Protection Team (CPT) mission, when performing hunting, clearing, hardening, and assessing operations. After the CPT is assigned a terrain in which to hunt and operate, the threat hunter can filter data based on the types of systems and datasets available. Data requirements are driven by the analysis of potential threat actors that can target the mission partners' networks and the Tactics, Techniques, and Procedures (TTP) they employ. Identifying terrain, in turn, reduces the number of analytics necessary for the team to execute the mission objectives. The threat hunter can also filter for data on the identified MRT-C and KT-C to prioritize the required data collection. 

﻿

Understanding KT-C provides a distinct advantage over the adversary by allowing the analyst to focus on defenses for the network. For example, a Network Analyst knowledgeable of KT-C would be able to foil an adversary from further penetrating the vulnerable network by providing mitigating controls for identified weak security postures resulting from identified vulnerabilities supporting KT-C. CPTs are continually required to adjust and adapt to new adversaries or TTPs as KT-C constantly remains at risk. 

﻿

Critical Tiers
﻿

A network, its supporting infrastructure, and the various integrated applications can be prioritized into three tiers of critical assets, with respect to potential loss or damage severity. Adversaries attempt to compromise various elements of critical assets to exploit, compromise, damage, or destroy the network. Figure 26.2-1, below, describes the three tiers of damage or disturbance impact. If a tier is not assigned, this means the impact is low priority.

﻿
<img width="1667" height="834" alt="image" src="https://github.com/user-attachments/assets/8b5ad438-e92b-4fbb-bc87-b7a7a0f860f6" />


Tier 3 - Medium Priority


Tier 3 covers general data and applications. Compromise of these assets or information makes the organization subject to periods of degraded performance, but it does not destroy or corrupt data or halt business processes. Examples include data or services that, if lost, corrupted, or destroyed, can be recovered or restored with minimal impact on business processes.
 
Tier 2 - High Priority


Tier 2 covers important data and applications. Compromise of these assets or information makes the organization subject to serious damage and interrupts or degrades business processes. Examples include data that, if lost, corrupted, or destroyed, would have a serious impact on the organization or the essential applications or servers critical to that data. 
 
Tier 1 - Critical Priority


Tier 1 covers top value, critical, and essential data, applications, network services, and information processing. Compromise of such assets or information makes the organization subject to exceptionally grave damage and prevents critical business processes. Examples include any asset whose data compromise, corruption, or destruction has a devastating impact on the organization’s applications, critical network infrastructure, or data systems.
In Figure 26.2-2 is an example of a network map reflecting identified critical systems in a network environment and their associated terrain tiers. Table 26.2-4 displays the critical systems and their potential effects of compromise. 

<img width="2048" height="1654" alt="image" src="https://github.com/user-attachments/assets/3ec655fb-ed9d-43a9-912f-e10ef43b8e3a" />
<img width="1271" height="2048" alt="image" src="https://github.com/user-attachments/assets/7cae1cfe-a1a9-4ad8-ac00-6db547e40ac5" />


-----------------

Vulnerability Risk Levels
Vulnerabilities are identified by a Common Vulnerabilities and Exposures (CVE) number. This number generally consists of the four-digit year and a unique number identifier, such as CVE-2000-0001. Each CVE is assigned a score to represent its severity level. This score is based on the Common Vulnerability Scoring System (CVSS), which assigns a number between 0.0 and 10.0, where 10.0 is the most severe. Table 26.2-5, below, describes each level:

<img width="1668" height="1755" alt="image" src="https://github.com/user-attachments/assets/e4bc8764-feca-4f05-941a-467d4011a533" />

After risk levels have been identified, the organization should consider which devices on the network are critical assets of the greatest concern. Identifying these device criticality levels is part of the risk analysis process.


Assigning Risk Based on Risk Levels and Device Criticality


Analyzing the risk associated with a vulnerability and the criticality level of devices on a network provides a way to rank and prioritize risks to the organization. This process is risk analysis, which leads directly into patch prioritization. The risk analysis process shows how organizations identify the highest level of risk. Patches should be prioritized based on this analysis. 


Figure 26.2-3, below, provides a risk matrix for prioritizing vulnerability risk levels. This matrix is an example of the visualization an organization may use to determine the patches to prioritize for implementation, based on the availability of organizational resources. The figure suggests priority levels for associated vulnerabilities and devices using the following patterns and colors:
Minimal: Green, vertical stripes
Low: Yellow, horizontal stripes
Moderate: Orange, narrow diagonal stripes
High: Red, wide diagonal stripes
Extreme: Solid black

<img width="1667" height="834" alt="image" src="https://github.com/user-attachments/assets/74156e43-a43c-4725-a71a-feed77b1738f" />

Organizations may alter this matrix to better fit their businesses. For example, some organizations may consider all high- and critical-level vulnerabilities an extreme priority. Another factor of risk analysis is in determining risk likelihood. Risk likelihood considers the likelihood of a specific risk to occur. For example, on a network with many mitigating controls in place, a critical vulnerability may have such a small likelihood of occurrence that it may not need resources allocated for patching. In a thorough analysis, all risks are compared with the vulnerability level, criticality of the device, and the likelihood of the risk. All of this information factors into how an organization handles risks.


---------------

Common Exploits
Analysts who develop an in-depth understanding of common exploits are better equipped to implement effective defensive measures for securing critical systems from potential Malicious Cyber Activities (MCA). An exploit is any tool or technique that leverages a vulnerability to gain access to networks and systems. Adversaries frequently exploit vulnerabilities that have not been properly addressed. Exploits can either be either local or remote and affect three target groups: clients, web applications, and infrastructure. 

﻿

Local exploits target the system on which they are performed. This is usually a system that an attacker has already accessed. An example is executing the privilege escalation exploit DirtyCOW to gain root access on a system where the attacker already has user-level access. 

﻿

Remote exploits target a system other than the system from which they are performed. An example is EternalBlue, which sends malformed instructions to a remote Server Message Block (SMB) service to gain Remote Code Execution (RCE). A remote exploit is still remote even if it is performed on a localhost or a system where user-level access is already gained. For example, an attacker may gain user-level access to a machine and use that access to turn on SMB before using EternalBlue to elevate to the SYSTEM level account.

﻿

Exploits by Attack Style
﻿

Table 26.2-6, below, lists and explains common types of exploits by their attack style. This table also provides the vulnerabilities that each exploit targets and examples of real life exploits that can be classified under each type.

<img width="1234" height="2048" alt="image" src="https://github.com/user-attachments/assets/ef87500c-6a98-45c4-a440-2c428832665a" />


Exploits by Architecture


Exploits can also be classified by the architecture they target, such as the following:
Clients
Web Applications
Infrastructure
Client Exploits


A client exploit targets an individual machine or software instance. Workstations and software such as File Transfer Protocol (FTP), Java, and web servers may be vulnerable to client exploits. Software that runs on a server and is shared to a network may also be the target of a client exploit, in some cases. For example, if the exploit targets the software explicitly and results in access to the software or an underlying system. Infamous examples of client exploits include the following:
EternalBlue
BlueKeep
DirtyCOW


EternalBlue


EternalBlue (CVE-2017-0144) is a well-known remote exploit targeting the SMB service on Windows computers. The exploit leverages an input validation vulnerability in SMBv1, which was previously enabled by default despite having been superseded by SMBv2 and SMBv3 to support legacy systems. Although the exploit was patched after Windows 10 Version 1507, systems without the proper Windows Patches Knowledge Base (KB) are vulnerable. The attacker sends a specially-crafted packet to the service, which grants RCE. This access is SYSTEM level and represents a total compromise of the system through a vulnerable port such as Transmission Control Protocol (TCP) Port 445. 


BlueKeep


BlueKeep (CVE-2019-0708) is a memory-based remote exploit targeting the Remote Desktop Protocol (RDP) service on Windows 7 computers. The vulnerability exists in a pre-authentication mechanism by which clients negotiate aspects of the connection with the server. By requesting specific connection parameters, heap corruption occurs that allows for remote code execution at the SYSTEM level. Since this occurs pre-authentication, a username and password are not required. SYSTEM level access represents a total compromise of the system.


DirtyCOW


DirtyCOW (CVE-2016-5195) is a local race condition privilege escalation exploit targeting the copy-on-write mechanism in the Linux kernel. Using the right timing, the race condition allows the attacker to use the copy-on-write mechanism to make a non-writable file mapping writable. This file is then modified and compromised before it is executed. If this file runs with a greater privilege level than the user running it, for example, a Set User Identification (SUID) binary, it is used to run commands or other code as root. The most common payloads are commands to spawn a root-level system shell or a Remote Access Trojan (RAT) executed as root. 


Web Application Exploits


A web application is hosted by a server accessible by a web browser. This includes mobile applications that rely on web-based protocols and frameworks such as Hypertext Markup Language version 5 (HTML5), even if the applications are not presented as traditional websites. Web application exploits are different from exploits against web server software, such as Internet Information Services (IIS) or Apache. Exploits against web server software are considered client exploits. Web application exploits target the functionality of a web application through Structured Query Language (SQL) Injections or command injections. Web application exploits often focus on compromising information or gaining initial access to a network. Examples of web application exploits include the following:
Injection
ShellShock


Injection


The term "injection" is a catch-all descriptor for input validation attacks against web applications. The most common injection attacks are SQL injections and command injection, also called code injections or OS injections. An injection attack targets legitimate application functionality. The attack attempts to force the application to run unintended commands by exploiting oversights in the application's validation and sanitization of user-provided input. 


ShellShock


ShellShock (CVE-2014-6271) is a collection of security bugs in the Unix Bash shell that allow for command injection. The attack specifically targets Bash’s function export feature. This feature allows one Bash process to share scripts with the other Bash processes it executes.


Infrastructure Exploits


Infrastructure refers to anything that provides a service to a network. Attackers exploit infrastructure services to impact a broader scale of targets, rather than accessing targets individually. For example, Active Directory (AD) is a core part of Windows infrastructure. Attackers generally exploit AD to compromise or affect an entire network or large sections of a network. Even though an infrastructure exploit may communicate directly with a Domain Controller (DC), this doesn't mean the DC, itself, is the ultimate target. Other potential targets include services such as a Domain Name System (DNS), Dynamic Host Control Protocol (DHCP), and Link-Local Multicast Name Resolution (LLMNR). Some examples of infrastructure exploits include the following: 
Kerberoasting
SIGRed
Kerberoasting


Kerberos is an authentication service that relies on a ticketing system. A Service Principal Name (SPN) identifies Windows services. To enable authentication with Kerberos, each SPN must associate with a service account. A service account is an account specifically tasked with running a specific service. These accounts often inherently have high privilege levels because their services require it. 


To use these services, users request Ticket-Granting Service (TGS) tickets that allow them to use the service account to temporarily leverage a service. These TGS tickets use Rivest Cipher 4 (RC4) encryption. RC4 uses the service account’s hash as the private key for the encryption. The attacker downloads and saves these tickets as a file to brute force the hash offline. This hash then authenticates as the associated account. It is often trivial for attackers to compromise the Domain Administrator (DA) account or an entire network due to the privilege level of these service accounts.


SIGRed


SIGRed (CVE-2020-1350) is a memory-based exploit targeting the Windows DNS service WinDNS. In this exploit, an attacker sends requests to the victim's DNS server. The request is forwarded and resolved to a DNS server that the attacker controls. The victim DNS server then essentially becomes a client that the attacker forces to communicate with their server at any time. 


Due to a flaw in the way DNS handles overly large DNS packets, a specially-crafted packet has the capability to cause a heap-based overflow, resulting in RCE. Any payload delivered runs as the local SYSTEM account of the machine running the DNS server. This process generally results in a complete network compromise, due to the DNS and the privilege level of its service account.
<img width="1087" height="638" alt="image" src="https://github.com/user-attachments/assets/dd387dfa-ec77-408e-95f6-4120f8a8322b" />
<img width="1081" height="607" alt="image" src="https://github.com/user-attachments/assets/167c6f37-9c5f-4ce0-8a8a-67a10ee6a218" />


-----------------

Identify Vulnerabilities
In the following scenario, a Cyber Defense Analyst (CDA) is assisting a mission partner with prioritizing vulnerabilities associated with their critical IT infrastructure within the network environment. A network scan of the mission partner's network environment has been conducted using Assured Compliance Assessment Solution (ACAS). Multiple vulnerabilities were detected, placing critical IT infrastructure at risk to MCA. 

﻿

Identify Infrastructure Vulnerabilities
﻿

Use ACAS and the conducted scan to prioritize the critical IT infrastructure vulnerabilities within Elastic Stack. Recommend and mitigate gaps by enabling hardening of the critical IT infrastructure to improve security and reduce risk to MCA.  

﻿

NOTE: The mission partner's network map pinpointing the critical IT infrastructure has been provided as an attachment. 

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) acas using the provided credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open a Firefox web browser and select the bookmark Nessus.

﻿

NOTE: If a warning appears in the browser, select Advanced…, then select Accept the Risk and Continue. If prompted to log in, use the credentials from step 1.

﻿

3. From the left pane of the Nessus dashboard, select My Scans, then select Mission Partner's Network. 

﻿

The network scan of the mission partner's network environment displays numerous vulnerabilities associated with the critical IT infrastructure and their severity. The page for the selected network scan provides the following tabs, displayed in Figure 26.2-4, which provide additional information:

Hosts: Scanned hosts
Vulnerabilities: Vulnerabilities associated with the scanned hosts
Notes: Notes about the scan
VPR Top Threats: Tenable's patented Vulnerability Priority Rating
History: History of scan results initiated on the network

﻿<img width="2048" height="1172" alt="image" src="https://github.com/user-attachments/assets/d7bfc322-4d72-44e0-9a30-531269c56ea1" />


4. Analyze the information presented under the tab Hosts and the provided attachment of the mission partner's network map to accurately pinpoint the hosts that have been scanned for vulnerabilities. 


5. Select the tab Vulnerabilities and analyze the information presented for more specific details regarding each vulnerability. 


6. Select the tab VPR Top Threats analyze the information regarding remediation efforts to effectively reduce risk.


This tab reveals severe flaws in the configuration of the critical IT infrastructure within the mission partner's network environment. These flaws may lead to grave damage to the architecture.


7. Select the vulnerability MS17-010: Security Update for Microsoft Windows SMB Server, as highlighted in Figure 26.2-5, below, to display more information regarding the criticality of this vulnerability.


<img width="2048" height="1094" alt="image" src="https://github.com/user-attachments/assets/42be26f5-ec62-4528-abe3-4fef8128a9c5" />

The information indicates that a single host is affected by MS17-010. This vulnerability allows adversaries to remotely execute arbitrary code and gain access to a network by sending specially-crafted packets. The code exploits a software Input Validation vulnerability in Microsoft's Windows OS SMBv1 protocol that allows access to files on a remote server. Adversaries can compromise the entire network through the host and all devices connected to the host, making remediation efforts difficult. This exploit is also known as EternalBlue. Other ransomware such as WannaCry can also take advantage of this exploit. 

-------------------


Prioritize Vulnerabilities With Elastic Stack
In this scenario, the mission partner states that there has been network traffic present within the network regarding the vulnerability MS17-010 from Sep 22, 2022 @ 10:00:00.000 to Sep 22, 2022 @ 13:00:00.000. 

﻿

Prioritize Critical IT Infrastructure Vulnerabilities with Elastic Stack
﻿

Use Elastic Stack to prioritize the mission partner's critical IT infrastructure for the vulnerability.

﻿
﻿

Workflow
﻿

1. Log in to the VM kali-hunt using the provided credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open a Firefox web browser from the desktop and select the bookmark Security Onion. 

﻿

NOTE: If prompted for credentials, log in with the following, then select the bookmark, again:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

3. Select the hamburger menu at the top left, then select Kibana in the section Tools.

﻿

This displays the Security Onion - Home Dashboard.

﻿

4. Select Alert under Event Category in the pane Security Onion - Navigation, as displayed in Figure 26.2-6, below:


<img width="2048" height="1071" alt="image" src="https://github.com/user-attachments/assets/10a04505-de24-4546-9b47-6a2acc5bd2a3" />


5. In the field highlighted in Figure 26.2-7, below, set the time period from Sep 22, 2022 @ 10:00:00.000 to Sep 22, 2022 @ 13:00:00.000, then select Refresh

<img width="2048" height="1058" alt="image" src="https://github.com/user-attachments/assets/26717b62-3f4a-4cbb-8586-667531f52a84" />


Network data associated with the critical IT infrastructure within the mission partner's network environment has been logged and the severe vulnerabilities can be identified and analyzed. 


Modern instances of SMB use TCP port 445 for direct host-to-host communication in the client-server model. SMB port 139 is used along with Network Basic Input/Output System (NetBIOS) name resolution — requiring NetBIOS ports for resolution — to perform the same operation. In the case of the vulnerability MS17-010, adversaries can leverage SMBv1 and TCP port 445 to propagate malware and perform lateral movements in the network. After the initial SMB handshake, an administrative share on the remote machine can be compromised. 


Forming a Kibana Query Language (KQL) query and using filters can help detect the use of the SMB protocol.


6. To analyze events using port 445, add the following filter then select Refresh:
destination.port: 445 



As displayed in Figure 26.2-8, below, this returns 283 events that pertain to the usage of port 445. By analyzing the returned data, there are rules and highly critical events pertaining to SMB usage within the mission partner's network. 

<img width="2048" height="1379" alt="image" src="https://github.com/user-attachments/assets/22572fe2-a1f7-464a-bd4d-2c29b5ee615c" />


7. To allocate SMB usage along with the exploit MS17-010, apply the following rules to the search:
event.severity_label.keyword: high AND
rule.name.keyword: ET EXPLOIT Possible ETERNALBLUE Probe MS17-010 (MSF style)



Another way to complete step 7 is by selecting + next to the rule under the pane Security Onion - Rule - Name.


8. Scroll down to the pane Security Onion - All Logs and analyze the fields destination.ip and message in the log @ 12:33:11.272.


The results displayed in Figure 26.2-9, below, indicate the SMBv1 on the vulnerable host in the mission partner's network has been exploited

<img width="2048" height="388" alt="image" src="https://github.com/user-attachments/assets/3510e2e0-e43e-4f9d-aed6-d65983621bfd" />


9. Remove the previous filter rule and replace it with the following rule:
rule.name.keyword: ET POLICY Powershell Activity Over SMB - Likely Lateral Movement



Another way to complete step 9 is by selecting + next to the rule under the pane Security Onion - Rule - Name.

<img width="2048" height="338" alt="image" src="https://github.com/user-attachments/assets/ba3e5a4a-67f9-40c1-817d-4758695fe1a4" />


10. Scroll down to the Security Onion - All Logs pane and analyze the field message in the log @ 12:59:40.698.


As displayed in Figure 26.2-11, below, a connection was made to a share other than IPC$. Further analysis of the situation is required to discover whether any data has been compromised. 

<img width="2048" height="280" alt="image" src="https://github.com/user-attachments/assets/90ed70ea-c833-4d64-bf6d-075c8509f884" />

Considering the mission partner's network is vulnerable to SMBv1 attacks, all hosts infected need to be disconnected from the network to be assessed further. Analysts must then clear current MCA and conduct hardening to prevent future risks before moving on to the post-incident activity. The following are possible hardening actions that may apply:
Ensure unnecessary services are disabled.
Ensure the latest patches are installed.
Remediate insecure configurations.
Audit installed software.
Enforce an audit policy.
Enhance security systems and logging.
<img width="1914" height="759" alt="image" src="https://github.com/user-attachments/assets/ad4ff979-7f9f-420f-99fc-6e3238443af4" />
<img width="1864" height="794" alt="image" src="https://github.com/user-attachments/assets/47d157f9-fdc6-4fd7-91c1-64e726fc9c4e" />

<img width="1097" height="528" alt="image" src="https://github.com/user-attachments/assets/334837c4-03a4-4f72-87e1-d360e0dae535" />
<img width="1903" height="765" alt="image" src="https://github.com/user-attachments/assets/b8de632e-4b72-4364-85db-548649606320" />

<img width="1121" height="685" alt="image" src="https://github.com/user-attachments/assets/1da7868d-b77f-436f-b8aa-8c388d65d09a" />
<img width="946" height="293" alt="image" src="https://github.com/user-attachments/assets/f5ee4d6b-1d57-4b26-852e-cca1f1d5c85d" />

<img width="1078" height="672" alt="image" src="https://github.com/user-attachments/assets/736d3f49-1aeb-4fb2-833c-e736a0f4b9e2" />




--------------

### CDAH-M26L3-Responding in an OT Environment ###

Operational Technology
In securing computer networks, most devices in a network are associated with IT. This includes devices for storing, transferring, and securing data. However, other network devices must be considered when securing networks. These devices, known as Industrial Control Systems (ICS), control heavy factory machinery and measurement capabilities. Security considerations for these OT devices differ from IT network devices, as the OT devices keep machines running at all times. 

﻿

Industry Impact
﻿

All industries need OT, and attacks on ICSs have varying impacts, depending on the industry being attacked and the versatility of these systems. Examples of the most highly impacted industries are as follows:


Automobile factories
Chemical processing
Construction
Food production
Manufacturing
Nuclear
Oil/gas
Power/utilities
Transportation
Waste management
Water treatment

Severe repercussions are possible for both IT and OT in the event of a network attack, as Table 26.3-1 shows: 


<img width="1667" height="531" alt="image" src="https://github.com/user-attachments/assets/91e77ad9-1395-4f07-9417-c52c6ccc271d" />


OT systems are used invasively in each industry to have efficient automation of processes and safety. Many of these industries are dangerous to humans but can be managed through the use of mechanical robots controlled with OT. Such robots usually cannot have any productional downtime and communicate with surrounding technology in unique ways. 


Systems


Common systems have devices working in tandem to perform tasks based on the reading of other devices. Systems used in OT networks are as follows: 

ICSs: ICSs may be composed of one device or thousands. ICSs have interweaving instruments meant to measure and react to those measurements to complete daily activities.
Distributed Control Systems (DCS): In a DCS, the OT that is set up has no administrative controls. It runs on a series of control loops that allows the system to manage itself.
Supervisory Control and Data Acquisition (SCADA): SCADA systems provide a level of administration to OT devices. Through a SCADA system, an engineer can manipulate and control variables on such devices as Programmable Logic Controllers (PLC), as necessary.
Devices


OT devices tend to be built with their sole functions in mind, without much regard to their own security. They work in a network to take measurements and readings or perform functions based on these readings. OT devices are divided into the following classifications. 


Programmable Logic Controllers 


PLCs are simple computers built for industry processes for automation. They are designed to withstand the pressures of intense factory environments. PLCs must function in real time, with an ability to provide prompt communications to their surroundings to control the processes as they are being completed. 


Remote Terminal Units 


Remote Terminal Units (RTU) transmit device telemetry and control signals between equipment and SCADA systems.


Digital Protective Relays, Numerical Relays, Intelligent End Devices 


Digital protective relays, numerical relays, and intelligent end devices are advanced power surge protectors and power regulators.


Phasor Measurement Units 


Phasor Measurement Units (PMU) are voltage and amperage management devices, ensuring that the correct amount and power needs are allotted to the relevant device.


Real-Time Operating Systems


A Real-Time Operating System (RTOS) is a device OS designed to not fluctuate during operation. IT OSs may vary significantly in performance of similar tasks, but OT RTOSs must be predictable and are therefore designed to perform the same function in exactly the same manner and same amount of time during every cycle.


Sensor Networks 


Sensor networks are usually monitor-only telemetry units that report information back to a DCS or SCADA system. For example, a network of temperature sensors for refrigeration does not perform any control functions on the refrigeration system but reports back performance, temperature, and other telemetry data.


Human-Machine Interfaces 


A Human-Machine Interface (HMI) is any device, or part of a device, designed to allow people to interact with a machine. An HMI may be a control panel composed of buttons and a simple screen, or it may be a piece of software that sends commands to equipment over a network.


Operational Technology Network Example


In Figure 26.3-1, the SCADA server, which allows control of the other devices, is managed through the HMI. The SCADA server manages the PLCs’ tasks on the industrial equipment inside the power plant, based on the readings received from the RTU, which receives data from the temperature sensor.



<img width="1667" height="1770" alt="image" src="https://github.com/user-attachments/assets/d26a448c-7f8d-4813-b648-bd96ed883db5" />

<img width="1093" height="643" alt="image" src="https://github.com/user-attachments/assets/afdd674b-0f95-4816-9f1d-b8c768e40269" />
<img width="960" height="593" alt="image" src="https://github.com/user-attachments/assets/c6933dfb-0cba-4727-98ed-94b3440d4057" />
<img width="1053" height="593" alt="image" src="https://github.com/user-attachments/assets/777fa9fc-8225-4d0c-8756-b284d3b2ae84" />


-----------------

Incident Response in Operational Technology
Differences between OT and IT
﻿

Due to the nature of OT ICSs, performing IR in an OT environment requires a different approach from the IT environment. To create the best IR program for OT devices, the differences between OT and IT devices must be understood. Devices perform different roles in the network, and the risks and vulnerabilities they display are vastly different as well.

﻿

Current industrial processes are impossible without networks containing both OT and IT devices. Administrators must interact with both to complete day-to-day functions successfully. The following offers guidance on the differences between IT and OT networks.

﻿

Primary Differences
﻿

OT/ICS assets are often inaccurately compared to IT assets. During an incident, IT and OT/ICS systems have different missions, objectives, and impacts. The primary differences between IT and OT/ICS systems are in six areas, as shown in Figure 26.3-2: security IR, safety, skill sets, system designs, support, and security controls.

﻿

NOTE: Figure 26.3-2 is adapted from a SANS Institute resource, identified in Additional Resources below.


<img width="1667" height="1092" alt="image" src="https://github.com/user-attachments/assets/8fc0acd6-199e-4c06-941f-aa3dd4d20255" />

Figure 26.3-2
Security IR: IT and OT/ICS systems have different devices, missions, objectives, and impacts during an incident. Adversaries targeting ICS must use different attack Tactics, Techniques, and Procedures (TTP) for access, execution, collection, and persistence to degrade safety, manipulate control, and damage physical engineering assets or property. 
Safety: The main goals for OT/ICS systems are not Confidentiality, Integrity, and Availability (CIA), as they are for IT. Rather, the OT/ICS primary goal is safety of personnel, followed by integrity to trust operational commands, availability, and then confidentiality.  
Skill Sets: IT and OT/ICS security teams differ in their unique security skill sets. OT/ICS teams focus on nontraditional systems, protocols, and engineering systems. 
System Designs: OT/ICS systems contain nontraditional computer and legacy systems with industrial and proprietary protocols. 
Support: OT/ICS systems rely on external vendor support. 
Security Controls: Security controls are used to perform different actions, depending on whether they are used within an IT or OT/ICS environment. 


---------------

IT vs. OT Physical Environments
The physical environments of IT and OT networks are different. IT networks are often accessed from an office, whereas OT networks are decentralized and may be located in remote areas, often next to the related OT equipment of the network. Table 26.3-2 provides a list of IT and OT device physical environments and characteristics:

<img width="1667" height="1475" alt="image" src="https://github.com/user-attachments/assets/6f51230c-f682-496a-98fe-d1be00c3ca32" />

-------------------------

Industrial Control System Roles
ICS roles and responsibilities have similarities with IT systems. The subtle differences that are built in warrant consideration during IR.

﻿

Network/System Administrators
﻿

System administrators manage the IT aspect of the ICS systems, interconnecting Transmission Control Protocol/Internet Protocol (TCP/IP) devices, configuring computer systems, and monitoring security. The main focus of IT administrators in an OT environment is to secure the IT equipment that can potentially affect OT operations. 

﻿

Administrators, analysts, and other IT personnel are tasked with managing the servers and workstations that other members of a given organization use daily. Some SCADA systems may be running on Windows or Linux machines that IT manages, but OT equipment rarely falls under general IT purview.

﻿

Operators/Engineers/Technicians
﻿

Operators use the OT systems to manage, monitor, and program the physical processes. Operators include any personnel who require OT equipment to perform their relevant functions. A nurse using vital signs monitors and a factory worker cutting steel beams are both considered operators in an OT environment. Engineers and technicians vary across a wide range of disciplines, and OT software engineers may have some overlap with IT administration and security, but technicians and equipment engineers only manage or repair OT-related equipment.

﻿

Security personnel and analysts likely interact with SCADA- and DCS-related systems rather than controllers and device-level components. Every equipment vendor has different tools for managing updates and administration for devices, and security personnel are tasked with learning all the vendor-specific information needed to secure OT systems.


-----------------

OT/ICS Vulnerability Management
Most OT/ICS components and protocols are sensitive to unexpected or improperly formatted control messages. Use of traditional IT tools, such as vulnerability scanners or port mappers, can cause system instability or even permanent damage. Many OT/ICS devices have only their manufacturer management network port open for communication and are designed only to receive network traffic from their proprietary software. For the sake of availability and operational speed, many standard IT-related communication functions are removed from device controllers, and simple handshakes and remote session requests cause system failure. Because of this, most modern controllers reject all traffic from standard IT devices to maintain stability.

﻿

Some ICS functions, such as HMIs or data historians, can be hosted on traditional enterprise Operating Systems (OS) like Microsoft Windows or Linux. Telemetry data–generating machines like an HMI do not send many instructions to device controllers and, instead, are simply receiving forwarded telemetry data that is then sent upstream to a SCADA system, for example. Traditional IT monitoring and investigation tools, such as PowerShell, Sysinternals, or IR scripts, may not be supported on these devices, however. Such devices rely on passive information-gathering techniques rather than active tools in field networks.


----------------


Incident Response Differences
OT/ICS includes the steps of IT IR: Preparation; Detection and Analysis; Containment, Eradication, and Recovery; and Post-Incident Activity. However, OT/ICS includes additional steps, and each step must be adapted for the safety and reliability of operations that prioritize personnel and the protection of physical assets within the organization. 

﻿

Preparation
Risks: OT risks on the incident-rating scale involve more danger than IT networks, as the machinery being controlled by OT devices can be dangerous.
Roles and responsibilities: Who is responsible for OT devices during an IR?
Stakeholders: Does everyone understand the impact OT devices have on a network?
Communication: If separate IR teams exist, how do they interact?
Attack vectors: What are the types of attacks that can be performed on OT devices?
Detection and Analysis
Detection by user observation: Such detection includes any member of the organization, including operators, process engineers, or system administrators observing abnormal system or component behavior.
Detection by automation: Such detection includes abnormal system or component behavior detection through applications or routines, such as network monitors, network traffic analysis applications, IDSs and antivirus programs detecting and flagging malware, intrusion attempts, policy violations, exploits, and component failure. 
Analysis: IR team members analyze captured events from user observations or IR tools. Once an attack is properly identified, the incident should be categorized and the response prioritized based on the potential damage to the ICS. 
Containment, Eradication, and Recovery
Containment: Containment varies, depending on the type of malware, importance of the affected system, and the acceptable level of risk. It also serves two purposes: to stop the spread of malware to other parts of the ICS and to prevent damage to the ICS. 
Eradication: Any malware left on the system should be eradicated. The process of removing malware can be time consuming, depending on the type of malware, severity of the infection, and containment method used. Such eradication tools as spyware detection and removal utilities and patch management software can be used but may remove or alter legitimate system or data files. Most antivirus software focuses on IT systems and does not detect malware on more specialized control systems. 
Recovery: Although some recovery commonalities exist between IT and ICS environments, such as removal of malware, restoring backup data to databases, systematically removing temporary containment actions, and restarting all operation systems and applications, additional complexities relate to ICS environments. These complexities relate to the manner in which systems must be managed, because many of the services provided by the facility cannot be shut down during IR. Other approaches must be taken, such as switching the control functions to fail-over systems, moving to temporary backup equipment with limited capabilities, or isolating system components from network access. Processes continue to operate but with reduced functionality.  
Post-Incident Activity
Lessons learned: An attempt is made to analyze the incident, the response, and the impact to discover and document what could have been done differently to improve upon the response. 
Recurrence prevention: Such prevention includes applying what was learned in remediating discovered weaknesses in the cybersecurity program, including preventing similar incidents. 
Forensics and legal issues: This includes capturing and protecting data as evidence for potential legal action. 

---------------

Securing IT and OT Devices
Security controls are used to perform different actions, depending on whether they are used within an IT or OT network, as shown in Table 26.3-3:

﻿<img width="1284" height="2048" alt="image" src="https://github.com/user-attachments/assets/6f5d508d-a018-4d87-aa62-eec6b0507aef" />

Network Intrusion Detection and Prevention 


All network IDSs/IPSs deployed within a network environment should be able to conduct Deep Packet Inspection (DPI) and interpret ICS protocols and commands. However, false positives can occur when conducting network inspections. Thus, an IDS alerting suspect network traffic on a control network is more suitable than an IPS because IPS solutions may block or drop network traffic that could end up being legitimate control commands, which wrongly disrupts the control system. 


Vulnerability Scanning


Automated vulnerability scanning in IT is a common practice and does not interfere with processes. In OT, vulnerability scanning can have undesirable effects on aged firmware versions or legacy devices not designed to handle abnormal network traffic patterns. This disparity requires a cautious approach to vulnerability scanning in ICS to minimize the risk of inadvertently taking down critical systems. Alternatively, vulnerability scanning in an ICS can be conducted effectively by comparing asset inventories, configuration files, and firmware versions against threat intelligence and vulnerability advisories.  


Encryption


Confidentiality on the network’s OT side is less of a requirement than on the network’s IT side. Encrypting insecure channels can protect both IT and OT networks. Adhere to endpoint processing power, network latency, and bandwidth consumption, especially in networks that consist of legacy devices. The risk of adversaries eavesdropping or sniffing personal data inside the OT network is not the same as on the IT side of the network, and Network Security Monitoring (NSM) defense capabilities may be severely limited if the control network is encrypted. 


Endpoint Protection


Most IT environments consist of signature-based endpoint protection or heuristic engines to identify threats. Signature-based endpoint protection tools are not ideal within OT environments, as they are difficult to update. These tools can cause false positives and disrupt industrial processes, causing unsafe conditions. To avoid such issues, allowlisting features are effective and do not require signature or constant updates. 


Firewalls


OT devices require the defensive capabilities of firewalls as much as IT devices do. They differ in the necessity of what traffic is being prevented from accessing these systems. In a regular IT network, these firewalls segment areas of the network that have no need to communicate with each other. They are also commonly used to block specific ports and protocols from being used. In an OT environment, they should completely isolate the ICS network for the rest of the network. The internet should have no connectivity; this is also true for any workstation or server in the domain, with the exception of any HMI device specifically inserted to administer these devices.


Patching


In IT, device patching is a routine occurrence that happens on a common schedule or whenever a vulnerability is discovered. IT networks can administer reboots to individual boxes or whole subnets of the network without the rest of the network being shut down. OT devices, on the other hand, control the industrial machinery, and if they are rebooted or shut down for updates, the industrial machines cannot function. Patching for these devices must be scheduled in advance at a time during which the factory is not in operation. Patching is not possible with some legacy ICS devices.


Protocols


Some traditional protocols are used within both IT and OT environments. However, control system environments go well beyond common protocols and may include specific industrial and several proprietary protocols, as Table 26.3-4 shows:


<img width="1600" height="1358" alt="image" src="https://github.com/user-attachments/assets/0c58fe8c-7c7f-4455-b4bb-9ac66a6055cd" />


--------------------

IT/OT Device Convergence
IT and OT convergence may be broken down into two elements: technology and resources (or teams). OT and IT devices leverage traditional OSs and infrastructure to automate and improve control system processes. The OT devices support the control system mission and should be properly managed and protected as OT assets. Controlling ICS networks is becoming easier with the possibility of remote administration and is a more efficient way to manage these systems. Administrators of OT devices are no longer always specialized engineers in this field. Instead, they may be any IT personnel with proper training in such ICS-specific areas as the ICS mission, safety, the engineering process, protocols, and active defense strategies. Understanding how these devices must be handled and secured in different scenarios is different from traditional IT security. 



--------------

IR in OT and IT Architecture | Part 1
A Cyber Defense Analyst (CDA) has been tasked by a mission partner to assist in analyzing suspicious network traffic affecting the IT side of the network that is potentially causing disruption in the functionality of OT processes.

﻿

The OT side of the network environment consists of a number of virtualized networks in addition to a functioning simulation of a Feed Water Treatment System (FWTS). A virtualized PLC leverages the Modbus protocol to monitor process measurements and accept commands from the HMIs within the DCS network.

﻿

Use Elastic Stack to analyze the suspicious activity and logs to understand the differences in behavior of the IT and OT devices in the mission partner’s network environment. A network map of the mission partner's network environment is attached.

  

Workflow 
﻿

1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:


Username: trainee
Password: CyberTraining1!
﻿


2. Open the Chrome web browser, select the Security Onion bookmark, and log in using the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿


3. Select the hamburger menu icon in the top left corner, and select Kibana in the Tools section:



<img width="2012" height="1270" alt="image" src="https://github.com/user-attachments/assets/9f253ac3-db81-4c79-a5e8-d61c091ae52a" />

The Security Onion - Home dashboard appears.


4. Select the hamburger menu icon again, and select Discover in the Analytics section

<img width="2014" height="1112" alt="image" src="https://github.com/user-attachments/assets/3579f139-74f1-4241-b84c-0293cae9cad8" />

5. Set the time period of interest from Sep 29, 2022 @ 10:00:00.000 to Sep 29, 2022 @ 13:00:00.000, and select Update. 


Compare IT and OT captured network traffic logs from the mission partner’s network. A functioning IT workstation is located in the Business Processing Department of the network. On the OT side of the network, the PLC leverages the Modbus protocol to monitor process measurements from the FWTS and receives commands from the HMI. Messages containing the Modbus protocol are embedded into the frame or packet structure used on the OT network. 


6. Use the following Kibana Query Language (KQL) query to locate the network traffic associated with the host in the Business Processing Department, and select Update:


destination.ip: 172.16.3.2

<img width="2036" height="298" alt="image" src="https://github.com/user-attachments/assets/4c095151-30cf-473b-902f-317fb6d93545" />

7. Scroll down, and analyze the log captured on Sep 29, 2022 @ 12:28:26.976:

<img width="2036" height="1360" alt="image" src="https://github.com/user-attachments/assets/12afcbe6-127b-49b8-a90c-a386cd4cf687" />

IT includes any use of computers, storage, networking devices, infrastructure such as Domain Controllers (DC), and processes to create, store, secure, and exchange all forms of data. 


Notice in the message field that the workstation is communicating with the DC to edit policies over the Server Message Block (SMB) protocol. These particular actions do not occur with OT devices. 


8. Remove the previously used KQL query, and use the new KQL query to search for the IP address of the PLC. Select Update: 


source.ip: 172.16.80.10




9. Add the following filter to analyze Modbus protocol traffic, and select Save:


event.dataset.keyword: modbus

<img width="2036" height="1368" alt="image" src="https://github.com/user-attachments/assets/157a2d05-ac0e-45fc-9e5d-dfe7b148ec62" />



NOTE: Refresh data if no data shows after adding filter.


10. Scroll down and analyze the log captured on Sep 29, 2022 @ 12:59:59:980: 

<img width="2036" height="1366" alt="image" src="https://github.com/user-attachments/assets/1cb20932-2158-470a-a54f-b32f64d95cdc" />

Such OT devices as PLCs use the Modbus protocol over port 502. The messaging structure of Modbus uses client–server communication between devices, which transmits functions such as READ and WRITE input registers. These registers tell the device what function to perform. 



-----------

IR in OT and IT Architecture | Part 2
The mission partner reports that an employee has come forward stating that they downloaded an unknown executable file from an email they thought was from their manager. Since the download occurred, the host within the Business Processing Department has been seen making unwarranted interactions with the PLC. The FWTS has also produced erratic behavior.

﻿

In the following workflow, use Elastic Stack to analyze the captured network traffic between the host in the Business Processing Department and the PLC. Use the findings to assess and compare IR actions for the IT and OT architecture. A network map of the mission partner’s network environment is attached. 

﻿

Workflow 
 ﻿

1. Remove the Modbus filter and KQL query that was set in the previous task, and add a new query, to include the following:

﻿

source.ip: 172.16.3.2 and destination.ip: 172.16.80.10

﻿

Forty-one captured log hits should result between the two IP addresses:


<img width="2036" height="772" alt="image" src="https://github.com/user-attachments/assets/3edc5037-bd85-466c-a567-5485008bede5" />




2. Analyze the log captured on Sep 29, 2022 @ 12:41:44.556. Notice the port and protocol used as a line of communication between the two devices. 


An IT workstation should not be making these types of connections with a PLC device. This traffic can be deemed malicious, as this is lateral movement toward the control environment. The situation warrants further investigation, as processes within the organization may be disrupted. 


The workstation of the victim employee is possibly being used as a pivot point to access the OT network and disrupt services of the organization. Containment of the IT workstation is necessary to observe and characterize adversary behavior and TTPs to enable follow-on operations. However, the PLC device cannot be disabled, as this controls the FWTS and will disrupt the organization’s processes. The traffic warrants further investigation using Zeek logs to determine if a false positive has been captured, as processes within the organization can be disrupted.


3. Select the hamburger menu icon, and select Dashboard under Analytics. 



The Security Onion - Home dashboard should now be present. 


NOTE: If the Security Onion - Home dashboard does not appear, enter Home in the search bar, and select the Security Onion - Home dashboard.


4. Select Network under Event Category: 



<img width="2048" height="799" alt="image" src="https://github.com/user-attachments/assets/f90a91dd-a1ca-4aa3-825b-b3ebcd08ac0c" />



5. Edit the KQL query search bar to include the IP address of the PLC in the query. Select Refresh:


event.category: network and source.ip: 172.16.80.10




6. Analyze the Security Onion - Destination IP pane:



<img width="263" height="380" alt="image" src="https://github.com/user-attachments/assets/d67479c6-a395-4e10-9ca6-7be50aa87ac3" />


Not only are unwarranted connections being made to the PLC from the Business Processing Department workstation, but a connection is also being made to an IP address outside the scope of the network environment. As a false positive can be ruled out, this malicious IP address may well be the perpetrator of these events. The IR process can be further elevated. 


As mentioned earlier in the lesson, the steps of IT IR still adhere to the OT/ICS IR process. 


If malware is not detected on the OT device, containment of the PLC device requires removing access to the device from all sectors of the network. Containment includes the following:
Block the intruder.
Restore the equipment, if affected.
Apply prevention methods, such as patch management. 
If malware is detected on the OT device, it is best to prevent continued damage to the control systems. Containment methods include the following:
Use automated technologies such as virus removal programs to eradicate the virus and prevent spreading to other systems and restore system functions.
Halt services while the incident is handled.
Block certain network connectivity by using filtering processes. 
Regarding OT recovery and restoration in the IR process, although commonalities with IT exist (such as removal of malware, restoring backup data to databases, systematically removing temporary containment actions, and restarting all operational systems and applications), other approaches must be taken because many services cannot be shut down. Such approaches include the following: 
Switch the control functions to fail-over systems.
Move to backup equipment that is temporary or has limited capabilities.
Isolate system components from network access.
The final stage of recovery is not to just restore the system to where it was but, rather, to make it more secure. The system should have the same operational capabilities but should also protect against the exploit that caused the incident in the first place. 


Answer the following questions.
<img width="1125" height="646" alt="image" src="https://github.com/user-attachments/assets/18971446-7d8b-4924-b01f-f6573d2fc1bc" />
<img width="1070" height="641" alt="image" src="https://github.com/user-attachments/assets/cecb616a-5d23-41e4-ae2c-7f3c1c975e77" />
<img width="1124" height="662" alt="image" src="https://github.com/user-attachments/assets/017f6e47-a056-4e4d-bc08-559d9543ba4c" />


---------------

### CDAH-M27L1-Host Isolation Options ###


Host Isolation Considerations
Host isolation is a critical step in the containment phase of IR because it helps prevent the spread of a discovered attack and contain damages. However, IR is a tricky proposition since a responder cannot simply kick a host off the network or power it down without considering the effects of these actions. The isolation technique selected may affect the functionality of the rest of the network or the response plan itself. CDAs must consider the following, prior to selecting a host isolation technique:

Adverse impacts to mission operations
Collateral damage
Evidence collection
Duration of containment
Adverse Impacts to Mission Operations
﻿

The first consideration when an attack is detected is the removal of the attackers from the network. The most direct way to do this is to physically unplug the network cable or disable the interface. However, this might not always be the best first step. The host in question may be mission critical to the organization, so pulling the plug may cause more harm than the attack itself. The attack may even spread beyond the single host where it was discovered, so isolating just one host could be ineffective in containing the attack. 

﻿

Collateral Damage
﻿

CDAs must also consider possible collateral damage for a given strategy. Malware is rapidly becoming more advanced. Advanced malware may be able to detect a containment strategy, change its attack strategy, and cause more negative impacts. For example, disabling a network interface may stop the malware from accessing the Internet, but this may also prompt the malware to delete important information on the host. Predicting the capabilities of the malware is difficult in a case like this. It may be preferable, then, to choose a containment strategy that impacts the operation of the malware as little as possible while still achieving isolation.

﻿

Evidence Collection
﻿

Another consideration when dealing with an incident is evidence collection and preservation. A clumsy approach to containment may corrupt or completely destroy vital evidence. This evidence may be necessary for determining the entire scope of the infection and any potential legal prosecution. Volatile information is lost when powering down a host. This may prevent the collection of information about memory-resident malware.

﻿

Duration of Containment
﻿

The duration of the containment is another important consideration that is difficult to accurately predict. An ideal containment strategy minimally impacts business operations while fully addressing and containing the incident. 

﻿

Overall, the containment strategy employed must take into consideration all of the above factors. CDAs who have a well thought-out and established process prior to an incident are more likely to succeed during incident response. The established process depends on the specific host that is compromised and may have progressive steps based on the duration of the incident response timeline. 


----------------

Host Isolation Techniques
There are many different methods by which a host can be isolated when an attack occurs in an attempt to contain the extent of the malware. The most common mechanisms are network isolation and lateral movement blocking.

﻿

Network Isolation
﻿

Network isolation is the primary method of isolation during incident response. This method is effective because it prevents the infected host from communicating with other hosts on the network. Blocking communication before the malware spreads may effectively contain the infection to a single host. 

﻿

While there are many different ways to accomplish network isolation, the most straightforward method is to disable the network interface. The following describe different options for disabling the network interface:

Physical Removal: Unplug the network cable, if one is available.
Programmed Scripts: Run a script to disable the network interface from the Operating System (OS). 
Logical Partitions: Move the infected host into a separate Virtual Local Area Network (VLAN). 
Firewall Configurations: Set up a firewall on either the host or network to block all traffic into and out of the host. 
In each case, the host ceases all its usual ability to communicate over the network. For an end user workstation, this is likely acceptable. For mission critical servers, this might not be acceptable. Often, the best answer for mission critical servers is to have backup hosts that can take the load while the infected host is isolated. In the absence of proper backup hosts, network isolation may not be a desirable option for host isolation. 

﻿

Lateral Movement Blocking
﻿

Blocking lateral movement is another important part of effective host isolation. After an attacker establishes a foothold on an infected host, blocking lateral movement may help contain the attack and spare the rest of the network. Two common methods for blocking lateral movement are by limiting inter-host communication and by leveraging compromised credentials.

﻿

Limit Inter-Host Communication
﻿

Defenders can block lateral movement by isolating networks, as described above, and by limiting other aspects of inter-host communication. For example, defenders may disable specific protocols, such as Server Message Block (SMB) and Remote Desktop Protocol (RDP). SMB is one of the most common protocols used by attackers for lateral movement in a Windows network environment.

﻿

Leverage Compromised Credentials
﻿

Another common method of lateral movement in an attack is reuse of compromised credentials or leveraging the access of a compromised account to obtain sessions on other computers. Thus, an effective isolation technique could be to disable the compromised accounts. This would allow the host to continue functioning in the network environment as before, just without the compromised account. This would be an effective technique in the case of a compromised account that only has limited privileges and privilege escalation has not yet been accomplished by the attacker. 

﻿

Related to disabling compromised accounts is changing of account passwords. This would be effective in the case of a password breach. Changing the affected passwords would prevent the attackers from being able to use those credentials, limiting them to the access they already have, and preventing them from reusing those passwords to move laterally and expanding their footprint. 

﻿<img width="1096" height="709" alt="image" src="https://github.com/user-attachments/assets/fa6ec280-5c4e-4a35-8224-7509ccc47515" />

------------


Host Isolation With PowerShell
Analysts can use PowerShell to run script commands that logically isolate a device and significantly improve response time during an IR scenario. Since the compromised device is not always physically available, the ability to remotely isolate it before unplugging the network cable is invaluable. There are multiple methods by which a host may be isolated, and applying all of them as a form of defense in depth is appropriate. The following methods may use scripting to isolate the host:

Prevent Outbound Activity

Isolate a Host from a Domain

Turn Off the Network Adapter

Prevent Outbound Activity
﻿

Setting the local and network firewall to prevent all outbound network activity from the isolated device is an effective logical fallback measure to employ. However, this should not be the only measure taken for host isolation. Local firewalls can also be turned off by administrative privileges.

﻿

For example, a mission partner network that employs Vyatta routers for network communications may run the following script to set a firewall rule. This script sets the rule to block a specific Internet Protocol (IP) address from communicating outward:

conf
set firewall name Isolation-Rule default-action 'accept'
set firewall name Isolation-Rule description 'ISOLATED'
set firewall name Isolation-Rule rule 999 action 'drop'
set firewall name Isolation-Rule rule 999 description 'Isolate IP address'
set firewall name Isolation-Rule rule 999 source address 1.2.3.4
set interfaces ethernet eth0 firewall local name Isolation-Rule
commit
save
In a line-by-line manner, this script performs the following actions:﻿

Initiates configuration mode on the device.

Creates the rule set named Isolation-Rule and sets the default action to accept so that traffic not explicitly blocked by other rules is allowed.

Sets the description of the rule to ISOLATED.

Creates a rule with ID 999 within the Isolation-Rule set to drop matching traffic.

Sets the description of rule 999 to Isolate IP address.

Specifies that the source address of rule 999 is 1.2.3.4.

Associates the Isolation-Rule set with eth0 on the firewall.

Applies the configuration changes.

Saves the configuration changes.

Using an address group improves the extensibility of this rule. The current rule requires adding a new numbered rule to the firewall with each additional isolation. Additional isolations may be necessary during a widespread compromise.

﻿

Isolate a Host from a Domain
﻿

Removing a host from the domain prevents domain-authenticated communications. This effectively makes the device unusable because authentication cannot occur. 

﻿

Use the PowerShell cmdlet Remove-Computer to remove a computer from the domain. This cmdlet uses the parameters listed in Table 27.1-1, below, to receive the necessary input from the user and remove a host from the domain:

<img width="1667" height="887" alt="image" src="https://github.com/user-attachments/assets/418ee210-9402-4a68-8c0c-8a56f1497576" />


Turn Off the Network Adapter


Network connectivity at the host level must be severed as completely as possible. Although removing the physical cable from the system is the best way to accomplish this, there are other effective backups defenders can use until responders arrive onsite. One option is to logically turn off the network adapter for all network interface cards. Defenders can run the following command in PowerShell to turn off the cards:
Disable-NetAdapter -Name "Device Name" -Confirm:$false



After the incident is resolved, defenders may use the following command to re-enable the device:
Enable-NetAdapter -Name "Device Name" -Confirm:$false


---------------


Develop a PowerShell Isolation Tool
The previous sections of this lesson described various methods for isolating a computer. In the following lab, write a script to turn off the network adapter, remove the computer from the domain, and prevent the computer from communicating in any other way on the network, even if the adapter is turned on or any cables are reconnected.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) dc01 using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the PowerShell Integrated Scripting Environment (ISE).

﻿

3. Define the following user-supplied parameters:

param(
    [Parameter()]
    [String]$ComputerName,
    [String]$RouterIP,

    [String]$UserName,
    [String]$Password
)
﻿

4. Enable PowerShell cmdlets to manipulate Active Directory (AD) objects by importing the following AD module:

Import-Module ActiveDirectory
﻿

5. Obtain the IP address of the isolated computer by defining the following variable:

$ComputerIP = $(Resolve-DnsName $ComputerName).IPAddress
﻿

6. Turn off the network adapter in five minutes by entering the following script: 

Invoke-Command -ComputerName $ComputerName -ScriptBlock {Register-ScheduledTask -TaskName 'Isolate' -InputObject ((New-ScheduledTask -Action (New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-Enable-NetAdapter -Name "Ethernet1" -Confirm:$false') -Trigger (New-ScheduledTaskTrigger -Once -At (Get-Date).AddMinutes(5)) -Settings (New-ScheduledTaskSettingsSet))) -User $Using:UserName -Password $Using:Password}
﻿

The following is the script block broken down into its discrete parts: ﻿﻿

﻿

Execute everything within the script block as the current domain administrator:

Invoke-Command -ComputerName $ComputerName -ScriptBlock { 
﻿

Register and create a scheduled task on dc01:

Register-ScheduledTask -TaskName 'Isolate' -InputObject ((New-ScheduledTask 
﻿

Isolate the network adapter on the malware-infected host:

-Action (New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-Enable-NetAdapter -Name "Ethernet1" -Confirm:$false') 
﻿

Set the task to execute in five minutes:

-Trigger (New-ScheduledTaskTrigger -Once -At (Get-Date)AddMinutes(5))
﻿

Call the new scheduled task setting function:

-Settings (New-ScheduledTaskSettingsSet)))
﻿

Execute the task creation process with administrator privileges and end the script block:

-User $UserName -Password $Password}
﻿

NOTE: In some situations it is wise to avoid running commands on the infected computer. If forensic data collection has not yet been completed, running new code or making configuration changes might negatively affect the value of the forensic data. If touching the infected host is inadvisable or disallowed, the remote commands in the code above can be excluded from the script. The firewall rules created in later steps will also effectively disconnect the infected host from the network. 

﻿

7. Remove the malware-infected host from the domain and have it join the workgroup Isolated by entering the following PowerShell cmdlet:

Remove-Computer -ComputerName "$ComputerName" -UnjoinDomainCredential energy\trainee -WorkgroupName "Isolated" -Force
﻿

NOTE: A best practice is to restart the device after making domain membership changes to the host. However, in this scenario, the restart is being delayed until the IR team arrives at the workstation location and completes the necessary forensics.

﻿

So far, the script turns off the network adapter and removes the computer from the domain. The next series of commands aims to prevent the computer from communicating in any other way on the network. This also prevents the attacker from restoring connectivity prior to the IR team resolving the incident. To achieve these goals, the next part of the script sets up a firewall rule on the router to block all network traffic from the intruder IP address.

﻿

This part of this lab uses the Putty Secure Shell (SSH) client. This SSH client is installed on the current domain controller (dc01), though it is not commonly present in default installations of Windows server or Windows workstations. In this case, Putty SSH has been installed to extend the functionality of the isolation script by enabling remote interaction with the router which governs network connectivity to the host in question. 

﻿

Analysts are able to use the command plink from within a PowerShell script to SSH into the Vyatta router and configure firewall rules that isolate the malware-infected system. The configuration passed to the router creates a firewall rule that denies all traffic from a Domain Name Server (DNS)-resolved IP address and applies that rule to all interfaces.

﻿

8. SSH into the router by entering the following command in the script:

plink -ssh vyatta@$RouterIP -i $env:UserProfile\id.ppk -batch 
﻿

9. Use the configuration command wrapper to pass commands to the Vyatta router with the wrapper command begin by entering the following command in the script:

"/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin; 
﻿

10. Create the firewall address group ISOLATED with the host IP or IP range to isolate and set a description for the group:

/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED address $ComputerIP; 
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED description 'Isolated IP Addresses';
﻿

11. Under the address group ISOLATED, create a rule named Isolation-Rule that accepts traffic by default, then sets a description:

/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule default-action 'accept';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule description 'ISOLATED';
﻿

Creating an address group allows engineers and administrators to quickly reduce overhead by centrally managing individual IPs and IP ranges without manually updating each rule. The rule created in the next step uses the address group through its name, Isolation-Rule, to set the IP or IP range the rule applies.

﻿

12. Create a new rule numbered 999 that drops all network traffic from the infected host:

/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 action 'drop';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 description 'Isolate IP address';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 source group address-group ISOLATED;
﻿

The next step applies this rule to the interfaces to prevent the infected host from communicating across the network.

﻿

13. Apply the created firewall rule to the seven available interfaces by entering the following set of commands in the script:

/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth1 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth2 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth3 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth4 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth5 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth6 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth7 firewall local name Isolation-Rule;
﻿

14. Commit and save the configuration changes by entering the following commands in the script:

/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save;"
﻿

15. Ensure all lines of the script from the previous steps have been entered correctly by comparing them to the following completed script:

param(
    [Parameter()]
    [String]$ComputerName,
    [String]$RouterIP,
    [String]$UserName,
    [String]$Password

)

Import-Module ActiveDirectory

$ComputerIP = $(Resolve-DnsName $ComputerName).IPAddress

Invoke-Command -ComputerName $ComputerName -ScriptBlock {Register-ScheduledTask -TaskName 'Isolate' -InputObject ((New-ScheduledTask -Action (New-ScheduledTaskAction -Execute 'pwsh.exe' -Argument '-Enable-NetAdapter -Name "Ethernet1" -Confirm:$false') -Trigger (New-ScheduledTaskTrigger -Once -At (Get-Date).AddMinutes(5)) -Settings (New-ScheduledTaskSettingsSet))) -User $Using:UserName -Password $Using:Password}

Remove-Computer -ComputerName "$ComputerName" -UnjoinDomainCredential energy\trainee -WorkgroupName "Isolated" -Force

plink -ssh vyatta@$RouterIP -i $env:UserProfile\id.ppk -batch "/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin; /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED address $ComputerIP; 
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group address-group ISOLATED description 'Isolated IP Addresses';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule default-action 'accept';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule description 'ISOLATED';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 action 'drop';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 description 'Isolate IP address';
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall name Isolation-Rule rule 999 source group address-group ISOLATED;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth1 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth2 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth3 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth4 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth5 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth6 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth7 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save;"
﻿

16. Save the entire PowerShell script on the Desktop with the file name IsolateHost.ps1.

﻿

Execute the PowerShell Isolation Tool
﻿

Continue working in the VM dc01 to run the script IsolateHost.ps1 in PowerShell ISE. Use the VM core-router to verify that the script executes correctly.

﻿

NOTE: Executing the script in PowerShell ISE configures the router. This displays warnings regarding rules already existing and generates Invalid command [] errors due to a software bug in the current software version. For this lab, ignore the warnings and errors that display during script execution.

﻿
Workflow
﻿

1. In the VM dc01, execute the script IsolateHost.ps1 within the PowerShell ISE terminal by entering the following commands:

cd c:\Users\trainee\Desktop
.\IsolateHost.ps1 -ComputerName ENG-WKSTN-1 -RouterIP 172.16.2.1 -UserName Administrator -Password CyberTraining1!
﻿

Enter CyberTraining1! if prompted for a password.

﻿


This command executes the script IsolateHost.ps1 for the host ENG-WKSTN-1 at the router located at IP address 172.16.2.1.

﻿

2. Login to the VM core-router with the following credentials

Username: vyatta
Password: simnet
﻿

3. Verify the script executed correctly by entering the following two commands:

configure 
show firewall
﻿

The address-group ISOLATED should be visible with the configured IP address 172.16.4.2﻿

﻿

show interfaces
﻿

The output for a correct execution indicates that the firewall local name Isolation-Rule applies to the ethernet adapters eth1 through eth7.

<img width="801" height="141" alt="image" src="https://github.com/user-attachments/assets/0edad5d7-1449-4682-9077-ca27934d3148" />
<img width="1110" height="491" alt="image" src="https://github.com/user-attachments/assets/7cad63fb-9d59-44a0-bc3d-d9dcab70c2fd" />


-----------


Resolve an Intrusion Incident
Analysts may return an isolated host back into the organization’s operating environment after concluding the incident that required host isolation. An incident is concluded when one or more of the following conditions are met:

The system was restored completely from a backup image after collection occurred.
The system was thoroughly investigated and all malicious artifacts were eradicated.
The contaminated objects, such as user accounts, have undergone sufficient state change from the time of compromise, including password changes.
Developing a PowerShell Restoration Tool
﻿

An incident has concluded. A host requires the restoration of full connectivity to the network. Use PowerShell to develop a script that aids by automating the restoration process. 

﻿

Workflow
﻿

1. Log in to the VM dc01 using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the PowerShell ISE. 

﻿

3. Define the following user-supplied parameters:

param(
    [Parameter()]
    [String]$ComputerName,
    [String]$RouterIP
)
﻿

4. Import the Active Directory module by entering the following cmdlet:

Import-Module ActiveDirectory
﻿

5. Turn network access to the device back on at the router level by entering the following series of commands:

﻿

NOTE: Executing these commands displays warnings and generates Invalid command [] errors due to a software bug in the current software version. For this lab, ignore the warnings and errors that display during script execution.

﻿

plink -ssh vyatta@$RouterIP -i $env:UserProfile\id.ppk -batch "/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin; /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall group address-group ISOLATED;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth1 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth2 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth3 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth4 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth5 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth6 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete interfaces ethernet eth7 firewall local name Isolation-Rule;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit;
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save;"
﻿

6. Add the host back into the domain by entering the following cmdlet:

Add-Computer -ComputerName $ComputerName -LocalCredential $ComputerName\Administrator -DomainName energy.lan -Credential energy\trainee -Restart -Force
﻿

7. Save the file on the Desktop as RestoreIsolatedHost.ps1.

﻿

8. Log in to the VM eng-wkstn-1 with the following credentials: 

Username: trainee
Password: CyberTraining1!
﻿

9. Open a PowerShell terminal.

﻿

10. Turn on the Network Adapter by entering the following cmdlet:

Enable-NetAdapter -Name "Ethernet1" -Confirm:$false
﻿

11. Return to the VM dc01.

﻿

12. In a PowerShell terminal, execute the script RestoreIsolatedHost.ps1 for the host eng-wkstn-1:

.\RestoreIsolatedHost.ps1 -ComputerName ENG-WKSTN-1 -RouterIP 172.16.2.1
﻿

13. Enter CyberTraining1! when prompted for Administrator and Trainee passwords.

﻿

Use the information from this lab to answer the following question.

<img width="1118" height="715" alt="image" src="https://github.com/user-attachments/assets/11a78a23-046c-49cb-b307-e37ffefd0467" />


------------

### CDAH-M27L2-Forensic Image Acquisition ###

Forensic Acquisition Overview
Forensic acquisition is the process of collecting and creating a bit for bit copy of data from a specified storage device or host. Forensic acquisition is accomplished using two primary methods: memory acquisition and disk image acquisition. Once the acquisition has been completed, the data must be authenticated through hashing. Verifying the integrity of a forensic image through hashing maintains confidence in the reliability and authenticity of the acquired data. By comparing the hash value of the acquired forensic image with the known reference value, investigators can quickly determine whether the image has remained unchanged or if any modifications have been introduced.

﻿

Memory Acquisition
﻿

Volatile memory, or Random Access Memory (RAM), is the memory used by the host in a powered-on state. Memory acquisition is the process of copying the data stored in the volatile memory of a host. For most operating systems, the data is stored in volatile memory, RAM, and is lost when a host loses power or is shut down. Memory acquisition effectively copies data from a volatile state to a non-volatile state and is completed by a memory dump, which may occur in one of several formats: RAW, crash dump, hibernation file, page file, or virtual snapshot. Each format is unique and may be available on only certain Operating Systems (OS). 

﻿

RAW File
﻿

A RAW-format memory dump is manually extracted from OSs in a live environment. A .raw file contains uncompressed and unprocessed data captured from the host. When memory is dumped using the RAW format, the data does not contain a header, metadata, or supporting information. 

﻿

Crash Dump
﻿

A crash dump is a memory dump of information collected by the OS about the host’s physical memory. The Windows OS, by default, collects information about the system in the event of a system crash. A Windows OS crash dump is usually saved in the C:\Windows\MEMORY.DMP file. Linux crash dumps are usually found in the /var/crash/ directory named as .crash files.

﻿

Hibernation File
﻿

A hibernation file is a snapshot of the host’s memory that the Windows OS collects and can return after a hibernation period. The hibernation file, hiberfil.sys, is a binary file located in the root directory (%SystemDrive%/hiberfil.sys). If hibernation is enabled on the host, the file is captured when an image, or copy, of the Hard Disk Drive (HDD) or Solid-State Drive (SSD) is created.

﻿

Page File
﻿

Page files (swap files) enable a system to place infrequently accessed information from RAM to a file on a non-volatile storage device, like a hard disk drive, letting the system use volatile RAM more efficiently. While a 64-bit system with a significant physical RAM capacity may not require a page file, the page file still plays a critical role in extending the system commit limit and supporting crash dumps as necessary, essentially serving as overflow for RAM. While users can create page files, most system administrators disable this ability through security policies. Additionally, administrators may elect to store page files on physical media outside the system architecture as an additional security measure or for performance gains. However, moving the page file from the C:\ drive on a Windows system is usually only done for critical infrastructure and heavy-load assets, not for user workstations. The CPT should coordinate with the mission partner to ascertain the location of all essential files when conducting forensic acquisition.

﻿

Virtual Snapshot
﻿

A virtual snapshot is a saved state of a Virtual Machine (VM) at a specific point in time. A virtual snapshot allows users to re-create the VM in the exact state in which the snapshot was captured. 

﻿

Table 27.2-1 provides a summary of the memory acquisition file formats described above:

<img width="1667" height="1058" alt="image" src="https://github.com/user-attachments/assets/dae9cd8d-a4a4-4fdb-a1d9-43500412e0e9" />

Disk Image Acquisition


Disk image acquisition is the process of copying all data, sector by sector, present on the host’s HDD. An HDD contains the host’s non-volatile memory. Disk imaging is thorough in its copying, as it copies data from sectors, including physical and logical drives, active file systems, and unused areas of the drive. Although disk imaging is thorough, it is also resource heavy, requiring significant time and memory resources to execute. Disk imaging acquisition occurs through various techniques:

Disk-to-disk: Uses hardware to create an exact copy of a source hard drive.
Disk-to-image: Makes a copy of a hard disk and saves the data as a file, such as an Optical Disk Image, or ISO, file. 
Logical: Creates a bit-for-bit copy of the data from only specific files or artifacts of interest. 
Sparse: Targets specific files and collects fragments of unallocated or deleted data. 


----------------

Volatile Memory vs. Hard Disk Acquisition
Recommending a particular forensic acquisition methodology depends on the details, components, and complexity of the incident. Table 27.2-2 provides factors that must be considered when recommending a forensic acquisition strategy:

<img width="1667" height="858" alt="image" src="https://github.com/user-attachments/assets/1d6533cf-5bef-49b4-8cca-53bec160a3a3" />
<img width="1131" height="683" alt="image" src="https://github.com/user-attachments/assets/7963a6a7-539f-4030-bc50-d69d0f5b2306" />


-----------

Identify a Compromised Host
Read the scenario below, and complete the steps in the workflow to analyze and identify the infected host(s) on the network.

﻿

Scenario
﻿

An analyst in the Security Operations Center (SOC) noticed unusual traffic during an organizational off-day. The SOC analyst tracked the suspicious traffic from the 172.16.4.0/24 Engineer subnet. As a result, the organization has implemented its IR procedures. The Cyber Protection Team (CPT) is tasked with identifying any infected hosts and relevant information to determine initial access and the best forensic acquisition method. Each workstation is providing Packetbeat, Winlogbeat, and Sysmon data to the Security Information and Event Manager (SIEM).  

﻿

Workflow
﻿

1. Open the VM win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the Chrome browser.

﻿

3. Select the 1 - DashBoard - Security Onion bookmark.

﻿

4. Log in to the Security Onion Console with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. On the main dashboard, adjust the time frame to Oct 4, 2022 @ 05:00:00.000 → Oct 4, 2022 @ 17:00:00.000, and document the entries in the dataset for Log Count by Node.

﻿

6. Select Network under Event Category:

﻿
<img width="337" height="203" alt="image" src="https://github.com/user-attachments/assets/021cd5e3-41d6-4423-84dc-92d6c237e656" />



7. Ensure the time frame is still filtering for Oct 4, 2022 @ 05:00:00.000 → Oct 4, 2022 @ 17:00:00.000, and select an Internet Protocol (IP) address in the dataset Source IPs.


8. Observe the IPs in the dataset Destination Ports.


9. Select the 2 - Kibana Discover - Elastic bookmark. Using the *:so-* index, set the time frame to Oct 4, 2022 @ 05:00:00.000 → Oct 4, 2022 @ 17:00:00.000. 


10. Select and add the following columns to the search index: 
source.ip
source.port
agent.type
destination.ip
destination.port

11. Add the following filter to the query to show only data containing destination port traffic:
destination.port exists



12. With the columns added to the index from Step 10, perform a search for the main traffic generated by the Engineer subnet, using the following search criteria: 
destination.port : <ports identified in Step 8> 
network.data.decoded : GET
destination.port : <port> and event.dataset.keyword :* exe
event.provider : Microsoft-Windows-Sysmon


Use the data returned from the query to answer the following questions.

<img width="1917" height="696" alt="image" src="https://github.com/user-attachments/assets/9b79639a-39a9-4a0c-bac0-2ad8271f4e6e" />
<img width="1082" height="470" alt="image" src="https://github.com/user-attachments/assets/e0084b1c-ca8d-4029-841b-4e84d4a817c3" />
<img width="1910" height="696" alt="image" src="https://github.com/user-attachments/assets/063c2617-0c76-46f9-9bb2-a3075510f967" />
<img width="1115" height="659" alt="image" src="https://github.com/user-attachments/assets/54e03f98-48bb-4306-a876-797d05fd1855" />
<img width="1893" height="622" alt="image" src="https://github.com/user-attachments/assets/6067b55a-e961-4c7b-b80a-b9da1ef40034" />
<img width="1112" height="530" alt="image" src="https://github.com/user-attachments/assets/2abc3555-12cf-4ff9-96c7-4b0a0485a20d" />
<img width="1112" height="449" alt="image" src="https://github.com/user-attachments/assets/298a4273-b599-4b15-bc13-734f0bad5bfd" />
<img width="1126" height="671" alt="image" src="https://github.com/user-attachments/assets/3d428fc4-2b90-4899-8c0f-5fc73eb42dd0" />


--------------------


Acquisition Strategy during an Active Breach
Acquisition strategy during an active breach requires deliberate and thorough actions. An active breach means that the adversary is currently present in the network. While active in the network, the adversary may keep a keen eye out, looking for actions that indicate that they have been found and an investigation has begun. If discovered by the owners of the victim network, the adversary may attempt immediate actions to remove their presence or steal valuable data. Table 27.2-3 provides factors the adversary may attempt to identify:

﻿<img width="1667" height="717" alt="image" src="https://github.com/user-attachments/assets/8cbb8bc7-bb83-4ae9-897e-bf727b089623" />

Techniques to Avoid Adversary Detection


IR teams must consider the actions the adversary may look for while maintaining a foothold in the network. Although the top priorities remain driving the adversary out of the network and preventing further damage, IR teams must act with intention, revealing themselves to the adversary only when they have complete control of the situation. Table 27.2-4 provides techniques IR teams may implement to avoid alerting the adversary of detection:


<img width="1667" height="992" alt="image" src="https://github.com/user-attachments/assets/208b8b9c-f801-43de-bded-68698d1b56cf" />


---------------

IR Evidence Acquisition during an Active Breach
Read the scenario below, and complete the steps in the workflow to discover forensic artifacts during an active breach.

﻿

Scenario
﻿

A malicious actor has compromised the eng-wktsn-1 system. Analysts have acquired a system image of the infected machine and built an isolated VM for further analysis. After reviewing available network logs, Network Analysts have posited that, based on the C2 activity, the malware attacked a remotely exploitable vulnerability and has developed persistence from memory. Still, the team is missing complete details about the malware. Conduct a memory dump using Redline, a tool for finding signs of malicious activity through memory and file analysis.

﻿

Workflow
﻿

1. Open the VM eng-wkstn-1. The login credentials are as follows:

Username: trainee
Password: CyberTraining1! 
﻿

2. Create a folder on the desktop, and name it Memory Analysis 2. (This folder is used in a later step.) 

﻿

3. Open Redline, and select Create a Standard Collector.

﻿

4. Under Review Script Configuration, select the checkbox under Acquire Memory Image. Select the newly created folder Memory Analysis 2 as the destination to save the collector, and select OK:


<img width="1437" height="1015" alt="image" src="https://github.com/user-attachments/assets/7a8267a3-c8a7-4532-ac3d-5b9fb5c683f6" />


5. Once OK has been selected, Redline provides a pop-up window detailing collector instructions. In the pop-up window, select the link Open Directory Containing Portable Package. This opens the Memory Analysis 2 folder.


<img width="984" height="588" alt="image" src="https://github.com/user-attachments/assets/779ea2ad-9359-4cd7-8582-62ba18ff4645" />

6. Return to Redline, exit any menus or pop-up windows, and return to the main Redline dashboard. This is a housekeeping step to close open dialog windows. 


7. Return to the Memory Analysis 2 folder, right-click the Windows batch file RunRedlineAudit, and select Run as administrator

<img width="613" height="337" alt="image" src="https://github.com/user-attachments/assets/6117aa77-4499-4268-ab2b-2064ed0fa3fb" />

A Command-Line Interface (CLI) window opens and begins executing the selected Redline analysis options. 


8. Allow the CLI prompt to complete its run. Once it has completed, return to the Redline application. 


NOTE: Depending on the physical components and amount of RAM installed, this process may require 1 hour to 24 hours to complete. 


NOTE: For the current component configuration of eng-wkstn-1, along with the selected Redline options, analysis requires up to 8 hours to complete. This lesson’s analysis has already been performed for efficiency and time constraints. The following steps continue from the point at which the report is completed and is ready for review. 


9. In the Redline dashboard, select AnalysisSession1.mans under Recent Analysis Sessions.



After this memory analysis report opens, an interactive interface displaying the selected Standard Collector options appears.


10. In the Analysis Data pane of the interface, select Processes to expand the Processes option. Review the processes to identify the malicious process.

<img width="313" height="205" alt="image" src="https://github.com/user-attachments/assets/8760d4a5-9e8f-4b2d-82f2-d6578934051f" />


The use of filters aids in identifying malicious information. For example, a filter can be created on each column, such as the Username column, to display only processes belonging to a specific user account. 


11. To create a filter for the trainee user account, select the funnel icon in the Username column; select contains in the drop-down menu; enter trainee in the dialog box; and select Add Filter


<img width="945" height="244" alt="image" src="https://github.com/user-attachments/assets/cf75def0-fd8d-4a81-b996-556e22252c57" />



12. Conduct analysis of ports used by processes by selecting the Ports option in the Analysis Data pane. All ports, only listening ports, or only ports with established connections may be displayed. 


Use this workflow to answer the following questions


<img width="1916" height="833" alt="image" src="https://github.com/user-attachments/assets/56f5c910-ce83-4b0b-97cf-ff331e5fe429" />
<img width="1114" height="718" alt="image" src="https://github.com/user-attachments/assets/5e7e6cb2-6e71-47e6-bc7a-e4bc9e6d6e8c" />
<img width="1040" height="410" alt="image" src="https://github.com/user-attachments/assets/54aa46ec-5fc2-423f-a40a-66c69b012d4e" />
<img width="1913" height="828" alt="image" src="https://github.com/user-attachments/assets/bf4d792b-9450-4a46-9cc0-538937e968da" />
<img width="1106" height="524" alt="image" src="https://github.com/user-attachments/assets/127dcc0a-f3fd-493f-8307-5513153cdd16" />

---------------


### CDAH-M27L3-Preserve Logs in Incident Response ###

Challenges in Acquiring Logs
Log collection is a critical component of monitoring and responding to incidents on the network. Logs can show such key data points as events, network connection, and processes that can assist the IR team. Log collection does have challenges, and Table 27.3-1 includes factors that organizations must remember when collecting logs


<img width="2500" height="1635" alt="image" src="https://github.com/user-attachments/assets/b6bc707b-2a77-439a-9cd5-295210c50552" />


Log Integrity


When log challenges are considered and addressed thoughtfully, the result is high log integrity. Log integrity is the collection of log data that is accurate, true, and uncontaminated. Log data with high integrity allows for the data to be used as evidence due to the trust in the collection process and data handling. An additional benefit of high log integrity is reduced time to prepare and execute an investigation. When log data is accurate and efficiently collected, an investigation can start promptly.


--------------


Analyze Compromised Logs
Based on the scenario below, complete the steps in the following workflow to identify and analyze compromised host logs.

﻿

Scenario
﻿

The host bp-wkstn-3 contains malware, the effects of which are currently unknown. Investigate bp-wkstn-3 using Kibana to discover the malware's impact on log collection. Use host eng-wkstn-2 as a comparison baseline of proper log collection.

﻿

In Kibana, customize the Discover view and use the search function to identify if any Windows Logs have been cleared.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the Chrome browser.

﻿

3. Select the Discover - Elastic bookmark.

﻿

4. Log in to the Security Onion Console (SOC) with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Set the search time frame as Sep 21, 2022 @ 00:00:00.000 to Sep 21, 2022 @ 23:30:00.000. 

﻿

6. Select Filter by type, then set the Hide Missing Fields toggle button to Off.

﻿

7. Select and add the following columns:

agent.name 
agent.type
event.code
event.action
event.dataset
event.module
log.level

8. Using the *:so-* index, execute the following query in SOC:

event.code: 1102 or event.code: 104 or event.code: 517 
﻿

Event codes 1102, 104, and 517 indicate logs were cleared from the host.

﻿


Use the data returned from the query to answer the following questions.
<img width="1909" height="709" alt="image" src="https://github.com/user-attachments/assets/cda69728-29a0-4306-ab56-03d4571d7e68" />

<img width="1077" height="448" alt="image" src="https://github.com/user-attachments/assets/07df443c-6b93-4c35-bc93-151556574b82" />


-----------------


Compromised Host
Host bp-wkstn-3 is compromised with malware that is modifying or deleting logs. As shown in Figure 27.3-1, bp-wkstn-3 experiences multiple Log clear events, preventing log collection from occurring as expected: 

﻿
<img width="1846" height="759" alt="image" src="https://github.com/user-attachments/assets/c7a5c932-95e9-47b1-92f0-21ce77fcf305" />
<img width="1909" height="709" alt="image" src="https://github.com/user-attachments/assets/533db269-615f-40d3-973b-76d4fc3ddefc" />

<img width="1070" height="632" alt="image" src="https://github.com/user-attachments/assets/9c1a0cd3-956f-4ceb-8b4a-8c192eb08702" />
<img width="1091" height="502" alt="image" src="https://github.com/user-attachments/assets/89515e6a-089f-4583-94d7-3516fbdea787" />

-------

Activity Cleared
As seen in Figure 27.3-2 below, the event.dataset and agent.name fields indicate that bp-wkstn-3 experienced multiple Log clear events in both the Security and System log categories. 

﻿

The agent.type field shows that the Log clear events w ere collec ted, transported, and preserved using Winlogbeat.
<img width="1451" height="547" alt="image" src="https://github.com/user-attachments/assets/05e24607-66d6-433c-972d-a1f22dd1c54a" />


--------------

Analyze Winlogbeat
Complete the steps in the following workflow to determine which logs are shipped via analysis of the Winlogbeat configuration files.

﻿

Workflow 
﻿

1. Open the VM bp-wkstn-3. The login credentials are as follows:

Username: administrator
Password: CyberTraining1!




2. Open File Explorer, and ensure the Hidden Items box is checked under the View tab.

﻿

3. Navigate to the C:\ProgramData\Elastic\Beats\winlogbeat folder.

﻿

4. Right-click the winlogbeat.yml file, and copy and paste it on the desktop.

﻿

5. Right-click the winlogbeat.yml file on the desktop, select Open with, select More apps, select Notepad, uncheck Always use this app to open .yml files, and select Open.

﻿

6. Review the configuration file, and answer the following question.

<img width="1920" height="837" alt="image" src="https://github.com/user-attachments/assets/e2b091b2-14ad-4747-9e60-e851665369cf" />
<img width="1098" height="422" alt="image" src="https://github.com/user-attachments/assets/47bfcaf4-5f9f-4902-9a7e-39639e6e8f45" />





---------

Identify Modified Logs
Use PowerShell cmdlets to identify log acquisition challenges based on the scenario below.


﻿

Scenario
﻿

The host bp-wkstn-3 contains malware, the effects of which are currently unknown. Investigate bp-wkstn-3 using PowerShell cmdlets to discover the malware's impact on log collection. Use host bp-wkstn-1 as a comparison baseline of proper log collection.

﻿

Compare the PowerShell cmdlet output between bp-wkstn-1 and bp-wkstn-3, and determine the status of logging services. 

﻿

Workflow 
﻿

1. Open the VM bp-wkstn-1 using the Administrator account. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open a PowerShell prompt as an Administrator, and enter the following cmdlets:

get-eventlog -list; get-service "ev*" | sort-object status
﻿

3. Open the VM bp-wkstn-3. The login credentials are as follows:

Username: administrator
Password: CyberTraining1!
﻿

4. Open a PowerShell prompt as an Administrator, and enter the following cmdlets:

get-eventlog -list; get-service "ev*" | sort-object status
﻿

5. Start the stopped service using the start-service -name "ServiceName" cmdlet. 

﻿

6. Use the services.msc command to open the Microsoft Management Console (MMC) snap-in for managing Windows services. 

﻿

7. Locate and examine the Windows Event Log service to determine the startup type. 

﻿

The host bp-wkstn-1 has cleared the proper IR protocol and is free from malware. The host bp-wkstn-3 has not cleared the IR protocol and still contains malware. 

﻿

Use the data returned from the cmdlets to answer the following question.

<img width="1113" height="660" alt="image" src="https://github.com/user-attachments/assets/c02d08f8-0112-4142-95bd-a0ff21a0973d" />
<img width="1099" height="408" alt="image" src="https://github.com/user-attachments/assets/6ec5eec7-1d6d-47d4-afca-d50c0d4c7636" />



-----------------------

Challenges in Preserving Logs
Log preservation is a critical component that allows CDAs to monitor and investigate activity on the network. Logs must be stored and be easily accessible to network defenders. Like log collection, log preservation has its challenges, and Table 27.3-2 includes factors that organizations must remember when preserving logs: 


<img width="2500" height="1264" alt="image" src="https://github.com/user-attachments/assets/9d1eb5d0-3def-4e5c-bd39-cea39a4df213" />


Preservation Techniques


Log preservation relies on a predetermined set of parameters that define which data is preserved, where the data is stored, and how long the data is maintained. Once the parameters have been determined, it is critical that an organization creates redundant processes to ensure that data is not lost due to a single point of failure. To create redundancy, organizations may develop a backup storage location for logs. The storage location may be located on an additional server or on the host itself. When logs are collected on the host, they may be duplicated and sent to both the primary server and the backup location. Such tools as Task Scheduler and PowerShell may be used to automate the backup collection.


---------------


Confirm Modification of Logs
Based on the scenario below, complete the steps in the following workflow to resume analysis of the malware attack using the VM win-hunt. 

﻿

Scenario 
﻿

Due to the malware attack, system and security logs on bp-wkstn-3 were cleared, and the Windows Event Log service was disabled. These actions have caused a significant gap in the log data, posing a challenge for any post-incident analysis. 

﻿

Analyze the available logs in the Elastic Stack from bp-wkstn-3, identify the timeline of events, and determine the extent of the logging interruption. Use bp-wkstn-1 as a comparison baseline. 

﻿

Workflow 
﻿

1. Open the VM win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the Chrome browser.

﻿

3. Select the Discover- Elastic bookmark.

﻿

4. Log in to the Security Onion Console (SOC) with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

5. Set the search time frame to Sep 21, 2022 @ 00:00:00.000 to Sep 21, 2022 @ 23:30:00.000.  

﻿

6. Select Filter by type, then set the Hide missing fields toggle button to Off.

﻿

7. Ensure the following columns have been selected and added:

agent.name 
agent.type
event.code
event.action
event.dataset
event.module
log.level

8. Limit results to bp-wkstn-3. Select Add Filter.

﻿

9. In the Edit Filter area, enter agent.name to narrow the selection results. 

﻿

10. From the drop-down menu, select agent.name, as seen in Figure 27.3-3  below. 

<img width="885" height="182" alt="image" src="https://github.com/user-attachments/assets/743b94a9-1d7b-461f-978c-39321b2aaa55" />

11. From the Operator drop-down menu, select is, as seen in Figure 27.3-4 below.

<img width="920" height="219" alt="image" src="https://github.com/user-attachments/assets/902096f5-05b6-4163-8270-27ccffa709ac" />

12. In the Value field, enter bp-wkstn-3. 


13. Select Save

<img width="910" height="374" alt="image" src="https://github.com/user-attachments/assets/528bdef6-979d-43da-9b5e-ef89b2855c46" />

14. Search for the following strings to determine the timeline of operations for clearing and disabling the Windows Event Logs:
event.code: 6006
event.action: Log cleared

Use the information gathered in this workflow to respond to the following questions.

<img width="1094" height="633" alt="image" src="https://github.com/user-attachments/assets/c2ca3015-972a-451d-be1a-f06be3859e72" />
<img width="1123" height="705" alt="image" src="https://github.com/user-attachments/assets/89f4e58f-b1ce-43d2-8ac4-55e267c1357d" />

-------------

Use Logs to Find Malware Attack Paths
Based on the scenario below, complete the workflow to resume analysis of the malware attack using the VMs bp-wkstn-3 and win-hunt. 

﻿

Scenario 
﻿

After a malware attack, system and security logs on bp-wkstn-3 were deleted, and the Windows Event Log service has been disabled. These actions have led to a significant gap in the log data, creating a formidable challenge for post-incident forensic analysis. However, the attackers neglected to clear the Sysmon Operational logs during their attack. 

﻿

Enable the Windows Event Log service and conduct log analysis to determine the attack path. 


﻿

Workflow
﻿

1. Open the VM bp-wkstn-3. The login credentials are as follows:

Username: administrator
Password: CyberTraining1!
﻿

2. Open a PowerShell prompt as an Administrator and enter the following command:

MMC



3. Add the Computer Management function to the MMC console. Select File. 

﻿

4. Select Add/Remove Snap-in. 

﻿

5. Select Computer Management, and then Add. 

﻿

6. When prompted, select the Local Computer radio button, and then Finish. 

﻿

7. Enable the Windows Event Log service. Select to expand the Computer Management menu. 

﻿

8. Select to expand the Services sub-menu. 

﻿

9. Locate and right-click the Windows Event Log service, and then select Properties. 

﻿

10. For Startup Type, select Automatic, and then Apply. 

﻿

11. Select Start to start the service, then select OK. 

﻿

12. Select OK. 

﻿

If the service does not start, reboot bp-wkstn-3 and perform Steps 1-6 again.

﻿

13. Open the Sysmon Operational event log. Select to expand the System Tools menu. 

﻿

14. Select to expand the Event Viewer sub-menu, and Windows Logs. 

﻿

15. Select to expand the Applications and Services Logs sub-menu, and then Microsoft. 

﻿

16. Select to expand the Windows submenu. 


<img width="457" height="508" alt="image" src="https://github.com/user-attachments/assets/7204470d-a269-400e-931f-217a633924a9" />

17. Locate and select Sysmon. 


18. Open the Operational log.


19. Create a filter. From the Actions menu, select Filter Current Log. 


20. Select the Logged drop-down menu, and then Custom. 


21. Enter the following date information: 
From: Events On 9/21/2022 12:00:00 AM
To: Events On 9/22/2022 11:30:00 PM

<img width="675" height="288" alt="image" src="https://github.com/user-attachments/assets/fdc0d040-8632-4d87-8274-f8f0400aace1" />


22. In the Includes/Excludes Event IDs field, enter the following information: 1,11,13


<img width="805" height="463" alt="image" src="https://github.com/user-attachments/assets/27e54ad0-bba9-425e-be60-31d007a06f22" />

23. Select OK to apply the filter.


24. From the Actions menu, select Find

<img width="292" height="412" alt="image" src="https://github.com/user-attachments/assets/de1de1d1-6ddb-4d16-b62f-6eca3442f5ba" />


25. In the Search field, enter clear-eventlog.


26. Use Kibana to perform a similar search. In Kibana, set the search time frame to Sep 21, 2022 @ 00:00:00.000 to Sep 21, 2022 @ 23:30:00.000. 


27. Select Filter by Type, then set the Hide Missing Fields toggle button to Off.


28. Select and add the following columns: 
agent.name 
agent.type
event.code
event.action
event.dataset
event.module
Log.level

29. Create an agent.name filter for bp-wkstn-3, as seen in Figure 27.3-10 below.


<img width="910" height="374" alt="image" src="https://github.com/user-attachments/assets/15d474bf-6bca-41c7-8a3a-15c0bea65bd2" />

30. Enter the following query:
event.action: "Process Create (rule: processCreate)" and process.command_line: "powershell"



Figure 27.3-11 below displays the query results. 


<img width="1509" height="272" alt="image" src="https://github.com/user-attachments/assets/b3fefba7-27e8-4948-b7fc-245fe4be9083" />


Use the information collected in the workflow to answer the following question.

<img width="1145" height="687" alt="image" src="https://github.com/user-attachments/assets/3ffb4fb2-3ecf-46c8-bb0a-ff1792fe067f" />


--------------------


### CDAH-M27L4-Investigate Contained Hosts ###

 Investigative Process Overview
As discussed in earlier Cyber Defense Analyst – Host (CDA-H) lessons, the IR lifecycle consists of four phases: Preparation; Detection and Analysis; Containment, Eradication, and Recovery; and Post-Incident Activity. Figure 27.4-1 illustrates this lifecycle. This lesson focuses on investigation of contained hosts to determine an incident’s root cause and scope. Investigation is performed within the Containment portion of the third phase. 

﻿

Investigation is complete once the Recovery process of the phase begins. Upon entering Recovery, adversarial presence is eradicated and the Cyber Protection Team (CPT) should have a firm understanding of attack timelines, vectors, and other pertinent information that it submits in an After Action Report. 


<img width="2500" height="1253" alt="image" src="https://github.com/user-attachments/assets/74ff8064-c865-42c2-a031-139093b14b4e" />

Static Analysis


Static malware analysis is a basic and effective technique that allows analysts to investigate a malware sample without actually running its code. Instead, the file is examined for signs of malicious intent. Technical indicators, such as file names, hashes, Internet Protocol (IP) addresses, domains, and file header data, can be identified and evaluated. Other malware analysis tools, such as a disassembler or network analyzers, can be used to observe the malware without running it, to collect information about how the malware works in its current state. 


Dynamic Analysis


Dynamic analysis also aids analysts during the investigative process. Manual dynamic analysis involves running a file or program inside a contained environment, or sandbox, and examining it there to discover malicious content. Through the use of a VM, a snapshot of the infected host is taken at a specific point in time. Analysts use the VM snapshot to manually execute, manipulate, and experiment with the malware. The result of manual dynamic analysis is a better understanding of what the malware does, what artifacts it leaves, and how it was contracted. 


Automated static and dynamic analyses also exist and rely on software and algorithms. Although the process is efficient, automated analysis is not as thorough as manual analysis. 


This lesson uses only manual static and dynamic analyses.


<img width="1667" height="753" alt="image" src="https://github.com/user-attachments/assets/83de8b85-d276-44ba-9e57-50a5a6cb1683" />


----------------

Investigate Malware Indicators of Compromise
Read the scenario below, and complete the lab that follows. The lab includes three exercises:

Perform static and dynamic analyses on an infected host.
Investigate the C2 component.
Determine event execution to help in generating a timeline of events. 
Scenario
﻿

Security analysts identified a host within the organization that has been infected with malware. The malware is known to quickly spread among hosts on the network, especially those that have recently established connections with one another. The CPT is investigating the host sandbox, which was exposed to and infected with malware through communications within the network. The CPT has conducted initial containment operations to isolate and contain the malware. The CPT collected a snapshot of the sandbox host to allow for dynamic manual analysis. The malware varies in name but is frequently seen using folders (that may be hidden) and the registry to maintain persistence. The malware also includes a C2 component, where it attempts to send information to an external location. Table 27.4-1 presents the possible IOC associated with the malware:


<img width="882" height="2048" alt="image" src="https://github.com/user-attachments/assets/24b0e5ed-cafd-4141-9ccf-99b01dc1526a" />

-------------



Perform Analyses
A pre-investigative briefing conducted by the All-Source Analyst provided Host Analysts with critical information about the malware, indicating that its origin is from a known adversary. This adversary is known to use sleep functions that cause their malware to sleep between 30 and 120 seconds on random intervals between actions. Analysts should take this information into account when conducting dynamic analysis operations. 

﻿

Complete the steps in the following workflow to perform both static and dynamic analyses on the sandbox host, which is located in a sandbox environment. The functionality of the malware on the host is largely unknown, and although dynamic analysis is included, such unusual occurrences as connection attempts, dialog boxes, and error messages may occur. 

﻿

Prior to initiating the malware in this lab, open and set up tools for analysis, such as Process Monitor (ProcMon), Process Explorer, and Autoruns.﻿﻿

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) sandbox. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Open the folder C:\Users\trainee\Desktop\Malware, and double-click msg.exe to execute it. 

﻿

N﻿OTE: The malware may take a few minutes to complete its activities.

﻿


3. Conduct static and dynamic analyses of the msg.exe file by determining the processes, registry changes, and event logs changed after executing the malware executable.  

﻿

Using this workflow, answer the questions that follow.

﻿

Keep the VM sandbox open, as it is used in the next exercise.

<img width="1418" height="583" alt="image" src="https://github.com/user-attachments/assets/f689528b-0db6-407b-8fd4-0da04d7efcfc" />
<img width="1134" height="671" alt="image" src="https://github.com/user-attachments/assets/f5f20a34-cae1-4e36-9845-93d8b7023d95" />
<img width="778" height="256" alt="image" src="https://github.com/user-attachments/assets/f19865c3-96b9-427f-bcc3-08efe5096cad" />
<img width="1000" height="518" alt="image" src="https://github.com/user-attachments/assets/f97bb7c1-1775-4e44-8316-d4c4bf61184b" />
<img width="1052" height="219" alt="image" src="https://github.com/user-attachments/assets/880ae95e-9402-4eb0-bee7-9303d68cdcc5" />
<img width="1074" height="573" alt="image" src="https://github.com/user-attachments/assets/3a5f4c96-8239-4992-8d18-16c323b94fb6" />



---------------

Determine the Associated Command-and-Control Mechanism
Shift the investigation to determine the C2 mechanism associated with the malware. Investigate whether the C2 component is hard-coded into the malware, and identify any created or modified files and folders. Conduct static or dynamic analysis, as needed. 

﻿

Answer the questions that follow.
<img width="1113" height="694" alt="image" src="https://github.com/user-attachments/assets/d291d445-e3b3-42ce-b4e3-7be3781ee25e" />

<img width="1021" height="612" alt="image" src="https://github.com/user-attachments/assets/95803c70-9cb2-4d2f-ab0c-fbc5261c8e99" />

<img width="1054" height="644" alt="image" src="https://github.com/user-attachments/assets/4af30f96-308f-4e75-aca3-98a802ebd4c2" />


-------------



Determine Event Execution
Conduct static analysis of the malware-generated artifacts in C:\ProgramData\ and C:\ProgramData\SystemData folders, and also observe results from the earlier dynamic analysis, to determine event execution. This aids in developing a holistic incident timeline. 

﻿

NOTE: For this timeline investigation, the igfxCUIService process and the persistence mechanism have been disabled to preserve timestamp evidence. 

﻿

Workflow
﻿

1. Open the VM ls-wkstn-3. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿

2. Review the artifacts, and answer the questions that follow.

﻿

Keep the VM ls-wkstn-3 open, as it is used in the next exercise.


<img width="1407" height="736" alt="image" src="https://github.com/user-attachments/assets/bf5a6b43-767b-446e-a356-35de3258d936" />
<img width="1160" height="705" alt="image" src="https://github.com/user-attachments/assets/46fa9658-275b-4fca-a3f0-871f0ca83897" />

-------------


Incident Response Timeline Overview
A timeline is a series of events deemed to be important and plotted on a line sequentially. Types of timeline events vary but may include when a certain process was first seen, when an email was received, or when a machine experienced a system reboot. The creation of a timeline aims to aid an investigation by providing context to the speed and scope of the infection. Timelines are created using data that includes a time and date and that is associated with a key event. Critical skills in creating a timeline are event analysis and correlation. Analysts must review, digest, and organize a large amount of data to discover the sequence of events.

﻿

Figure 27.4-3 shows a timeline of a malware infection that includes the planting and opening of a malicious document and the establishment of a C2 channel. Each event on the timeline is established by identifying and collecting an associated artifact. The associated artifact includes a timestamp that allows analysts to place the event on the timeline. 


<img width="1667" height="488" alt="image" src="https://github.com/user-attachments/assets/2948196b-c2a8-4632-97df-0f7531574df3" />


-------------


Establish Timestamps for an Incident Response Timeline
Complete the steps in the following workflow to discover timestamps associated with artifacts from an incident investigation.  

﻿

Workflow
﻿

1. Ensure that the VM ls-wkstn-3 is open. If it is not open, log in with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Review artifacts found on the host during the investigation.

﻿

Answer the following questions.




----------------

Investigation Results
With the rapid response and identification of an IOC, the All-Source Analyst identifies the malware as the SysJoker. SysJoker malware is a recently developed, multi-platform backdoor that targets Windows, Mac, and Linux Operating Systems (OS). 

﻿

Upon further research, the CPT recommends additional mitigation strategies for Intrusion Detection Systems (IDS) or Intrusion Prevention Systems (IPS) through custom-developed detection rules. 

﻿

The CPT IR investigation resulted in the timeline shown in Figure 27.4-3 and the event correlation table shown in Table 27.4-4: 



<img width="1088" height="2048" alt="image" src="https://github.com/user-attachments/assets/55ba5d3b-e5ba-4344-a7a8-75d55dc5da74" />



------------------


### CDAH-M28L1-Analyzing a Compromised Host ###

Host Incident Response and Forensics
When an incident is suspected on a host, analysis and forensics must begin immediately. As covered in prior Cyber Defense Analyst – Host (CDA-H) lessons, the IR process begins by identifying whether an incident has occurred and the initial impacts to operations. The process of identifying the initial compromise of a host requires an understanding of certain tools as well as providing IOCs for analysis. IOCs found in diagnosing an incident occurrence are crucial to all stages of the IR process. Additionally, the tools used to identify IOCs, such as Autopsy and Volatility, are often used for later stages of the IR process, including evidence gathering.

------------------

Review of Host Forensics Tools
The following are common tools used for host forensics.

﻿

Forensic Toolkit
﻿

Forensic Toolkit® (FTK®) is a full suite of tools to conduct forensic analysis. The following are common capabilities of FTK:

Process forensic images
Decryption and password cracking
Parsing of registry files
Visualizations

FTK® Imager is available as a stand-alone, free tool and can be used to create forensic images. Forensic images can be used for analysis and serve as a great tool for identifying nefarious activity or suspected malware on a compromised host.

﻿

Autopsy
﻿

Autopsy is used to forensically analyze disks or disk images to identify artifacts of malicious activity. Autopsy can be used to analyze malware behavior as well as extract artifacts and full malware. In conjunction with FTK Imager, Autopsy provides an open-source solution for conducting full-disk forensic analysis.

﻿

Volatility
﻿

Volatility is used to capture images of memory in a compromised host. This preserves the state of memory that a system is in when an attack occurs. Volatility can also be used to analyze and extract artifacts of malware activity. Volatility has custom plug-ins that can be used to provide new capabilities, such as VolDiff, which adds a memory malware footprint analysis. 

﻿

Cuckoo Sandbox
﻿

Cuckoo Sandbox is a sandbox tool equipped with automated malware analysis. Cuckoo executes malware in a sandbox environment and then provides an automated report of the malware behavior. This report can be used to identify artifacts and additional compromises caused by the malware.


-----------


Extracting Indicators of Compromise with Forensics Tools
Extracting IOCs with Volatility
﻿

Understanding the state of a compromised machine depends on gathering a snapshot of the memory of a compromised host. This can be done with Volatility and its memory-imaging capability. Volatility creates a .vmem file, which is a snapshot of the host’s memory and provides access to all processes and functions running at the time of creation. If malware or malicious processes are running, they can be identified through analysis of this image.

﻿

Conducting analysis with Volatility is possible by directly analyzing the memory image or by using plug-ins to automate some analysis for specific behaviors. Volatility plug-ins can be used to detect specific activities, such as malware in Hypertext Transfer Protocol (HTTP) packets found in memory images. Malicious processes or artifacts found in memory can be extracted using Volatility.

﻿

Memory Malware Extraction Process
﻿

Identification of profiles is a necessity to ensure that Volatility can scan properly. The profile is based on the type of image being used. Identifying the needed profile is done with the kdbgscan command:

$ python vol.py -f (Insert Image Name) kdbgscan
﻿

Once a profile has been identified, Volatility can be used to scan and analyze the memory image. The command pslist can be used to display the processes running on the system at the time of the image capture:

python vol.py -f ~(Insert Image Name) --profile=(Insert profile found in kdbgscan) pslist
﻿

If a malicious process is suspected and an analyst wants to conduct further analysis, the process can be extracted using the procdump command. This command extracts the executable, and other tools, such as Cuckoo Sandbox, can be used to further analyze the executable for malware.

python vol.py -f (Insert Image Name) --profile=(Insert profile found in kdbgscan) procdump -D dump/ -p (Insert Process Name)
﻿

Many other commands are available through Volatility to meet specific situations and needs. Analyzing the memory of an image can be a giveaway to malicious activity that occurred on a host. Analysts must understand how to use Volatility to adequately defend and eradicate during ongoing incidents. 

﻿

Extracting IOCs with FTK/Autopsy
﻿

Creating forensic disk images is key to understanding the state of a compromised system, enabling analysis of the malware artifacts. FTK Imager can create these forensic images, and FTK or Autopsy can provide analysis capabilities for forensic disk images.

﻿

Autopsy has automated and manual tools that allow for the inspection of forensic images and help to find artifacts of malicious activity. Malware and artifacts can be extracted from these images for further analysis. 

﻿

For this lesson, Autopsy is used to analyze and extract IOCs.

﻿

Disk Malware Extraction Process
﻿

Using Autopsy is simpler than using other command-line tools due to its intuitive User Interface (UI). The UI allows the user to select forensic images to ingest and inspect. The process for inspecting images with Autopsy is as follows:

﻿

1. Create a Case: A case is a container for data sources that must be created before data is analyzed.

2. Add a Data Source: Data sources are added to the case. Data sources include disk images or local files.

3. Analyze with Ingest Modules: Ingest modules operate in the background to analyze the data. Results are posted to the interface in real time and provide alerts as necessary. 

4. Perform Manual Analysis: The user navigates the interface, file contents, and ingest module results to identify the evidence.

5. Generate a Report: The user initiates a final report based on selected tags or results.

﻿

Figure 28.1-1 illustrates this process:

<img width="1667" height="834" alt="image" src="https://github.com/user-attachments/assets/7f29e95b-b6c5-4d83-98c9-3f519c9b8247" />


Autopsy can provide numerous artifacts for analysts to identify compromise of a host. Autopsy also helps provide details to ensure that threats can be eradicated further in the IR process


-------------


Malware Analysis
After malware has been extracted, additional steps can be taken to analyze the full extent of the malware’s capabilities and follow-on actions that the malware may have conducted. A sandbox environment is needed for this analysis.

﻿

Cuckoo Sandbox provides the capability to execute malware in a safe environment while also providing automated malware analysis. Cuckoo creates a malware behavior report that provides details on the malware capabilities and the extent of the malware’s infection in the sandbox. The attached Portable Document Format (PDF) file provides an example of a Cuckoo malware report.





-----------------


Perform Host Forensic Analysis
A user reports that their system has been acting strangely and the company’s firewall has been reporting strange traffic originating from the system. The machine has been forensically imaged. The following lab demonstrates performance of host malware analysis:

Locate the malware on the system.

Extract the simulated malware using Volatility/Autopsy.

Extract malicious behavior from the malware using Cuckoo Sandbox.

Analyze memory for additional IOCs using Volatility, and extract IOCs from the disk image using Autopsy.


Identify the Malware for Analysis
﻿

Complete the steps in the following workflow to identify the malware to be analyzed, using Volatility.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) cuckoo. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!
﻿


2. Open the desktop folder Lab1, right-click and select Open in Terminal.

﻿


3. Run the following command to determine the type of profile needed to examine the memory capture:

volatility imageinfo -f Lab1.vmem
NOTE: Check all commands for errors after pasting them into a terminal.﻿

﻿

The output clarifies that the best profile for this memory capture is WinXPSP2x64.

﻿


4. Run the following command to analyze processes in the memory image:

volatility pstree -f Lab1.vmem --profile=WinXPSP2x64
﻿

The output shows that an executable that should not be there is running in memory. The executable, toteslegit.exe, is not a normal Windows executable and should be examined further.

﻿


5. Run the following command to view the open connections on the system when the memory was captured:

volatility connscan -f Lab1.vmem --profile=WinXPSP2x64
﻿

Two listed connections are returned. Two identical Process Identifiers (PID) are returned for the same process. This is because one is in physical memory, or Random Access Memory (RAM), and the other is mirrored in the system pagefile. They both point to the same PID, which is listed in the command from Step 4. The PID is attached to the executable toteslegit.exe, whose associated PID is 2660.

﻿

Extract the Malware, and Make It Available for Analysis 
﻿

Complete the steps in the following workflow to extract the executable from the disk image and make it available for malware analysis.

﻿

Workflow
﻿

1. Open a web browser, and input the Uniform Resource Locator (URL) localhost:9999/autopsy to access the running Autopsy web service.

﻿

2. Select New Case.

﻿


3. In the Case Name field, enter toteslegit, and select New Case at the bottom of the page.

﻿


4. Select Add Host on the next screen.

﻿


5. Select Add Host.

﻿


6. Select Add Image.

﻿


7. Select Add Image File.

﻿


8. In the Location box, enter /home/trainee/Desktop/Lab1/Lab1.E01. Leave the Type selection as Disk and the Import Method as Symlink.

﻿


9. Select Next at the bottom of the page.

﻿


10. Select Add.

﻿


11. Select OK.

﻿

The next screen lists the file image options.

﻿


12. Select the radio button next to C:/, and select Analyze under it.

﻿


13. Select File Analysis at the top of the screen.

﻿


14. Enter toteslegit in the File Name search box.

﻿

The first file returned is the malicious executable file.

﻿


15. Select the name of the malicious executable to view the contents of the file.

﻿

Because the file is a compiled binary, it is not possible to see all of its contents. 

﻿


16. To save the file to disk so that it may be examined in a malware sandbox, select Export, and select Save File when the dialog box appears.

﻿

Analyze the Malware
﻿

Complete the steps in the following workflow to analyze the malware using Cuckoo Sandbox.

﻿

Workflow
﻿

1. Open a web browser, and enter localhost:8080 in the address bar.

﻿


2. In the Cuckoo Sandbox interface that appears, select Submit a file for analysis.

﻿


3. In the dialog box, select Downloads to access the directory that the malicious executable is saved in.

﻿


4. Select the malicious file, vol2-C.Documents.and.Settings.Administrator.My.Documents.toteslegit.exe, to load it into Cuckoo for analysis.

﻿


5. Select Analyze in the upper right corner of the window that opens.

﻿


When the analysis is complete, the status indicator on the right side changes from Running to Reported.

﻿

6. Select the name of the file to open a new tab displaying the results of the scan.

﻿


7. Scroll down the summary window, and view the findings. 

﻿

Stealthy malware sometimes returns few findings in a malware sandbox due to features that prevent detection. Malware authors commonly use a custom packer that can obfuscate the contents of the malware from scanners. The malware in this workflow has been packed in this way.

﻿

8. Review the Signature findings and Behavioral Analysis tabs in Cuckoo to review details of the malware as shown below:



<img width="1358" height="445" alt="image" src="https://github.com/user-attachments/assets/b34a9d9d-c1d4-4f24-87ee-b0a74becd6bf" />

<img width="1244" height="591" alt="image" src="https://github.com/user-attachments/assets/e79f25f5-26a0-45f1-9a66-10bd9ac49921" />

The behavioral analysis tab is visible through the menu on the left side of Cuckoo’s display. 


Use this workflow to answer the following questions.


Keep the VM open, as it is used in an upcoming workflow


-------------


Attack Entry Points
When an incident is suspected, it is important to identify the primary entry point of the malware. The primary entry point is generally found when gathering evidence in the incident. Identifying this initial entry is key to understanding the depth of the attack and helps to improve defenses when remediated.

﻿

However, when malware compromises a host, additional entry points are often created. These attack vectors are referred to as secondary and tertiary entry points. A secondary entry point is an alternative entry point that an attacker provides for themselves to ensure accessibility to a system or network. Tertiary entry points can be any number of additional entry points created by the attacker to further ensure accessibility to a system or network. Both secondary and tertiary entry points incorporate the same techniques. All additional entry points, including both tertiary and secondary, provide new methods of entry so that defenders have more difficulty stopping the attack. Identifying additional entry points is critical to completely remediating a compromised host.

﻿

Identifying attackers’ additional entry points requires an understanding of common secondary and tertiary threat actor entry points. Common techniques for creating additional entry points include the following (and are shown in Figure 38.1-2):

Finding additional exposed or insecure assets.
Removing security controls.
Sending phishing emails.
Generating backdoors.
Creating new accounts.
Performing drive-by downloads.
﻿
<img width="1667" height="834" alt="image" src="https://github.com/user-attachments/assets/930ad4b9-92d1-4a36-9a41-a2fc5a46baa1" />


When reviewing an incident, analysts must trace all activity conducted by the attacker to identify secondary or tertiary entry points and prevent future follow-on compromises of the attack. Entry points can be detected through such methods as analysis with Volatility or Autopsy, and Cuckoo Sandbox can also identify some entry methods associated with malware.


-------------

Identify Additional Attack Entry Points
An attacker recently targeted an organization with a phishing campaign. The phishing emails had a malicious executable attached and were used to establish a foothold in the organization’s systems. In the following lab, discover an additional entry point and analyze the activity that resulted from its use.

﻿

Find a Phishing Email Attack Entry Point
﻿

Complete the steps in the following workflow to find a phishing email in memory and extract the URL of a malicious link in the email, using Volatility.

﻿

The VM should still be open from the prior workflow. If it is not open, log in using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

Workflow
﻿


1. Open the desktop folder Lab2, right-click and select Open in Terminal.

﻿


2. Run the following command to determine the type of profile needed to examine the memory capture:

volatility imageinfo -f Lab2.vmem
﻿

The output shows that the best profile for this memory capture is WinXPSP2x64. 

﻿


The user reports that the email was in their inbox and that they saved the email to their My Documents folder with the filename important!. 

﻿

3. Run the following command to locate the file in memory:

volatility -f Lab2.vmem --profile=WinXPSP2x64 filescan | grep important
﻿


The returned output shows a single email and a link file. The first returned result is the saved email in the user’s My Documents folder. 

﻿

4. To extract the email from the memory capture, run the following command:

sudo volatility -f Lab2.vmem -–profile=WinXPSP2x64 dumpfiles –Q 0x0000000002ea3720 –n –D /home/trainee/Desktop/Lab2
﻿

This command extracts the email message and saves it to the Lab 2 folder with the filename file.None.0xfffffadfe74e7cf0.important!.eml.dat.

﻿


5. To view the contents of the email, run the following command:

strings 'file.None.0xfffffadfe74e7cf0.important!.eml.dat'
﻿

Using this workflow, answer the following question.

﻿

Keep the VM open, as it is used in the next workflow.


---------------------


Find a Drive-By Download Attack Entry Point
Complete the steps in the following workflow to find the URL in memory of a drive-by download and extract the URL of the malicious link, using Volatility. 

﻿

The VM should still be open from the prior workflow. If it is not open, log in using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

Workflow
﻿


1. Open the desktop folder Lab3, right-click and select Open in Terminal.

﻿


2. Run the following command to determine the type of profile needed to examine the memory capture: 

volatility imageinfo -f Lab3.vmem
﻿

The output shows that the best profile for this scan is WinXPSP2x64.

﻿


3. Run the following command to check the process list to see which web browser the user was running:

volatility –f Lab3.vmem --profile=WinXPSP2x64 pslist
﻿

﻿IEXPLORE.EXE is running on the system, with PID 648.

﻿

4. Execute the following command to pull the browser history from memory and identify the malicious link:

volatility –f Lab3.vmem –-profile=WinXPSP2x64 iehistory
﻿

Use this workflow to answer the following question.


-----------------


### CDAH-M28L2-Breach Scoping and Evidence Gathering ###


Gathering Threat Intelligence
Understanding the depth of an attack allows Host Analysts to defend against malicious threat actors. The investigation begins as soon as an initial breach is discovered. 

﻿

Having a clear methodology for gathering threat intelligence allows Host Analysts to use their time and resources efficiently. After an incident has occurred and been properly identified, threat intelligence must be gathered, as seen in Figure 28.2-1 below.

﻿

The four steps, or phases, of the process of gathering threat intelligence are as follows:

Scope
Analyze
Extract
Report

<img width="2048" height="675" alt="image" src="https://github.com/user-attachments/assets/685e55ec-4ef7-4d47-b9ce-6fbd16924bf0" />



Each phase of the intelligence-gathering and reporting process relies on one another. If the scope of an investigation is not fully known, but the team moves to the analysis stage anyway, there may be critical assets breached by an attack that go unnoticed due to improper categorization of the scope of the event. 


The same principle applies to each phase of this process. Each phase must be thoroughly conducted in order to adequately perform investigations and incident response.



---------------

Scoping, Analyzing, and Extracting Evidence
Identify the Scope
﻿

If a breach occurs, defensive operators must gather a thorough understanding of all affected assets and software. 

﻿

This process is known as Breach Scoping, as seen in part one of Figure 28.2-2 below:


<img width="2048" height="1024" alt="image" src="https://github.com/user-attachments/assets/c4b891a1-f336-4b61-aaf5-f4ef55e277cc" />

Breach Scoping helps cyber defense analysts understand the entirety of a threat, and provides assets for the investigation. After an attack has occurred, analysts must survey the organization’s network for indicators of assets that may be potentially involved in the scope of the attack. 


Common tools for identifying potential attacker activity are Security Incident and Event Management (SIEM) systems, and Intrusion Detection Systems (IDS). These tools help generate alerts and allow analysts to search and view devices that have evidence of threat actor activity. 


When identifying the scope of the breach, specific searches are conducted to determine all involved assets. Searches help create a list that can be used to categorize all possible devices that may have been accessed by threat actor activity. Once all assets involved in the scope of the attack are identified, defenders can start gathering threat intelligence.


Gather Evidence


When a breach occurs, an investigation must be opened. After initial access and the scope of the breach has been identified, finding key details of threat actor activity is the next step. This process is referred to as Acquiring Cyber Threat Intelligence (CTI).


Analyze and Extract Evidence


As with the breach scope, a SIEM can be used to identify threat actor activity and potentially malicious software. Additionally, an IDS may discover malware in transit across the network. 


Identifying malicious activity leads to analyzing any malicious files and software. Threat actors often execute malicious files after breaching networks. In order to understand the malware, any afflicted assets must be quarantined and forensic images should be created of their memory and disks. 


The quarantining process is dictated by the organization’s Incident Response Team (IRT). The IRT is responsible for executing the quarantine process (if possible) for any afflicted devices. When a device is quarantined, the forensic images can be used to transport the state of the system, as well as to retain any malware or malicious activities. Once images are created, specialized tools can be used to analyze the images and find threat actor activity. 


Extracting Evidence with Volatility and Autopsy
Volatility can be used to analyze and gather evidence of additional threat actor activity. In the memory images of an attacked device, artifacts are left behind. These artifacts can be used to identify specific actions that occurred, or files that were executed.


If a malicious file is executed, the file can be analyzed and extracted. Autopsy works similarly to Volatility, but with system disk images. Any malicious files or traceable actions left on system disks can be analyzed and extracted using Autopsy.


Executing Malware with Cuckoo
When malware is extracted by Volatility or Autopsy, the malware can be executed in a safe environment, such as Cuckoo. Cuckoo helps identify the characteristics of a malicious file, such as activities caused by malware. Cuckoo generates a report of the malware that provides details such as a rating of the malware’s malicious capability, actions capable by the malware, and more. 


Once evidence has been gathered, a full report can be created of the incident.


-------------------



Identify the Scope
An attacker used malware to compromise multiple hosts on an organization’s network. Initial malware delivery results in the compromise of one host and the attacker pivots with additional malware to compromise additional hosts. 

﻿

Use Elastic to identify the scope of the breach and determine indicators of additional compromised hosts.

﻿

Workflow
﻿

1. Log in to the Virtual Machine (VM) cuckoo-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Open Firefox and go to the Elastic instance by entering the following address:

https://199.63.64.92/
﻿

3. Log in to Security Onion with the following credentials:

Username: trainee@jdmss.lan
Password: CyberTraining1!
﻿

4. Select Kibana from the left pane. 

﻿

5. Set the Time Range filter to Feb 7 2023 between 13:30 and 13:50.

﻿

Scope the breach of the attack by finding any devices connected to the attacker’s Internet Protocol (IP) address. The details from the initial attack were reported as coming from user Tammy Wall. 

﻿

6. Enter the following filter to see logs from this user:

user.name: tammy.wall
﻿

The host IP of the device used by tammy.wall is 172.16.4.4. The device usage details can be inferred since the source.ip field is part of the internal subnet and presents login and connection data for this user. This activity is not considered irregular. 

﻿

7. On the Available Fields menu, select the Destination IP field to see a list of the top IPs with which this device opened connections.

﻿

Any IPs within the 172.16 subnets are part of the organization. As seen in Figure 28.2-3 below, the IP 104.53.222.103 is likely not part of the organization. 

<img width="494" height="731" alt="image" src="https://github.com/user-attachments/assets/c8231a0e-1d71-4251-ba47-9ccb91885c1d" />

8. Locate 104.53.222.103 and select Add as Filter to further explore the connection. 


A single log is displayed about a network connection detected between 172.16.4.4 and 104.53.222.103. 


9. Examining this connection by scrolling down to the message section of the log as seen in Figure 28.2-4 below:


<img width="1888" height="793" alt="image" src="https://github.com/user-attachments/assets/9063e31f-965f-4929-ba7c-e0adc2e060c4" />

From this message, the image C:\Users\tammy.wall\Downloads\stream-installer.exe is identified as the initiator of the connection. This indicates an internal device opened a connection to this device via a file on the system.


To further identify connections from the remote host, a filter can be used to show if any other connections were established containing that IP. 


10. Remove the current filter and apply the following filter to view any logs containing the remote IP:
agent.type: winlogbeat AND 104.53.222.103



The only log displayed is the one found from the previous search. This indicates that this IP was only used to establish connection to this host. However, the attacker could have established further communications by using their connection to 172.16.4.4, or could have altered their IP address for certain attacks. 


A key element of the message is from the stream-installer executable. To view activity resulting from this connection, create a filter to see if a similar connection was used.


11. Apply the following filter to see any other logs containing the stream-installer executable:
agent.type: winlogbeat AND “stream-installer.exe”



12. Expand the first log and identify the destination and host IPs.  


13. Identify the IP that belongs to eng-wkstn-3. This connection illustrates that the victim box connected to the device 172.16.2.5 on the network with the same malicious file stream-installer.exe. 


14. Locate the filter file.target and select Visualize to view the full names of the values. Analyze the results. 


15. Select Back to navigate to the discover Kibana page.


16. Enter the following filter to include searching for the discovered executable:
agent.type: winlogbeat AND “stream-update.exe”



17. Analyze the new search results for additional devices. Select destination.ip from the Filter menu to view destination addresses.


The address appears similar to the same external IP address found earlier, 104.53.222.103. This is another external address being called to by the executable. 


18. Select the host.ip filter in the left menu to view connected devices, as shown in Figure 28.2-5 below.

<img width="495" height="624" alt="image" src="https://github.com/user-attachments/assets/4619dc33-b384-4eef-8e67-0f38b5fc663f" />


The previous IP from eng-wkstn-3 is present as 172.16.4.4. The new IP 172.16.3.3 is associated with the host bp-wkstn-2. This workstation is shown to be communicating with the 104.53.222.92 address. Further examination of the logs from this search show that no other connections were created to other workstations involving the suspected processes. 


This portion of the investigation shows the scope of the attack

<img width="1089" height="669" alt="image" src="https://github.com/user-attachments/assets/8168cc0f-df7b-40d5-9e52-16a357485ac7" />


------------------

Gather Threat Intelligence
The scope of the breach has been identified. The devices involved were quarantined and images have been provided to the CPT for analysis. 

﻿

Use Volatility to analyze the eng-wkstn-3 memory image, extract initial malware and secondary malware, and perform malware analysis in Cuckoo.

﻿

Workflow
﻿

1. Log in to the VM cuckoo-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Right-click the Evidence folder on the Desktop, and then select Open in Terminal.

﻿

The profile of the memory image in evidence, memdump.mem, needs to be identified. The imageinfo command returns this value, but the command can take up to ten minutes to complete. 

﻿

In order to save time, the imageinfo command output is displayed in Figure 28.2-6 below:


<img width="2048" height="683" alt="image" src="https://github.com/user-attachments/assets/f73a5222-ae3c-4af2-b76f-b9d883ae3395" />

4. Run the following command to identify processes from the memory dump image using the profile Win10x64_14393:
vol.py psscan -f memdump.mem --profile=Win10x64_14393



5. Search the output and determine if the files identified in the previous Kibana analysis are running. 


6. Analyze the psscan output, as seen in Figure 28.2-7 below, and identify the PID of processes stream-update. and stream-install: 
<img width="2048" height="627" alt="image" src="https://github.com/user-attachments/assets/744ba4df-3301-4ea0-8407-fc0bfe27d84c" />

7. Run the following command to perform a scan of the full path of stream-update. using PID 1740:
vol.py cmdline -p 1740 -f memdump.mem -–profile=Win10x64_14393



The output confirms this is the same executable found running in Kibana.


8. Run the following command to perform a scan of the full path of stream-install using PID 4328:
vol.py cmdline -p 4328 -f memdump.mem -–profile=Win10x64_14393



Again, the output confirms that this is the same executable found in Kibana.


9. For further analysis, the process must be extracted to identify malicious activity. Use the following commands to extract the process to the Extracts folder:
vol.py procdump -p 4328 -u -f memdump.mem -–profile=Win10x64_14393 –-dump-dir=Extracts/



10. Use Cuckoo to analyze extracted files for malware. Open a Terminal window and run the following command:
cuckoo web



11. Open Mozilla Firefox and navigate to the following address:
localhost:8000



12. In the Cuckoo web browser, select Submit A File For Analysis.


13. Navigate to /Desktop/Evidence/Extracts and select executable.4328.exe.


14. Select Analyze.


15. Once the task is finished, the file status should change to Reported. Select executable.4328.exe to review the analysis summary.


The file displays a threat score of 6.2 out of 10 due to numerous signs of malicious behavior.


The behaviors identified in the sandbox, shown in Figure 28.2-8 below, indicate that the file is a packer with a callout to a remote.

<img width="1779" height="519" alt="image" src="https://github.com/user-attachments/assets/0170006e-830c-4f27-8a06-cedb6c38c818" />

17. For the stream-update.exe file, perform Step 10 to Step 13. This file has already been extracted to the /home/trainee/Desktop/Evidence/ folder. 


Use the Cuckoo report to answer the following questions



------------------------

Reporting Threat Intelligence
Creating a report of an incident is a thorough process. Many organizations have specific criteria for what must be included in an incident report. 

﻿

Creating an Incident Report
﻿

The Cyber Warfare Publication (CWP) 3-33.4 explains reporting requirements for Cyber Protection Teams (CPT). CPTs report through their Operational Control (OPCON) chain of command. All actions taken by CPTs are reported to the U.S. Cyber Command (USCYBERCOM), Joint Force Headquarters–Department of Defense Information Network (JFHQ-DODIN), and the network commander. Reports are shared with other organizations, when possible, as a courtesy regarding situational awareness. 

﻿

According to the CWP 3-33.4, reports must include the following details:

Root cause of issues
Indicators of Compromise (IOC)
Malware observed, identified, or discovered
Detection techniques and observables
Actions taken to address the issue
Impact to the supported mission
In the private sector, a similar approach is applied. However, reports made in the private sector vary by organization, and may require additional details about an incident. Additionally, private sector reporting may be subject to regulations or common practices that result in public disclosure of the incident. 

﻿

Using Incident Reports
﻿

After a report is created, a comparison can be made to determine if the activity is attributed to threat actor groups, or Advanced Persistent Threat (APT) groups. When behavior of the attacker matches or is similar to the known behavior of APTs, this information must be added to the report. 

﻿

Well-supported organizations have an IRT to respond to incidents. All details of discovered malware must be directly reported to the organization’s IRT. When reporting to the IRT, any details that can lead to further damage in the organization must be relayed immediately. 

﻿

For example, if a defensive analyst is analyzing malicious activity on a quarantined host and discovers activity of the threat actor pivoting to other devices on the network, those devices may also need to be quarantined. This activity should be reported to the organization’s IRT. Interactions with the IRT should be continuous throughout the investigation.
+


--------------

### CDAH-M28L3-Eradicate Threats and Restore Connectivity ###

Containment, Eradication, and Recovery
The IR life cycle consists of four phases:

Preparation
Detection and Analysis
Containment, Eradication, and Recovery
Post-Incident Activity
﻿Figure 28.3-1 displays these four phases of the continuous IR life cycle:


<img width="2500" height="1253" alt="image" src="https://github.com/user-attachments/assets/77a044c8-c5b7-4f8a-83bd-c8309803bb3d" />


When Cyber Protection Teams (CPT) are not actively responding to an incident, they are in the Preparation phase of IR. In this phase, CPTs maintain readiness through deliberate mission planning, preparation, execution, and assessment. A CPT’s work in IR is intended to supplement a local organization’s network defenders. When CPTs arrive onsite, they enter the Detection and Analysis phase by conducting their own Mission Analysis (MA). A CPT begins the Containment, Eradication, and Recovery phases of IR only after the operation has been approved, in accordance with the processes and tasks determined during the earlier phases of IR. This lesson addresses this third phase. 


Procedures Performed on Compromised Hosts


In the Containment, Eradication, and Recovery phase, procedures are reactive in nature, as an incident has occurred and hosts are compromised. Procedures in this phase are designed to prevent the spread of the adversarial presence in the network. Such procedures are performed directly on the compromised hosts and include isolating the hosts from the operational network (removing all network connectivity and placing in a sandbox environment), removing all adversarial presence (removing all malware and indicators associated with the incident), and returning the hosts to the operational network (verifying the adversarial presence is removed). The adversary can infect hosts using various methods. During this phase, analysts may be required to perform a wide range of tasks. Some tasks may include removing executable (.exe) files, registry keys, network connections, and user accounts. When the procedures in this phase are complete, the hosts are no longer compromised and may return to the operational network.



---------------


Analyze a Compromised Virtual Machine
Scenario
﻿

An incident has occurred within the network. Recently, remote service application malware was found operating on VMs within the network. When executed, the malware initiates a Remote Access Trojan (RAT) where code is executed on the infected VM remotely. The incident is contained within the win-admin VMs located in the Information Technology (IT) subnet of the network. The win-admin VMs are used by IT administrators and contain large amounts of sensitive information regarding the organization’s IT infrastructure, mission, and users. 

﻿

Upon detecting the malware, the IR team quickly enacted the Containment, Eradication, and Recovery phase of the plan. The Containment portion of the phase was completed by removing and isolating the infected VMs from the operational network. To discover artifacts and functionality of the malware, dynamic analysis was completed. Table 28.3-1 provides the findings of the dynamic analysis: 

﻿
<img width="2500" height="2235" alt="image" src="https://github.com/user-attachments/assets/b249b575-5074-4a60-8fbd-aa4148c2a43a" />


The Containment portion of the IR plan is complete. The IR team has removed and isolated all infected VMs from the operational network and has moved to the Eradication portion of the phase, where the VMs are analyzed for malicious artifacts. Any artifacts found are removed. 


Assist the IR team by accessing the win-admin-2 VM and identify locations where the eradication needs to occur. Not all findings listed on the attached Incident Response Findings document may be currently present on the win-admin-2 VM.


Workflow


1. Log in to the VM win-admin-2 with the following credentials:
Username: Trainee
Password: CyberTraining1!



2. Analyze the VM, and identify artifacts on the VM. Answer the following question.



--------------------


Identifying Threats
The VM win-admin-2 includes the following findings.

﻿

Malicious Executables and Applications
﻿

dc.exe is found within the C:\Users\trainee\Downloads directory. Figure 28.3-2 confirms that the dc.exe file found is a Remote Service Application


<img width="500" height="649" alt="image" src="https://github.com/user-attachments/assets/6b269a0d-e10e-4c79-bb62-3aec60db0b33" />

The DarkComet-RAT-5.3.1-master folder, containing the DarkComet application, is located as a hidden folder within the C:\Program Files directory.


Microsoft Defender SmartScreen


Microsoft Defender SmartScreen protects against phishing or malware websites and applications and against downloads of potentially malicious files. By disabling SmartScreen, one of the host’s first lines of defense is removed. Figure 28.3-3 displays Check apps and files “Off”:

<img width="402" height="350" alt="image" src="https://github.com/user-attachments/assets/f5a9f533-2221-422a-97c9-d3eeaae42ac6" />


RDP


Remote Desktop Protocol (RDP) allows for remote connections to the host. The RDP setting is available via System settings. The setting is useful for administrators and engineers but can also be maliciously leveraged by the adversary. The Enable Remote Desktop setting should only be “On” for known reasons and expected work. Figure 28.3-4 displays RDP “On”:

<img width="514" height="352" alt="image" src="https://github.com/user-attachments/assets/28c93231-4012-4e60-a911-ff2b94b80d40" />




---------------------


Eradicate Threats
Complete the steps in the following workflow to eradicate threats that have been identified on the VM win-admin-2.

﻿

Workflow
﻿

1. Log in to the VM win-admin-2 with the following credentials:

Username: Trainee
Password: CyberTraining1!
﻿

2. Complete the eradication portion of the win-admin-2 VM by completing the following tasks:

Delete dc.exe and the DarkComet-RAT-5.3.1-master file and directory.
Set the Check apps and files setting to “On” within Windows Defender SmartScreen.
Set the Enable Remote Desktop setting to “Off.”

Once the tasks in Step 2 are complete, the threats on the VM have been eradicated.

-------------

Recovery
During the Recovery portion of the Containment, Eradication, and Recovery phase of the IR life cycle, procedures focus on confirming and validating the completion of each task in the Eradication phase. Procedures are performed directly on the compromised host during Recovery and may include analyzing the host for any unidentified adversarial presence, confirming removal of all adversarial presence, and enabling connectivity to the operational network. When the procedures in this portion of the phase are complete, the host no longer contains adversarial presence and may return to the operational network.

﻿

Aid Recovery with Sysinternals
﻿

The Windows Sysinternals suite allows for quick and efficient monitoring, managing, and troubleshooting of processes within the Windows Operating System (OS). Sysinternals was installed on the compromised VMs to aid in IR efforts. Access the win-admin-2 VM, and, using Sysinternals, check for any remaining adversarial presence.

﻿

Workflow
﻿

1. Log in to the VM win-admin-2 with the following credentials:

Username: Trainee
Password: CyberTraining1!
﻿

2. Access Sysinternals at C:\Users\trainee\Desktop\SysinternalsSuite. 

﻿

3. Open Autoruns64, and let Autoruns64 scan for 3 minutes.

﻿

4. Analyze the data contained within Autoruns64, and review the data for any use of DarkComet and associated .exe files. 

------------------


Additional .exe File
Figure 28.3-5 shows the Autoruns data that reveals the IMDCSC.exe file associated with the DarkComet RAT:

<img width="1929" height="165" alt="image" src="https://github.com/user-attachments/assets/875cb3c6-41fa-4ea3-a8d9-e8dff64699d5" />

The IMDCSC.exe file is executing out of HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run within the registry. IMDCSC.exe is typically found within the Documents folder of the host and is used by applications for remote access. IMDCSC.exe does not have a visible window and is started by the entry in the registry. IMDCSC.exe is able to record keyboard and mouse inputs, manipulate other programs, and monitor applications.

<img width="1920" height="831" alt="image" src="https://github.com/user-attachments/assets/77ff7875-b8a6-4110-a8c1-8f6b567c195f" />
<img width="1088" height="459" alt="image" src="https://github.com/user-attachments/assets/db4487ab-9a8c-4804-a358-59c332b17085" />

--------------

Scheduled Task
Figure 28.3-6 shows the Autoruns data that reveals the IMDCSC.exe file associated with the \RSA scheduled task:

﻿<img width="1547" height="122" alt="image" src="https://github.com/user-attachments/assets/d9765d2c-32b0-434c-ad7f-4643c236924d" />

The scheduled task allows for an additional layer of persistence on the compromised host. The registry entry and scheduled tasks both allow the IMDCSC.exe file to start on the host.


Summary


With the aid of the Sysinternals suite, the compromised win-admin-2 host recovery efforts were examined. Through the use of Autoruns, an additional .exe file and subsequent persistence techniques were discovered. Each of the new adversarial components must be removed from the VM. Once the components are removed and their removal is verified, the VM may be returned to the network.

-----------------


Return from Isolation
Scenario
﻿

Continue aiding in the IR efforts. Consider the list of facts uncovered in the previous two exercises. A security baseline is a list of components that must be removed for the host’s return from isolation. Table 28.3-2 contains the secure baseline for all other hosts in the incident:


<img width="3335" height="3559" alt="image" src="https://github.com/user-attachments/assets/cc074e42-eecf-4029-b16c-39888af4b118" />


Table 28.3-3 contains Windows PowerShell cmdlets that allow for quick access to components found in Table 28.3-2. Table 28.3-3 contains only components where PowerShell speeds up access to components. Although this is possible with PowerShell, some components are easier to access through their settings location.


<img width="1600" height="823" alt="image" src="https://github.com/user-attachments/assets/ece52e12-fd55-4d23-adf7-a1a9291bf2e3" />


With the aid of Windows PowerShell and Sysinternals, evaluate the win-admin-3 and win-admin-4 VMs associated with the incident for their readiness to return from isolation by completing the next two exercises. 


Workflow


1. Log in to VM win-admin-3 with the following credentials:
Username: Trainee
Password: CyberTraining1!



2. Review and validate each component of the security baseline for the removal of adversarial presence. Answer the following question.



-------------


Security Baseline
The VM win-admin-3 includes two of the security baseline components and is not ready to be removed from isolation. All adversarial presence on the host has not been removed. Figure 28.3-7 displays the RDP setting “On” within Windows Settings

<img width="502" height="394" alt="image" src="https://github.com/user-attachments/assets/723ecc3c-b6ea-4340-840e-6fcef279b087" />


Figure 28.3-8 displays the output from Autoruns64. Although the dc.exe file was removed from the host, the \RSA scheduled task is still present on the VM


<img width="2043" height="206" alt="image" src="https://github.com/user-attachments/assets/fd7a3668-139f-4570-a417-033c015bd965" />



--------------


Further Analysis
Continue the analysis with VM win-admin-4.

﻿

Workflow
﻿

1. Log in to VM win-admin-4 with the following credentials:

Username: Trainee
Password: CyberTraining1!
﻿

2. Review and validate each component of the security baseline to validate the removal of adversarial presence. Answer the following question.
<img width="1413" height="742" alt="image" src="https://github.com/user-attachments/assets/23a47b4e-e6f5-4cde-8086-9eaa3d8bd420" />
<img width="1123" height="577" alt="image" src="https://github.com/user-attachments/assets/ca17b3e7-0f6e-46c1-9afd-fa82d4c5f4bd" />

-----------------


Further Assessment Summary
Summary
﻿

The DarkComet-RAT-5.3.1-master folder is found hidden on the VM win-admin-4. The use of the dir -force cmdlet quickly identifies the folder within C:\Program Files, as shown in Figure 28.3-9:

<img width="502" height="209" alt="image" src="https://github.com/user-attachments/assets/520c9480-d749-4266-8186-fac0ecb8dfdd" />

The DarkComet-RAT-5.3.1-master folder is empty. Although the folder does not contain any files, it must be deleted prior to the host’s removal from isolation.


------------------



### CDAH-M28L4-OPSEC Considerations in IR Processes ###

OPSEC and Incident Response
OPSEC is the process of protecting sensitive information against adversaries, as shown in Figure 28.4-1 below. 

﻿

Suppose malware was discovered on a device in a network. The functionality and origin of the malware is unknown. Maintaining OPSEC throughout the phases of IR is a priority because it allows the mission and operating environment to function without further compromise.

﻿

For example, malware can contain sophisticated capabilities, making it highly contagious to other devices that can easily compromise critical information on the network. 

﻿

Analysts must ensure that any devices found with malware are quarantined and isolated from the network. The analyst should return devices to operation only when the malware is eradicated and the incident is fully resolved. 

﻿

The five steps, or phases, of the OPSEC process are as follows: 

Identify critical information
Assess the risk
Analyze threats
Analyze vulnerabilities
Perform countermeasures

<img width="2500" height="1465" alt="image" src="https://github.com/user-attachments/assets/08633d72-6741-42af-8c89-307560c4b107" />

1. Identification of Critical Information
In the first phase, critical information is identified, defined, and recorded. Examples of critical information include, but are not limited to, the following: domains, Internet Protocol (IP) addresses, subnets, computer names, physical addresses, and Personal Identifiable Information (PII). 


2. Analysis of Threats
In the second phase, physical and virtual threats are identified. Facts such as who, what, where, when, why, and how are considered at this stage. Organizations must analyze threats by the level of impact on operations, assets, or individuals, and the likelihood of those threats occurring. 


3. Analysis of Vulnerabilities
In the third phase, an analysis of both internal and external weak points is conducted. The weak points are areas of the networks that may be exploited by adversaries. Decision makers must be honest and clear about the organization's components and configurations that may be vulnerable to attack. External components must also be analyzed during this stage. External components that are not directly controlled by the organization may include third-party software and contractors. 


4. Assessment of Risks
In the fourth phase, each portion of the organization's infrastructure is evaluated in terms of risk and exposure to the mission. Management must create a clear risk strategy that defines each level of risk and the amount of risk they are comfortable handling.


5. Application of Appropriate Countermeasures
In the final phase, a comprehensive countermeasure strategy is synthesized as a result of all previous stages. The selected strategy protects critical information, mitigates threats, patches vulnerabilities, and minimizes risk. With the strategy in place, IR personnel are able to quickly and accurately address the incident while maintaining as much OPSEC as possible.


-------------------


Enacting the IR Plan and Maintaining OPSEC
As shown in Figure 28.4-2 below, when an IR plan is put into action, compromised devices must be isolated, and threats must be eradicated


<img width="2500" height="588" alt="image" src="https://github.com/user-attachments/assets/a26da076-913e-4ca8-a354-522ade800c46" />

Isolation of Compromised Devices


The IR team must quickly remove compromised devices from the network. The longer the compromised devices remain on the network, the likelihood for further infection increases. Network backups of devices and Virtual Machine (VM) snapshots may be activated and used during this time. Compromised devices must be placed in a sandbox environment, which is an environment that is isolated from all other networks. The sandbox environment allows analysts to investigate the incident, conducting static and dynamic analysis of any malware.


Eradicating Threats


The IR team must accurately remove all adversarial presence from compromised devices. Compromised devices may have an adversarial presence in the form of malware. The malware must be statically and dynamically analyzed to record its artifacts, functionalities, and capabilities. The IR team produces a checklist once analysis is completed. The checklist identifies how the malware is removed and defines parameters that allow for a safe return of devices to the network. 


IR Recovery Checklist


Checklists are used across all IR phases to verify tasks and configurations. Recovering from an incident includes the eradication of threats on compromised devices and returning the devices to the network to resume normal operations. A recovery checklist includes items such as tasks, activities, and configurations to be verified as complete prior to a return of the network. 


Figure 28.4-3 below, and attached, is an example of a Containment, Eradication, and Recovery checklist. The checklist contains overarching tasks, but since each incident is different, specific tasks and eradication methods may change. This example is not based on the NIST documentation and is a visual example only


<img width="2500" height="2379" alt="image" src="https://github.com/user-attachments/assets/39353771-07bc-408b-864d-b38c04384c37" />


--------------

Restoring Operational Capabilities
Scenario
﻿

An administrator operating on the win-admin-2 VM opened a link from an email. The email sender posed as a user of the network who was requesting administrative support. 

﻿

Shortly after the link was opened, a security analyst monitoring the network noticed a large amount of network requests originating from the win-admin-2 VM. While addressing the request of the email, the administrator logged on to the win-admin-3 VM, and selected the link on that VM also. As a result of the opening the link, both VMs were infected with malware. 

﻿

The win-admin-2 and win-admin-3 VMs are used by Information Technology (IT) administrators. Both VMs contain large amounts of sensitive information regarding the organization's IT infrastructure, mission, and users. The security analyst quickly realized what occurred, contacted the IR team, and the IR plan was enacted. 

﻿

The IR team quickly enacted the Containment, Eradication, and Recovery phase of the plan, and isolated the win-admin-2 and win-admin-3 VMs from the network. The security analyst watched the network closely for suspicious activity, such as additional spikes in network requests. 

﻿

The IR team conducted dynamic analysis of the malware and compiled the details of their findings, as seen in Table 28.4-1 below:

<img width="2500" height="1972" alt="image" src="https://github.com/user-attachments/assets/b03c9408-db7d-4ef1-8dc4-c26fc573ef00" />


The Eradication phase of the IR plan was completed, with IR personnel removing all adversarial presence on the isolated VMs. The IR team moved to the Recovery phase, where the VMs were verified as free of malware and any other adversarial presence. 


The IR team developed a recovery checklist, based on tasks completed during the Eradication phase, to aid in the return of the VMs to the network. The recovery checklist is found below in Figure 28.4-4. 


<img width="2500" height="1906" alt="image" src="https://github.com/user-attachments/assets/7ee2718b-7379-48b2-b14f-03ca540a2378" />


------------


Post-Exploit Recovery Errors
The Windows Sysinternals suite allows for quick and efficient validation of each of the components on the recovery checklist. Errors with the post-exploit recovery process are easily identified through use of applications such as Process Explorer and Autoruns. 

﻿

The two errors found on the win-admin-3 VM are as follows: 

Lazr.exe operating on win-admin-3

StartIT is a scheduled task on win-admin-3

Error One
﻿

Process Explorer (procexp64) provides a live snapshot of all of the processes running on the VM. At the top of the application, Lazr.exe is entered as a filter, as seen in Figure 28.4-5 below. On win-admin-2, when the filter is entered, nothing is returned. This confirms that Lazr.exe is not operating on that VM. 

﻿

Figure 28.4-5 below shows the output of the filter when entered on the win-admin-3 VM

<img width="1400" height="312" alt="image" src="https://github.com/user-attachments/assets/26d17e2e-b5e8-4cbc-8286-4bfb7f7b181e" />

The output of the filter confirms Lazr.exe is operating on the win-admin-3 VM.


Error Two


Autoruns (Autoruns64) provides a live snapshot on a variety of objects such as system extensions, toolbars, scheduled tasks, auto-start services, and registry entries on the VM. At the top of the application, Lazr.exe is entered as a filter, as seen in Figure 28.4-6 below. On win-admin-2, when the filter is entered, nothing is returned. This confirms that no objects related to the Lazr.exe malware are present on win-admin-2. 


Figure 28.4-6 below shows the output of the filter on the win-admin-3 VM

<img width="2048" height="1252" alt="image" src="https://github.com/user-attachments/assets/409a03cb-102b-4ed8-bfaf-da54819873be" />

The output of the filter confirms Lazr.exe is included in the StartIT scheduled task, operating out of the C:\Users\Public\Documents directory.


Summary


With the use of the Windows Sysinternals suite, an error in recovery operations was discovered on the win-admin-3 VM. Process Explorer was used to discover Lazr.exe operating on the VM. Further analysis with Autoruns confirmed the StartIT scheduled task is still present on the VM, referencing Lazr.exe in the C:\Users\Public\Documents directory. 


During recovery operations the Lazr.exe malware was not correctly removed from the C:\Users\Public\Documents directory. As a result, the scheduled task is still valid and executes when a user logs on. 


The win-admin-3 VM must remain in isolation until all adversarial presence is removed and its removal is accurately verified.


----------------------------


### CDAH-M29L1-ICS Architecture ###


Operational Technology vs. Information Technology
OT and ICS are devices and controllers that manage physical industrial equipment and operations. OT devices are hardware and software systems that interface directly with a piece of industrial hardware. OT/ICS controllers may be found on any physical equipment, such as equipment cranes, hospital patient health monitors, and refrigeration sensors. Any microcomputer attached to a physical device and designed specifically to make that device function is an OT device.

﻿

OT/ICS devices are divided into categories based on the kinds of data and equipment they control and how the equipment is controlled. The most common examples are as follows:

Supervisory Control and Data Acquisition (SCADA): SCADA systems are comprehensive system solutions that allow operators to see an entire system’s process within an industrial context; a SCADA suite often includes direct system management tools. An example is a software suite that displays a power plant’s relevant operational data for all the machines that make the power plant function rather than for individual pieces of equipment.
Distributed Control System (DCS): Similar to SCADA, DCSs create a hierarchical structure of management based on a worker’s role. DCS management levels range from level 0 to level 4, where 0 is a direct machine operation console and 4 might be a plant manager's station. Usually, however, DCS setups are entirely onsite, with no remote administration. For example, a steel mill might use a DCS-based setup to manage factory operations and even report its level 4 data to its parent company’s SCADA setup.
Programmable Logic Controller (PLC): PLCs are the devices directly connected to the equipment being operated. PLCs usually have some kind of networking built in so that the device can be managed by DCS or SCADA systems. 
Differences between IT and OT Asset Management and Security
﻿

IT and OT devices are managed, maintained, and secured differently due to the nature of the organizational needs they fulfill. IT devices like servers and user workstations are designed to fulfill a large number of functions. IT Operating Systems (OS) like Windows contain a multitude of tools so that a user’s needs may be met across a wide range of business disciplines. OT devices, on the other hand, often contain only the system code and function required to operate the specific task they are required to perform. OT devices often need nearly 100% uptime; a power plant’s generators, for example, cannot simply be disabled for updates and routine patches. OT equipment usually entails much greater safety concerns than IT devices. If a Dynamic Host Configuration Protocol (DHCP) server goes down, users may need to stop work briefly, but if a hospital heart monitor stops working, a patient’s physical health may be in jeopardy.

﻿

Another difference between IT and OT devices is their relative lifecycles. Whereas new IT equipment is replaced, upgraded, and refreshed every few years, OT/ICS equipment is often in place for 1 or 2 decades before being removed due to equipment failure or to a forced equipment change for a new organizational requirement.

﻿

OT security has several challenges that IT security lacks. OT devices are often not directly manageable with IT patching solutions and instead may require custom management software, if a fix is available at all. Direct administration is also not an option for most OT devices, as controllers do not contain full OSs and can be accessed only through a physical control panel or through proprietary management software provided by the manufacturer.



-----------------


Industrial Control System Components
OT/ICS equipment consists of several components that work together to create a fully operational environment:

PLCs: PLCs are devices attached directly to physical equipment that governs the operation of that equipment.
Remote Terminal Units (RTU): RTUs transmit device telemetry and control signals between equipment and SCADA systems.
Digital Protective Relays, Numerical Relays, and Intelligent End Devices: Digital protective relays, numerical relays, and intelligent end devices are advanced power surge protectors and power regulators.
Phasor Measurement Units (PMU): PMUs are voltage and amperage management devices, ensuring that the correct amount and kind of power needs are being given to a relevant device.
Real-Time Operating Systems (RTOS): An RTOS is a device OS that is designed to not fluctuate during operation. IT OSs can vary significantly in performance of similar tasks, but OT RTOSs must be predictable and are therefore designed to perform the same function in exactly the same manner, and in exactly the same amount of time, every time.
Sensor Networks: Sensor networks are usually monitor-only telemetry units that report back information to a DCS or SCADA system. A network of temperature sensors for refrigeration does not perform any control functions on the refrigeration system but does report back performance, temperature, and other telemetry data.
Human-Machine Interfaces (HMI): An HMI is any device, or part of a device, designed to allow people to interact with a machine. An HMI may be a control panel composed of buttons and a simple screen, or it may be a piece of software that sends commands to equipment over a network.
﻿Figure 29.1-1 provides an OT network example. The SCADA server, which allows control of the other devices, is managed through the HMI. The SCADA server manages the PLCs’ tasks on the industrial equipment inside the power plant, based on the readings received from the RTU, which receives data from the temperature sensor.

<img width="1667" height="1770" alt="image" src="https://github.com/user-attachments/assets/93258b4a-fbf2-4d44-b01a-4118e0f3b9e5" />


------------------


Industrial Control System Roles
Administration and security within an OT/ICS environment are often divided into roles to set responsibilities and tasks for the correct personnel.

﻿

Network/System Administrators 
﻿

System administrators manage the IT aspect of the ICS systems, interconnecting Transmission Control Protocol/Internet Protocol (TCP/IP) devices, configuring computer systems, and monitoring security. The main focus of IT administrators in an OT environment is to secure the IT equipment that can potentially affect OT operations. IT administrators also manage and secure all after-business critical systems just like any other IT environment.

﻿

Administrators, analysts, and other IT personnel are tasked with managing the servers and workstations that other members of a given organization use daily. Some SCADA systems may be running on Windows or Linux machines that IT manages, but OT equipment rarely falls under general IT purview.

﻿

Operators/Engineers/Technicians 
﻿

Operators use the OT systems to manage, monitor, and program the physical processes. Operators include any personnel who require OT equipment to perform their relevant functions. A nurse using vital signs monitors and a factory worker cutting steel beams are both considered operators in an OT environment. Engineers and technicians vary across a wide range of disciplines, and OT software engineers may have some overlap with IT administration and security, but technicians and equipment engineers manage or repair only OT-related equipment.

﻿

Security personnel and analysts likely interact with SCADA- and DCS-related systems rather than controllers and device-level components. Every equipment vendor has different tools for managing updates and administration for devices, and security personnel are tasked with learning all the vendor-specific information needed to secure OT systems.


---------------

Security Tool Use in Industrial Control System Environments
OT/ICS Vulnerability Management
﻿

Most OT/ICS components and protocols are sensitive to unexpected or improperly formatted control messages. Use of traditional IT tools, such as vulnerability scanners or port mappers, can cause system instability or even permanent damage. Many OT/ICS devices have only their manufacturer management network port open for communication and are only designed to receive network traffic from their proprietary software. For the sake of availability and operational speed, many standard IT-related communication functions are removed from device controllers, and simple handshakes and remote session requests cause system failure. Because of this, most modern controllers reject all traffic from standard IT devices to maintain stability.

﻿

Some ICS functions, such as HMIs or data historians, can be hosted on traditional enterprise OSs like Microsoft Windows or Linux. Telemetry data–generating machines like an HMI do not send many instructions to device controllers and, instead, simply receive forwarded telemetry data, which is then sent upstream to a SCADA system, for example. Traditional IT monitoring and investigation tools, such as PowerShell, Sysinternals, or IR scripts, may not be supported on these devices, however. Such devices rely on passive information-gathering techniques rather than active tools in field networks.

﻿

-----------

Scan ICS Networks
The following exercises use a simulated Feed Water Treatment System (FWTS) OT network that is part of the vCity Power Plant. The system owner provided the attached network diagram. 

﻿

Complete the steps in the following workflow to identify assets on the OT network and demonstrate potential negative impacts of active scanning in an OT network. 

﻿

Workflow
﻿

1. Open a console session to the Virtual Machine (VM) hmi-1.

﻿

The HMI, illustrated in Figure 29.1-2, is a critical device that allows plant operators to monitor and control processes associated with an FWTS:

﻿
<img width="816" height="614" alt="image" src="https://github.com/user-attachments/assets/31583cd2-e3f5-4f04-8ad0-09f986251680" />


2. Open the VM win-hunt. The login credentials are as follows:

Username: trainee
Password: CyberTraining1!



3. Open Zenmap by selecting the Nmap - Zenmap GUI desktop shortcut.


4. Select the drop-down arrow for the Target field, and select the pre-populated address ranges. These address ranges were selected based on the network diagram provided by the system owner. 



<img width="675" height="202" alt="image" src="https://github.com/user-attachments/assets/f8925620-70d7-435c-bc78-ebed12af1e21" />


The Command field is automatically updated with the selected address ranges. This scan profile performs a full TCP connect scan against a small subset of ports that may be found in an ICS network. The command also performs a traceroute to help visualize the network path from the Zenmap scanning host to the target networks. A Cyber Defense Analyst (CDA) typically performs a more complete port scan, but the number of ports in this exercise is reduced to save time.


<img width="677" height="222" alt="image" src="https://github.com/user-attachments/assets/cb53df13-4d76-436c-b6c2-5fb97b8b02f8" />

5. Select Scan

<img width="674" height="204" alt="image" src="https://github.com/user-attachments/assets/f71cbc51-d459-46e1-b7ea-ecdd94ea2b83" />

Once the scan is complete, an Nmap done message appears at the bottom of the Nmap Output display

<img width="671" height="711" alt="image" src="https://github.com/user-attachments/assets/013dd609-37ab-4c71-a450-631b78a371ce" />

6. Select the Topology tab for a high-level visualization of node distribution based on the traceroute feature of Nmap

<img width="674" height="714" alt="image" src="https://github.com/user-attachments/assets/babdfc2a-bf59-4c48-b714-efa74ed343e9" />

The Nmap scan detected most of the hosts in the scanned networks. However, the scanning activity had a negative impact on some assets in the network. 


7. Close the Zenmap console by selecting the X in the upper right corner and selecting Close anyway when prompted. 


8. Return to the VM hmi-1 console session.


The HMI display is no longer visible. The HMI software did not know how to interpret the received data associated with the scan, causing a failure condition. Thus, operators cannot use this terminal to monitor and control the FWTS until the failure is corrected. This is an example of potential impacts that active interactions with ICS components can have. 


Keep the VMs hmi-1 and win-hunt open, as they are used in the next workflow

--------------

Passive Enumeration of Industrial Control System Networks
The following exercise demonstrates how the tool GRASSMARLIN can be used to identify assets in an ICS network through passive detection. GRASSMARLIN is an open-source project developed by the National Security Agency (NSA) that can passively map and visually display an ICS/SCADA network topology while safely conducting device discovery, accounting, and reporting on these critical systems. GRASSMARLIN is capable of extracting this data from live network capture, ingesting a packet capture, parsing Zeek logs, or consuming Cisco® router/switch configuration files and Address Resolution Protocol/Media Access Control (ARP/MAC) caches. The exercise uses a GRASSMARLIN session that was created using offline packet capture from the vCity Power Plant FWTS OT network. 

﻿

NOTE: The VM win-hunt should remain open from the prior workflow. If it has been closed, log in again using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

Workflow
﻿

1. Open GRASSMARLIN by selecting the GrassMarlin shortcut on the desktop.

﻿

2. Select File  > Open Session:

<img width="318" height="288" alt="image" src="https://github.com/user-attachments/assets/f6525dc3-99d4-45db-9f7e-4b083465fba2" />

3. Select Documents > OT Network Map.gm3, and select Open:


<img width="845" height="483" alt="image" src="https://github.com/user-attachments/assets/689bee27-39b0-49be-8e7f-43f0877a1dca" />

The saved session may require up to 2 minutes to load. The session data was created by ingesting approximately 1.3 gigabytes (GB) of network traffic that was captured by the Network Analyst team monitoring the OT network. Parsing the 1.3 GB of packet capture by GRASSMARLIN required about 15 minutes, which is why the session data was preloaded for the exercise. 


GRASSMARLIN can analyze the captured network traffic to identify network assets as well as define communication flows between these assets. GRASSMARLIN also ships with profiles that can be used to fingerprint the observed device types and protocols.


Once the session loads, the Logical Graph tab is populated with the identified devices, as depicted in Figure 29.1-10. GRASSMARLIN was able to use device fingerprinting to observe Modbus traffic and properly label ICS devices with a power line icon. By default, the detected assets are separated into subnets based on /24 subnet masks, which does not accurately match the network layout. GRASSMARLIN provides the ability to specify custom subnets to enhance the visualization.

<img width="645" height="730" alt="image" src="https://github.com/user-attachments/assets/b98fb22d-71cc-4e8f-9a8e-c9d7d68f35ed" />

4. From the toolbar, select Packet Capture > Manage Networks

<img width="430" height="247" alt="image" src="https://github.com/user-attachments/assets/64b0bba9-291f-4a0b-84ba-d131fd1366d8" />

5. Remove the existing network definitions by selecting the Classless Inter-Domain Routing (CIDR) blocks and selecting the Delete key on the keyboard:

<img width="450" height="134" alt="image" src="https://github.com/user-attachments/assets/07037c13-5854-45c4-969c-7d486f86c51d" />

6. In the Add CIDR field, enter the first CIDR block of 172.16.80.0/29, and select the Add CIDR button

<img width="447" height="296" alt="image" src="https://github.com/user-attachments/assets/e77e6c54-2b12-4593-a2a6-92506ed00a04" />

7. Repeat the previous step to add the following CIDR blocks:
172.16.80.8/29
172.16.80.16/28
172.16.79.32/29

8. Select Finish to complete the process

<img width="446" height="292" alt="image" src="https://github.com/user-attachments/assets/ddb2903d-3bc3-4e1b-b072-d04d481aeedd" />
GRASSMARLIN has updated the Logical Graph to properly identify devices in their appropriate subnets:

<img width="726" height="784" alt="image" src="https://github.com/user-attachments/assets/25170195-2334-46e4-9446-d051ceb47168" />


GRASSMARLIN can also provide information about the type of ICS components that were discovered.
 
9. In the left pane, select the drop-down arrow to the left of the 172.16.80.0/29 subnet. Right-click 172.16.80.2, and select View Details for 172.16.80.2

<img width="508" height="400" alt="image" src="https://github.com/user-attachments/assets/e77adde5-0e7a-47fe-99fc-1d890c4e27eb" />

10. Resize the Node Details window that appears so that the device attributes are visible

<img width="289" height="488" alt="image" src="https://github.com/user-attachments/assets/3465882c-a07d-4fb6-8f8d-4c8a5211d71c" />


GRASSMARLIN has provided several pieces of information based on its fingerprinting capability. In addition to possible product and OS matches, it provides valuable insight into this device’s functional role in the OT network. In this case, 172.16.80.2 has been identified as a Master Terminal Unit (MTU), which is synonymous with an HMI.

<img width="422" height="727" alt="image" src="https://github.com/user-attachments/assets/7c0479b7-8462-4745-a915-08ceb5a3bc29" />


11. Close the Node Details window.


12. Select the drop-down arrow to the left of the 172.16.80.8/29 subnet. Right-click 172.16.80.10, and select View Details for 172.16.80.10


<img width="434" height="432" alt="image" src="https://github.com/user-attachments/assets/cb3300c3-35fd-4fef-9638-e9b033bd9931" />


13. After resizing the window, view the device attributes. In this case, the device category has been properly identified as a PLC:


<img width="441" height="794" alt="image" src="https://github.com/user-attachments/assets/69601160-d654-4525-8175-8fb1080adf49" />


---------------

### CDAH-M29L2-ICS Protocols and Implementations ###

Industrial Control System Protocols
To understand how ICS networks and components communicate, familiarity with the underlying protocols in use is necessary. Protocols implemented in ICS networks are designed to communicate with specialized hardware to complete particular tasks, such as reading sensor values or sending control instructions to an end device. Additionally, some protocols have unique requirements, depending on their applications, such as an emphasis on reliable transport, efficiency due to low-bandwidth communications streams, and extremely low latency to support real-time operations. 

﻿

Like some Information Technology (IT) protocols, ICS protocols can be proprietary or open standard. Proprietary protocols are maintained by the vendors that developed them. The use of these protocols is restricted by licensing requirements and, in general, interoperate only with other devices produced by the vendor. Additionally, the technical information behind the development of the protocols is retained by the vendor and not shared publicly. Open-standard protocols, on the other hand, are free to use by anyone. They are usually designed and developed by organizations like the Institute of Electrical and Electronics Engineers/Internet Engineering Task Force (IEEE/IETF) or as a joint effort by many organizations.


----------------

Common Industrial Control System Protocols
Dozens of communications protocols currently exist in ICSs throughout the world. Some protocols are extremely specialized and used in only certain applications, whereas others have seen widespread adoption throughout the industry. Brief descriptions of some of today’s most common ICS communications protocols follow.

﻿

Modbus
﻿

Modbus is a data communications protocol originally published by Modicon in 1979 and later adopted as one of the first open-standard ICS protocols. Modbus is one of the most commonly used communications protocols in ICS networks. 

﻿

Modbus is a serial protocol that communicates over Recommended Standard 232 (RS232) or RS485 serial connections. A variant known as Modbus/TCP (Transmission Control Protocol) exists that can communicate over Ethernet networks using TCP port 502 by default. 

﻿

Modbus employs a client–server (originally documented as master/slave) architecture for communications. The client initiates communication with the servers to poll for information or send commands to the end device. The Modbus protocol allows a maximum of 247 Modbus devices per network segment. Figure 29.2-1 provides an illustration of the Modbus process:

﻿


<img width="2500" height="1114" alt="image" src="https://github.com/user-attachments/assets/b1fca3b0-037a-4a8f-9f26-885c9d10c01f" />


PROFIBUS/PROFINET


PROFIBUS is an open-standard communications protocol used widely in factory and process automation systems. PROFIBUS is a serial protocol that communicates over RS232 or RS485 serial connections. 


PROFINET is an updated version of PROFIBUS that communicates over industrial Ethernet networks. 


DNP3


Distributed Network Protocol 3 (DNP3) is used almost exclusively by electric, gas, and water utilities for remote communications between Supervisory Control and Data Acquisition (SCADA) equipment and control centers. This protocol operates over RS232 and RS485 serial connections but can also be encapsulated in Transmission Control Protocol/Internet Protocol (TCP/IP) or transmitted via radio or modem for long-distance communications. 


DNP3 supports end-to-end encryption via Virtual Private Network (VPN) tunnels or Transport Layer Security (TLS) encryption. DNP3 also supports authentication and implementation or role-based access controls. 


Open Platform Communications


Open Platform Communications (OPC) is an open-standard communications protocol evolved from the earlier Object Linking and Embedding (OLE) implementation for process control. The purpose of OPC is to act as an abstraction layer between Human-Machine Interface (HMI) or SCADA systems and Programmable Logic Controllers (PLC) that may be relying on several different protocols, such as Modbus or PROFIBUS. 


Essentially, the control and monitoring devices, such as HMI and SCADA servers, communicate directly with OPC servers using the OPC protocol. The OPC server then translates the commands to the appropriate protocol (for example, Modbus or PROFIBUS) in order to communicate with target devices, such as a PLC or actuator. 


OPC can provide security through encrypted communications, the use of digital certificates, and enforcing authentication and authorization.


WirelessHART


WirelessHART (where HART is an acronym for Highway Addressable Remote Transducer) is a protocol that uses a 2.4-gigahertz (GHz) wireless mesh network to communicate with field devices. WirelessHART has a communication range of 200 meters between each device and can be an excellent way to connect field devices when physical connections are not feasible. WirelessHART enforces Advanced Encryption Standard (AES)-128 encryption for device communication.



-----------------

Industrial Control System Protocol Security
From a cybersecurity perspective, the majority of ICS protocols and applications lack what are considered standard security controls in modern enterprise networks. 

﻿

Many ICS protocols were designed before widespread adoption of modern network-based communication technologies. Prior to the internet, ICS systems were isolated within a plant and required physical access to control and monitor them. These legacy protocols typically relied on direct serial connections between HMIs, PLCs, and end devices. Because these systems were traditionally air gapped, security was not a consideration when the protocols were developed. 

﻿

As modern network technologies became widely adopted in corporate environments, organizations began to converge IT and Operational Technology (OT) environments. Legacy ICS protocols were adapted to support transport over Ethernet and IP networks, but they were not always updated to include common security controls, such as authentication and encryption. 

﻿

Modbus is an example of an ICS protocol that was updated to enable transport over IT networks. Modbus TCP communications are sent as cleartext between a client and server over the network. If an attacker were present on a Modbus TCP network, they could eavesdrop on device communications to view commands and responses. Additionally, Modbus TCP does not support authentication or authorization technologies. This means that any properly formatted Modbus TCP message is accepted and processed by an ICS device that uses Modbus TCP. In this case, an attacker can easily send commands to control field devices or send incorrect sensor values to an HMI monitoring a process. 

﻿

In addition to insecure protocols, many ICS networks use applications and servers that lack basic security controls. These applications were traditionally deployed by controls engineers without an IT or cybersecurity background. This can result in such applications as databases or web servers being deployed with default configurations and left unauthenticated. It is also reasonable to assume that these applications and the servers that host them are older, unpatched systems. In some cases, these assets may be intentionally deployed without authentication. Consider an HMI terminal that controls a critical process. Failure to properly authenticate with the HMI may result in a lockout that prevents an OT engineer from controlling the process. In OT environments, availability of critical assets and processes is almost always prioritized over the implementation of a security control. 

﻿

Another contributing factor to the lack of security controls in ICS environments is vendor requirements for warranties and support contracts. Many Distributed Control Systems (DCS) consist of several components, such as control software, HMIs, preconfigured PLCs, and field devices. All these components are built and tested by the vendor before they are installed in an organization’s ICS environment. Updating Operating Systems (OS) or making configuration changes alters the vendor’s baseline and might affect a system’s ability to operate properly. Such changes are generally prohibited by the vendor. Instead, the only authorized changes or updates are those specifically supplied by the vendor as part of a support contract. Such product updates may have extremely long lead times. In some cases, receiving critical security updates from a vendor may take years. 


------------------

Control a PLC with Modbus
The following lab provides a simulated PLC that controls a voltage regulator. Using a command line–based Modbus tool, complete the steps in the workflow to remotely control the PLC. This lab demonstrates how an attacker can take advantage of the lack of security in the Modbus protocol to manipulate control system processes.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) win-hunt. The login credentials are as follows:


Username: trainee
Password: CyberTraining1!
﻿

2. Select the ModbusPal desktop shortcut.

﻿

3. Import the PLC simulation project file by selecting the Load button and opening the file PLC_Simulation.xmpp located in C:\users\trainee\Documents:


﻿<img width="300" height="403" alt="image" src="https://github.com/user-attachments/assets/e36a3de2-8b60-4e44-b35e-94aafcee0d02" />


<img width="472" height="365" alt="image" src="https://github.com/user-attachments/assets/801927ab-9859-4aad-907e-85bdd758532a" />

4. Activate the simulation by selecting the Play button to start the automation, and select Run to start the Modbus server. Select the eye icon to the right of the PLC object to view the PLC settings


<img width="446" height="601" alt="image" src="https://github.com/user-attachments/assets/391bf8c0-5203-4afe-86ce-1e7a2b9d7678" />

By default, the existing holding registers are displayed. In Modbus, holding registers are used to represent values obtained by reading sensors or to configure set points for a process. The three main fields of interest are Address, Value, and Name. The Address field is used when sending Modbus commands to the PLC to specify the register that is to be read or changed. The Value field displays what the register is currently set to. The Name field, also known as a tag, provides context to associate the register with the part of the physical process it controls. The Name field is only locally significant, meaning this is not a field that can be remotely queried using Modbus commands. 


For this example, registers 1 through 4 are in use. The first register represents a reading of input voltage to the voltage regulator. Because this register is reading a sensed value, it fluctuates as the input voltage changes. The OutputVoltage register is a configured set point that specifies what voltage the regulator should maintain; in this case, the regulator is configured to output 120 volts (V). The MinVoltage and MaxVoltage are used as safety settings that should trigger an alert if the output voltage goes below 110 V or above 130 V.


<img width="419" height="429" alt="image" src="https://github.com/user-attachments/assets/6ee9e161-00e3-4c6d-8f41-614bed3403b7" />

5. Select the Coils tab to view the configured coils.


Modbus coils differ from registers in that they are binary and represent a condition of on (1) or off (0). Coils are typically used to set or read the condition of a switch or a feature. In this example, the OutputEnabled coil is set to 1, which means the voltage regulator is turned on and outputting voltage. The SafetyOverride coil represents a setting that would disable the generation of alerts if the MinVoltage or MaxVoltage thresholds were breached. (This feature is currently disabled.)

<img width="421" height="429" alt="image" src="https://github.com/user-attachments/assets/9b9c3320-5d71-4b0a-9d81-96e6a5d0b1c2" />
6. Select the run_ctmodbus.bat desktop icon to open the ctmodbus tool.


A ctmodbus command prompt appears.


7. In the ctmodbus terminal, run the help command. 


This displays a list of available commands and brief descriptions of their operation. Select Enter again to acknowledge the help dialog and return to the prompt: 


<img width="676" height="372" alt="image" src="https://github.com/user-attachments/assets/30fb4a11-b786-4aa0-be87-0b4453f0de9e" />

8. Run the following command to open a session with the Modbus simulator: 


connect tcp 127.0.0.1:502



9. Once connected, a Success message appears. Select the Enter key to acknowledge the message and return to the prompt:


<img width="319" height="149" alt="image" src="https://github.com/user-attachments/assets/95656e86-3863-4020-89d6-9bdd921ba594" />


Authentication is not required to send commands to the PLC.


The read holdingRegisters command can be used to query the holding register values of the PLC. To use the command, provide the holding register addresses to be queried. The numbering of holding register addresses on the PLC is different from what Modbus uses when sending commands. On the PLC address, numbering starts with 1, but with Modbus commands, register addresses start at 0. 


10. Run the following command to read the values for the first five holding registers on the PLC:


read holdingRegisters 0-4



11. Compare the output from the read holdingRegisters command to the holding registers displayed in the PLC.


Addresses 0–4 in the command output correspond with addresses 1–5 on the PLC. Also, as previously mentioned, the register names, or tags, are not provided in the output. This means that an attacker can query all the registers and obtain the current values, but they do not know what each register represents


<img width="282" height="271" alt="image" src="https://github.com/user-attachments/assets/e385ab9e-face-4522-8a26-a075773525f2" />


<img width="419" height="429" alt="image" src="https://github.com/user-attachments/assets/3c12a260-5277-45fd-8dfd-ca6892d3af19" />

The read coils command operates just like the read holdingRegisters command. Provide the addresses of the coils to be read. Again, coil addressing in Modbus starts at 0.


12. Run the following command to read the first two coil values on the PLC:


read coils 0-1



The returned coil values match what is displayed on the PLC


<img width="207" height="225" alt="image" src="https://github.com/user-attachments/assets/ab1ac914-ef58-4c18-8550-236ec791e852" />

<img width="421" height="429" alt="image" src="https://github.com/user-attachments/assets/b15ee9f8-8038-4be9-b455-6d1893f513d0" />

Registers and coils can also be modified remotely by using the write command. The syntax for this command is as follows:


write (register|coil) (address) (value)



13. Run the following command to increase the MaxVoltage holding register value to 240 V: 


write register 3 240



The PLC now displays the updated value of 240



<img width="250" height="144" alt="image" src="https://github.com/user-attachments/assets/baed4f9c-1752-48ec-9805-9d80226042d6" />


<img width="418" height="430" alt="image" src="https://github.com/user-attachments/assets/0a9356a2-80b1-4ec3-a999-6b9e86ce217f" />

14. Run the following command to configure the PLC’s OutputVoltage to 220 V:


write register 1 220



The PLC is now set to deliver an output voltage of 220 V. This configuration would create an overvoltage situation that could cause physical damage to equipment


<img width="249" height="142" alt="image" src="https://github.com/user-attachments/assets/0e44a869-27c8-4442-9c16-bc0df2965dc7" />

<img width="416" height="427" alt="image" src="https://github.com/user-attachments/assets/588ae4cd-23c9-45de-95eb-410e770f2b8d" />

15. Run the following command to turn on the safety override:




write coil 1 1



The SafetyOverride coil has now been enabled, which disables the safety system, creating yet another dangerous situation for this control system


<img width="260" height="144" alt="image" src="https://github.com/user-attachments/assets/689c18aa-2bae-4bb9-9e6f-f59f755bf344" />


<img width="418" height="429" alt="image" src="https://github.com/user-attachments/assets/040330a6-77b6-4827-9cfa-cfd15a0d392d" />

----------------


### CDAH-M29L3-Availability and Visibility in ICS ###

ICS Host Analysis Tools
Host analysis tools are used in an ICS environment to gather information about the host computer or device on which the ICS runs. 

﻿

Host Analysis tools gather information such as the following:

Installed software 
Network configurations
System-level details
This information is used to identify vulnerabilities and potential security risks in the ICS, and to understand the overall configuration of the system. 

﻿

Host analysis tools are also used to monitor a system for changes and to detect suspicious activity. An example of this would be a software program that runs on individual devices within an ICS environment, gathers data, and analyzes the state of the system during a cyber incident. 

﻿

There are differences between the analysis tools used in ICS and those used in IT environments.

﻿

ICS Environments 
﻿

ICS analysis tools are designed to work with the specialized hardware and software tools used in industrial environments. These tools typically have features for working with Programmable Logic Controllers (PLC) and other industrial control systems. 

﻿

ICS tools also have features for interacting with field devices and sensors used to gather data from the physical environment, as seen in Figure 29.3-1 below:


<img width="3324" height="1878" alt="image" src="https://github.com/user-attachments/assets/8f435b87-efa7-4f02-8208-32f4cd287a76" />

IT Environments


IT analysis tools are generally designed to work with standard IT hardware and software, such as servers, desktop computers, and networks. These tools may have features for working with common IT protocols and services such as Transmission Control Protocol (TCP), Internet Protocol (IP), and Active Directory (AD).


Modern ICS environments consist of a combination of specialized ICS devices and commodity IT hardware and operating systems. The integration of IT components in ICS networks provides the opportunity to use traditional IT IR tools when investigating a compromised ICS environment. 


However, it is common for the IT components in an ICS environment to be outdated legacy systems that are incompatible with newer host analysis tools and software. For example, imagine trying to use PowerShell to query a 20-year-old WindowsXP device. 


While there is some overlap between the functionality of ICS and IT analysis tools, they are designed to address different types of hardware, software, and security concerns. Due to the differences between ICS and IT analysis tools, incident response in ICS environments often requires specialized knowledge and expertise that may not be required in IT environments.


------------

ICS Host Analysis Constraints
In many cases, analysts do not have permission to deploy collection sensors or agents in a mission partner’s ICS environment. In these situations, analysts have to rely on offline artifact analysis to investigate the potential compromise of ICS networks. 

﻿

For offline analysis, use forensics acquisition tools that perform functions such as the following: 

Disk imaging
Memory image capture
Artifact extraction
Once artifacts are gathered, they can be loaded onto a dedicated forensics workstation, or offline SIEM for analysis.

﻿

As seen in Figure 29.3-2 below, there are several constraints that may prevent an analyst from running host analysis and forensic acquisition tools on ICS components. 



<img width="1600" height="872" alt="image" src="https://github.com/user-attachments/assets/fa64727b-9adb-4783-880a-b1e65e829c1b" />



Operational Constraints


ICS components are often critical to the operation of a facility or process, and running forensic acquisition tools on these components may disrupt or interfere with their normal operation. In some cases, it is not possible to shut down or disconnect the ICS components in order to perform the forensic acquisition, which can make it difficult or impossible to gather the necessary data.


Physical Constraints


ICS components are often located in remote or difficult-to-access locations, such as in underground mines, offshore oil platforms, or remote substations. In such cases, it may be difficult or impossible for an analyst to physically access the components in order to perform the forensic acquisition. 


Technical Constraints


Many ICS components use specialized hardware and software that may not be compatible with standard forensic acquisition tools. This can make it difficult or impossible for an analyst to gather the necessary data from the components using standard techniques.


Safety Constraints


Some ICS components may be located in hazardous environments, such as in nuclear power plants or chemical processing facilities, where the use of forensic acquisition tools may pose a safety risk to the analyst.


These constraints pose a unique challenge to host analysts that are responding to an incident in an ICS environment. In an ICS incident response scenario, analysts must work closely with the mission partner to identify the best opportunities for artifact collection within the ICS


-------------

ICS Remediation
During the IR process, once a compromise has been identified, the team moves to contain and eradicate the threat. In IT networks, this can involve isolating infected hosts with access controls, or physically disconnecting the hosts from the network. 

 ﻿

Once containment has been achieved, the team attempts to eradicate the infection by performing the following actions: 

Device replacement
Reverting the device to a known good state
Re-imaging the device
Critical Processes
﻿

In an ICS network, it may not be possible to disconnect and replace infected components that are part of a critical process. When an infected ICS component is part of a critical process, and cannot be replaced until a scheduled maintenance window is available, ICS networks may need to remain in the containment phase for an extended period of time. 

﻿

In such cases, the main goal of containment is to minimize the attacker's ability to cause damage to the critical process while still allowing the process to operate. This can be achieved by implementing security controls such as network segmentation and access control lists. 

﻿

ICS Devices
﻿

To further complicate matters, it may not be possible to make configuration changes that support containment on the infected device itself. ICS device configuration is often tightly controlled. Therefore, changes to the configuration may invalidate the vendor-approved operating baseline and cause system instability. 

﻿

Additionally, the ICS device may not be equipped with the appropriate utilities to support containment, such as a host-based firewall. It may be necessary to make the containment and isolation configuration on network devices such as switches, routers, or firewalls.


---------------------

IR Practices and ICS Systems, Part 1
A mission partner that operates a chemical processing plant has detected malicious cyber activity in their enterprise IT network. The mission partner is concerned that the attacker has moved laterally from the enterprise IT network to the ICS network. The mission partner has requested a threat hunting team to investigate the ICS network for signs of compromise. Due to the critical nature of the ICS system, all analysis will be performed offline using datasets provided by the mission partner. 

﻿

Workflow
﻿

The mission partner has provided a GRASSMARLIN capture of baseline traffic flows in the ICS network that can be used as a starting point for the investigation. ICS network traffic is useful for baselining because it is extremely deterministic and predictable. 

﻿

Use GRASSMARLIN to investigate new connections detected in the ICS network that deviate from the baseline.

﻿

1. Log in to the Virtual Machine (VM) win-hunt with the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Select the GrassMarlin shortcut on the Desktop.

﻿

3. Select File, and then select Open Session.

﻿

4. Select baseline.gm3 from the Desktop/Case folder, and then select Open. 

﻿

Observe the baseline communications present in the ICS network, as seen in Figure 29.3-3 below:


<img width="978" height="725" alt="image" src="https://github.com/user-attachments/assets/65f42c03-ea32-4cdb-b7e2-6a8750b9948b" />

5. Open the post_exploit.gm3 file by repeating Step 3 and Step 4. Select No when prompted to save the current file. 


Keep this VM open for use in the upcoming workflow. 


Compare the baseline and post_exploit environments to answer the following questions. 



-------------

IR Practices and ICS Systems, Part 1
A mission partner that operates a chemical processing plant has detected malicious cyber activity in their enterprise IT network. The mission partner is concerned that the attacker has moved laterally from the enterprise IT network to the ICS network. The mission partner has requested a threat hunting team to investigate the ICS network for signs of compromise. Due to the critical nature of the ICS system, all analysis will be performed offline using datasets provided by the mission partner. 

﻿

Workflow
﻿

The mission partner has provided a GRASSMARLIN capture of baseline traffic flows in the ICS network that can be used as a starting point for the investigation. ICS network traffic is useful for baselining because it is extremely deterministic and predictable. 

﻿

Use GRASSMARLIN to investigate new connections detected in the ICS network that deviate from the baseline.

﻿<img width="1917" height="827" alt="image" src="https://github.com/user-attachments/assets/a228f4c8-3bf2-45b2-88a1-a315082573b3" />

---------------------

IR Practices and ICS Systems, Part 2
Comparing the baseline and current network traffic reveals that there is a new connection between 172.16.79.35 and a device outside of the ICS network. A network map provided by the mission partner, as seen in Figure 29.3-4 below, shows that the 172.16.79.35 device is the control system data historian server. 

﻿

A data historian is a centralized database used in ICS networks to collect health and performance data from control system devices. The mission partner also confirmed that the 172.16.4.20 IP address is part of a client workstation subnet in the enterprise IT network. The mission partner highlighted that this communication path is abnormal. 

﻿<img width="2048" height="2048" alt="image" src="https://github.com/user-attachments/assets/6fa81ae4-9963-463e-805d-079dd6a2afd2" />


Use the event logs in the Desktop/Case/Logs directory to continue the investigation.


Workflow


1. Log in to the VM win-hunt with the following credentials:
Username: trainee
Password: CyberTraining1!



2. If open, close GRASSMARLIN. Select Close, and then select No when prompted to save changes.


3. Navigate to the Desktop/Case/Logs directory and open sysmon.evtx in Windows Event Viewer.


4. Select the Date and Time column header to sort the events from oldest to newest. Navigate to the first event.


Sysmon provides valuable log information pertaining to file creation, process creation, and network connections. This log source can help identify the process that is communicating with the external host 172.16.4.20.


5. Select the Find icon in the Action pane. 


6. Enter the following destination IP address:
172.16.4.20



7. Select Find Next.


Event Viewer moves to the first log that contains the IP address of 172.16.4.20. 


8. Click Close on the Find dialog box.


As seen in Figure 29.3-5, below, the network connection log displays several pieces of information that are useful for further investigation such as the filename, the location where payload.exe was created, the SourceIp, and more. 

<img width="661" height="826" alt="image" src="https://github.com/user-attachments/assets/626af6af-98c2-4ad8-8f5e-79cfc3113edd" />


Knowledge Check
Sysmon generates a log entry when a new process is created. This log is represented by Event ID 1.

﻿

Find the Process Create Sysmon log associated with payload.exe to answer the following question. 

﻿

Question:
﻿

What is the MD5 Hash of payload.exe?

<img width="1085" height="607" alt="image" src="https://github.com/user-attachments/assets/9304d03f-59fb-4fca-a6c1-6dd5d31a3b41" />


Knowledge Check
Sysmon generates a log entry whenever a new file is created. This log is represented by Event ID 11.

﻿

Find the Sysmon log associated with payload.exe to answer the following question.

﻿

Question:
﻿

At what UTC time was the payload.exe file created?
﻿
<img width="1127" height="574" alt="image" src="https://github.com/user-attachments/assets/c156f8e8-23f0-4232-877d-60b01b2f1c64" />


Knowledge Check
Migrating to already-running processes is one method that an attacker uses to avoid detection. Sysmon Event ID 8 can aid in the detection of process migration techniques. 

﻿

Find the Sysmon CreateRemoteThread Detected log associated with payload.exe to answer the following question.

﻿

Question:
﻿

What is the filename of the TargetImage that the attacker migrated into? 

<img width="1131" height="474" alt="image" src="https://github.com/user-attachments/assets/d05652ee-624d-48f6-a271-b0b4bd5935fc" />


Knowledge Check
﻿

The compromised ICS host, 172.16.79.35, and the running vmtoold.exe process represent critical components of the mission partners OT network.

﻿

The mission partner requires a course of action that stops the identified malicious cyber activity while maintaining the highest level of availability for the ICS host, and the vmtoolsd.exe process. The mission partner stated that changes to the existing server configuration must be avoided due to vendor requirements. 

﻿

Question:
﻿

Which action should the mission partner perform?
﻿
<img width="1129" height="699" alt="image" src="https://github.com/user-attachments/assets/dc17ab43-c571-4c25-92ee-3716939f4845" />

-----------------

### CDAH-M30L1-Modify IR Tools ###

Analyzing IR Script Functionality
A Host Analyst on a CPT conducting malware triage often uses scripts to perform IR information gathering. Depending on the Operating System (OS), scripts may be written in different programming languages. PowerShell is typically used on a Windows system, whereas Python or Bash scripts are often used on Linux systems. A CPT may be unfamiliar with the full capabilities of a script and must be prepared to determine the script’s functionality and assess its viability for use in a particular situation, such as script automation. Some aspects of scripts are prohibitive to automation, such as mandatory user interaction during execution. When planning for automation, identification of scripts that require such interaction is necessary, and the CPT may need to determine a strategy to modify the script to allow for automation.

﻿

Python scripts often import other modules from libraries to add functionality to the script. For example, the module argparse is often imported to give the script advanced capabilities for handling command-line arguments and parsing different options passed to the script. 

﻿

During determination of a script’s functionality, the imported modules can provide clues for the capabilities that the script might have. Many modules are available for import, and online resources can be used to determine the functionality they provide. Table 30.1-1 provides a few examples of available modules


<img width="2500" height="1024" alt="image" src="https://github.com/user-attachments/assets/7347d8d2-fd9c-46ed-89a3-95d5344613a1" />



-------------------

Determine Capabilities and Functionality of IR Scripts
In the following lab, assess the functionality of Python scripts that are typical of those found in a toolkit used during IR information gathering, and discover characteristics prohibitive to automation.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) lin-hunt-cent. The login credentials are as follows:

Username: trainee
Password: CyberTraining1! 
﻿

2. Locate the Python scripts by navigating to /home/trainee/Desktop/Scripts.

﻿

3. Analyze the scripts in the folder to assess their functionality. Examine the script code and run the scripts in a terminal window to make the assessment.

﻿

Use this workflow to answer the following questions



----------------------


Benefits of Automating IR
Adding automation to IR scripts may be done in numerous ways, but the ultimate goals are to reduce analyst workload and add a level of assurance that nothing is missed. Scripts generally minimize the occurrence of errors when compared with manual examination of systems. Creating automated scripts allows the same checks and information-gathering tasks to be run across multiple systems simultaneously. Performing repetitive tasks becomes less cumbersome, and scripts can be remotely deployed to automatically gather and centralize key system information from many different systems. This reduces the time needed for remediation. 





As an example use case, script automation can be used for gathering information about bound Transmission Control Protocol (TCP) ports and their associated processes. Implementing automation to deploy an information-gathering script to remote systems, gather the information, and report back from remote locations to a centralized location significantly decreases the time to identify Indicators of Compromise (IOC) related to ports used or process names. 

﻿

Scripts already in the Host Analyst’s toolkit can be used as the starting point for the automated tasks. However, because specific details differ from one investigation to the next, the Host Analyst may need to make slight modifications or introduce new functionality to a script to collect the necessary information.



-----------

PowerShell Enhancements for IR
PowerShell provides many options and cmdlets that help support automation of IR tasks. This section reviews some of PowerShell’s scripting features and provides examples of making enhancements to PowerShell scripts, including the following:

Remote system access

Task repetition

Output formatting

Chaining efficiency

Remote System Access
﻿

PowerShell cmdlets usually default to running on the local system, but some can accept the parameter -ComputerName to tell the cmdlet to run on a remote system and gather the same information. Many cmdlets support this parameter, and an analyst can use it to quickly gather information across an organization’s network from a single workstation. The following command provides an example of collecting hotfix information from a remote system:

Get-HotFix -Description "Security Update" -ComputerName "hostname"
﻿

The Invoke-Command cmdlet can be used to run PowerShell code on a remote system and display the results locally. The following example runs the code between the curly braces to display established network connections on the remote system:

Invoke-Command -ComputerName "server1" {Get-NetTCPConnection -State Established}
﻿

From an automation standpoint, one drawback to running commands on remote systems is that the user is prompted to enter credentials for accessing the remote computer. User interaction may not easily be incorporated into automated scripts, but PowerShell allows the creation of credential objects that can be created and preserved. For example, at the beginning of a script, code may prompt for credentials from the user that all subsequent code in the script requiring authentication can then use.

﻿

Running remote commands in a live mission will generate logs and network traffic. It is important to coordinate with the other analysts on the team and take detailed notes. Otherwise, another analyst might misconstrue the team's own actions for malicious cyber activity (MCA). Additionally, configuration changes on a compromised host may alert the adversary to the team's actions.

﻿

Task Repetition
﻿

Iterating over multiple objects in PowerShell can be accomplished using ForEach or ForEach-Object. In the following example, ForEach is used to iterate over a list of hostnames read from a text file check_hosts.txt and gather hotfix information from each. The list of hosts is stored in a variable, and ForEach is used to step through the entries one at a time. 

$host_to_check = Get-Content -Path "C:\check_hosts.txt"
ForEach ($host in $host_to_check) {
    Get-HotFix -Description "Security Update" -ComputerName $host
}
﻿

This code can be written more concisely by passing the list of hostnames directly to ForEach-Object and using the PowerShell variable $_ to refer to the individual hostname:

Get-Content -Path "C:\check_hosts.txt" | ForEach-Object {
    Get-HotFix -Description "Security Update" -ComputerName $_
}
﻿

This type of object iteration is possible for many cmdlet outputs.

﻿

Output Formatting
﻿

Most PowerShell cmdlets output data to the console using a table format, just as if the output is piped to the Format-Table cmdlet.

﻿<img width="837" height="427" alt="image" src="https://github.com/user-attachments/assets/530cf6fe-fd13-4451-b3a0-f69536a84554" />

Figure 30.1-1 shows the default table outputs for the Get-Hotfix and Get-NetTCPConnection cmdlets. Some cmdlets, such as Get-Date, do not show a table by default. However, the output of Get-Date can be piped to Format-Table to force the output into a table, as shown in Figure 30.1-2


<img width="837" height="262" alt="image" src="https://github.com/user-attachments/assets/27d908ae-1a49-4bf5-90b5-1bf54f25cbd6" />


By piping output to Format-Table, data can be grouped by a particular column. Used in conjunction with the Sort-Object cmdlet, data can be organized in a more readable form. The following example code demonstrates this:
Get-Hotfix | Sort-Object Description | Format-Table -GroupBy Description



When it is necessary to send the output of cmdlets to a file, the two cmdlets Out-File and Export-CSV are useful, depending on the desired output format of the resulting file. For text output, Out-File is used, and for Comma-Separated Values (CSV) output, Export-CSV is used, as the following examples show:
Get-Hotfix | Out-File "C:\folder\data.txt"

Get-Hotfix | Export-CSV -Path "C:\folder\data.csv"



Chaining Efficiency


The output of a PowerShell cmdlet is typically an object that can be used to chain into other cmdlets and filter results. These chains can extend for multiple outputs. For example, consider the following command with each part of the chain shown in alternating normal and italicized text:
(Get-ADComputer -Filter 'operatingsystem -like "*server*" ').Name | 
Foreach-Object {Invoke-Command -ComputerName $_ {Get-NetTCPConnection -State Established -ErrorAction SilentlyContinue}
 | Sort-Object PSComputerName | 
Select-Object PSComputerName, LocalPort, RemotePort, RemoteAddress}
 | Out-File C:\Temp\TCP_Conn.txt



In the first chain, the command queries the domain for servers that have the string server in their OS name. Those objects are piped to the next chain, which iterates over the list and remotely gathers the established TCP connections on each. Use of the modifier -ErrorAction SilentlyContinue allows the rest of the iterations to continue, even if an error occurs during the collection of information. This can be important for automation to ensure that the script is not disrupted by periodic errors that are not critical in nature. The results are further piped into subsequent chains to be sorted, and specific fields are pulled out of the output and stored in a local file


-------------


Modify a Python Script to Increase Automation Capability
Scenario: An analyst is investigating suspected infections of Linux systems. The malware is known to randomize the process name, but one characteristic of the malware is that the executable file that launches the malicious process is deleted from the file system after the process starts. The Python code in script3.py can be used as a starting point for creating an automated script that can be used for subsequent IR activities related to tracking down the malware.

﻿

The challenge is that the starting script is not yet suitable for automation. In its current state, the starting script requires user interaction during runtime, and it works on only a single process. To be effective, the modified script needs to examine all the processes on a system and identify which processes show indications that the process executable file has been deleted.

﻿

In the following lab, modify an existing Python script to improve its ability to be used in automated IR activities. Remove runtime user interaction requirements, and expand the scope of the script to examine all processes.

﻿

Workflow
﻿

1. Open the VM lin-hunt-cent. The login credentials are as follows:

Username: trainee
Password: CyberTraining1! 
﻿

2. Launch a terminal window, and navigate to /home/trainee/Desktop/Scripts.

﻿

3. To prepare for script modification, make a copy of the original script3.py file:

cp script3.py checkprocs.py
﻿

4. Open the new checkprocs.py script in an editor, and modify the script to remove user interaction and iterate over all processes rather than just one process. Comment out all code from line 22 to line 30.

﻿

5. Insert the following five lines of code, starting at line 32:

for subdir in os.listdir('/proc'):
    if subdir.isdigit():
        proc_id = int(subdir)
    else:
        continue
﻿

Figure 30.1-3 shows the changes that should be made to the new script



<img width="757" height="514" alt="image" src="https://github.com/user-attachments/assets/926d578e-ace0-4088-97e4-660afe74bb5d" />


6. Save the script, and test the modifications by executing the new script from a terminal prompt:
sudo ./checkprocs.py



NOTE: When prompted, use the sudo password CyberTraining1!


With these changes, the checkprocs.py script iterates over all processes and does not require the user to provide a Process Identifier (PID) number to examine. This is the first modification to making a script that is suitable for automation.


The next modification to be made is to identify processes whose executable files have been deleted. Prior to making those modifications to the script, determine how a process with a deleted executable can be detected. A copy of the system executable sleep is made and used to launch a new process. The process information is examined first, and then the corresponding executable is deleted. The process is reexamined to note the differences and make a determination of how to detect those processes in the script.


Workflow


1. From the terminal prompt, make a copy of the sleep binary, and execute the copied binary in the background with a large time argument. Make a note of the PID value displayed after running the executable in the background:
cp /usr/bin/sleep /tmp/testsleep

/tmp/testsleep 9999999 &



2. Run the script3.py script, and enter the PID of testsleep when prompted. Observe the output, delete the testsleep executable file, and re-run script3.py to check the difference in output:
sudo ./script3.py

rm -f /tmp/testsleep

sudo ./script3.py


<img width="723" height="201" alt="image" src="https://github.com/user-attachments/assets/1dcf7d33-da7e-4334-82eb-067ac8b3cdfd" />


The output after the second execution of script3.py displays the EXE value with the string label (deleted) appended after the executable name. That string can be used to limit the output of the checkprocs.py script to only those processes with deleted executables.


Continue modifications of the script checkprocs.py to identify only the processes that have had the executable deleted.


3. Modify the fourth line from the end of the script as the following:
    if pid_info and pid_info["exe"].split()[-1] == "(deleted)":



4. Comment out the final two lines of code:



<img width="764" height="139" alt="image" src="https://github.com/user-attachments/assets/24caf664-2fe5-4bbf-b240-ddb1552d5e09" />


5. Save the file, and re-run the newly modified script:
sudo ./checkprocs.py



The output shows the test process created above that had the executable file deleted. With those modifications, the checkprocs.py script now examines all the processes on the system and displays only those that meet the criterion of having had the executable for a running process removed. This script is rea dy for aut omated use  and can b e  further tail ored as needed to  meet addition al automation requirements




----------------------


### CDAH-M30L2-Create an IR Tool ###


Evaluating Incident Response Tasks for Automation
During an IR, analysts perform activities to investigate an incident and identify the malicious artifacts on one or more systems. Some tasks may be more challenging than others because they require laborious actions across multiple systems.

﻿

IR often starts by gathering initial information and expanding on what is found to guide further research. This can complicate an automated response because each subsequent task may depend on the findings of a previous task. However, there might be an initial starting point to begin the investigation, such as a suspicious file, process name, or date/time. Automating the investigation using those pieces of information is easier to accomplish because search items are known and can be programmed into the automation script.

﻿

According to the Cybersecurity and Infrastructure Security Agency (CISA) Cybersecurity Incident & Vulnerability Response Playbooks, IR includes four steps:

Preparation
Detection and Analysis
Containment, Eradication, and Recovery
Post-Incident Activity

Activities that make up the second and third steps — Detection and Analysis, and Containment, Eradication, and Recovery — provide opportunities for automation. Expanding IR activities to include multiple systems can complicate implementation of automation.

﻿

Detection and Analysis
﻿

Gathering Information
﻿

One of the first tasks in IR engagements is to gather information and gain situational awareness of the current state of the system. This may mean gathering specific information, such as acquiring a listing of the processes running on the system or performing a full system survey. In either case, information-gathering tasks are typically well suited to automation, especially if no decisions are being calculated based on the information gathered. However, if the goal is to gather information and take additional steps based on what is found, automation may be more difficult.

﻿

Traversing the File System
﻿

A common requirement for IR is to search a file system for files or directories based on specific characteristics, such as timestamps, owners, permissions, or hash values. This task is well suited to automation and can save significant time when compared to manual examination of the file system. However, performance considerations of the types of actions being done on a per-file basis can impact the time required to conduct the activity. For example, searching an entire file system for a specific filename is relatively quick compared with the laborious task of gathering an algorithmic hash value of each file based on the file’s contents.

﻿

Querying Databases
﻿

Analysts may need to access many types of databases during an investigation. On Windows, the Registry is an important source of information. Remote logging systems, such as Kibana or Splunk, may provide information about an event as well. Accessing these information sources can be automated but require the use of the Application Programming Interface (API) used by the remote database system.

﻿

Searching and Parsing Logs
﻿

System log files represent another key source of information. On Windows, that includes the Event Logs and other subsystem log files, such as the firewall logs. On Linux, many different log files exist, depending upon what has been configured on the system, most of which are plaintext log files. Performing searches of these logs can be automated. However, variance in log file formats may necessitate tailoring each automation script to the specific log being accessed. If the log is in binary format, it may not be easily automated without the use of parser utilities.

﻿

Containment, Eradication, and Recovery
﻿

Collecting Artifacts
﻿

The task of collecting, isolating, and hashing artifacts can often be automated. A difficult aspect of automating an artifact collection is making a determination of what should be collected. Once identified, automating actions taken on the artifact is relatively simple. An important consideration when automating the collection is ensuring that the system does not experience such resource issues as low memory or disk space. If the automated tasks blindly perform the activity without regard for resource availability, the target system might run out of resources.

﻿

Configuration Changes
﻿

Automating mitigation and removal of malicious activity is possible, but if the automation script must parse and make decisions on what to change, it may cause undesirable modifications to occur. When it comes to automation, tasks that are highly specific, such as going to a known file and modifying a set value within or removing a particular file, are more easily automated.


--------------------


Create an Incident Response Script in Python
In the following lab, read the scenario. Then complete the workflow steps to create a Python script that reads a text file of hashes and searches specific folders for matches. The script should report any matching hash with its associated filename and path.

﻿

Scenario
﻿

Indications of a user-level rootkit have been detected in various systems across an organization. The rootkit replaces different binaries on Linux systems, and a list of MD5 hashes for known malicious binaries has been collected. Host Analysts conducting IR are instructed to use the list to search systems and determine if any of the binaries are present. The list of file hashes is provided in a text file, with a single hash on each line.

﻿

Workflow
﻿

1. Open the Virtual Machine (VM) lin-hunt-cent. The login credentials are as follows:

Username: trainee
Password: CyberTraining1! 
﻿

2. Navigate to the folder /home/trainee/Desktop/Scripts.

﻿

3. Open the file checkhashes.py in a text editor.

﻿

The script already has modules imported and a function defined called md5(). The function accepts a string parameter containing the full path and name of a file and returns the MD5 hash for the file as a string.

﻿

In the following steps, locations for additional modifications to the script are identified in the script with labels (for example, MOD1, MOD2).

﻿

4. At location MOD1, add the following code to the script to store the command-line arguments: 

hash_list_file = sys.argv[1]
startpath = sys.argv[2]
﻿

The above code uses the imported sys module to quickly access the command-line arguments. The first argument is the filename containing the hashes for the search. The second argument is the path of the starting folder to begin the recursive search. By providing support for command-line options, the script is made more flexible for use in circumstances beyond the task at hand.

﻿

5. At location MOD2, add the following code to read the hash list from the file and store the hashes from it as a list in a variable to be used in subsequent code for hash comparisons:

hash_list = []
with open(hash_list_file) as fd:
    hash_list = fd.read().splitlines()
﻿

The above code creates an empty list variable and opens the hash file provided on the command line. It reads the entire file contents, splitting the contents along individual lines so that each hash from the file is stored as a value in the list.

﻿

The script needs to calculate the MD5 hash of each file examined. This can require significant time, depending on the total number of files. The analyst must consider the performance implications of iterating over many files and reading each one completely to calculate the hash. When deciding between iterating over the list of hashes and comparing those with each file or iterating over the files and comparing with the hashes, the latter option is the most efficient, as each file hash is generated only once.

﻿

6. At location MOD3, add the code to iterate over the files recursively, starting at the top-level folder provided on the command line:

for root, d_names, f_names in os.walk(startpath):
    for f in f_names:
        fname = os.path.join(root, f)
        f_hash = md5(fname)
        if f_hash in hash_list:
            print(f_hash, fname)
﻿

The imported os module provides a function to walk recursively through a directory and its subdirectories. A list of folders and files is retrieved each time through the loop, and the list of files in the directory is used in a loop to iterate through each file, generating its MD5 hash. The code checks whether the hash appears somewhere in the hash_list generated in the previous step. If a match is found, the hash and the filename are printed to the console.

﻿

7. Save all changes to the file.

﻿

A list of hashes to search for is provided in the file /home/trainee/Desktop/Scripts/hash_list.txt.

﻿

8﻿. Right-click in the Scripts directory and click Open in Terminal.

﻿


9. Execute the following scripts:

./checkhashes.py ./hash_list.txt /usr/bin
./checkhashes.py ./hash_list.txt /usr/sbin
﻿

Using the above script, the hash_list.txt file is provided as the first command-line argument, and the folders /usr/bin and /usr/sbin are provided sequentially as the second argument to be used as the starting folder. The top-level / folder could be used a starting point, but the execution time would be long.

﻿

The outputs should show any files in the two folders that have an MD5 hash matching anything listed in the hash_list.txt file. This script now allows a Host Analyst to quickly identify potential malicious files matching the provided list. The added support for command-line arguments can also be used to easily check other folders or use different lists of hashes.

﻿

Using this workflow, respond to the following questions.

﻿

Keep the VM lin-hunt-cent open, as it is used in the next lab


------------------------


Evaluate Incident Response Tasks for Automation
Some IR tasks leverage specialized tools or software, such as imaging of system memory or drives. Other tasks are aimed at gathering and analyzing information from different system resources, such as processes or log files. Similarly, some are better suited for script automation than others.

﻿

In the following lab, consider a scenario in which an analyst is conducting an investigation on a system for which they have had no previous access. Decide which IR tasks should be done manually, without automated assistance, and which are more suitable for automation.

﻿

The VM lin-hunt-cent should still be open from the previous workflow. If it is not open, log in to the VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

Workflow
﻿


1. Launch a terminal window, and run the following command to elevate the privileges to root:

sudo su -
﻿

Using the root shell, the first activity is to investigate reports of an unusual bound Transmission Control Protocol (TCP) port 3600 on the system.

﻿

2. Run the following commands to launch a root-owned shell and find the process that has bound the port:

netstat -natp
PID=$(netstat -natp | grep 3600 | awk '{ print $7 }' | cut -d'/' -f1)
﻿

The identification (ID) number for the process in question is now stored in the environment variable $PID.

﻿

3. View the process details in the process list, navigate to the /proc folder for the process, and discover the exe value to locate the process executable:

ps -ef | grep $PID | grep -v grep
cd /proc/$PID
ls -l exe
﻿

The executable is located in the /tmp/... folder, which is an unusually named hidden folder.

﻿

4. Run the following commands to navigate to the hidden folder and view the folder contents:

cd /tmp/...
ls -l
﻿

The file of interest is an executable named s1eep. (Note the use of the numeral 1 rather than the letter l in the filename.)
﻿

﻿

5. Using the Process Identifier (PID), run the following command to identify any systemd startup configuration files for the process. (The space between the = and $ characters is required.)

ps -o unit= $PID
﻿

The output shows that a systemd service file named display-client.service is associated with the suspicious process.

﻿

6. Show information about the systemd service by running the following command:

systemctl status display-client
﻿

This information can be used to search for other files on the system that may have been modified at the same time. It can also be used to search for account activity during that time.

﻿

7. Run the following command to examine the account logon activity:

last
﻿

The output of the command shows that the account backup logged on at about the same time as the timestamps of the executable file and the service activation.

﻿

Using the above workflow, answer the following questions.

---------------

Automating File System Searches
One of the most common automated tasks performed during an IR investigation involves using known information to perform searches across a file system for similar or related artifacts. The timestamps from known malicious artifacts are often used to find such artifacts. The goal is to use a sufficiently narrow search to return a manageable list of artifacts for further review. A reasonable starting point is to search for all files modified during the same date and within an hour of the known artifact’s modification time. Searching using only the file’s time, or searching for all modified files within the same month, likely returns many matches unrelated to the malicious file


-----------------


Comparing Tasks
During an investigation, some tasks are too complex to reasonably automate without significant time-prohibitive effort. Additionally, tasks that are potentially disruptive to the system, especially in ways that inhibit or disrupt the investigative process, should not typically be automated. As previously discussed, searching across a file system using known information is a good case for automation. However, automating a task that terminates processes without careful review should be avoided. Furthermore, scripts written for automation should avoid requiring repeated manual interaction from the user.



---------------------





















